<!doctype html>
<html lang="en" class="min-h-full">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="../favicon.svg" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link href="../_app/immutable/assets/0.DJzTHClV.css" rel="stylesheet">
		<link href="../_app/immutable/assets/NoteGridStatusFilter.XVDl0Kvs.css" rel="stylesheet">
		<link href="../_app/immutable/assets/MDSveXNoteLayout.CyYI4j1f.css" rel="stylesheet">
		<link href="../_app/immutable/assets/3.CL5GBsTu.css" rel="stylesheet">
		<link rel="modulepreload" href="../_app/immutable/entry/start.CpQz3iB1.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DRL2qW2k.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/1HLFgmCb.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/_9pnLWT9.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/D9oPQppQ.js">
		<link rel="modulepreload" href="../_app/immutable/entry/app.B0u9XG_K.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/C1FmrZbK.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BJAtj1_n.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CHUXHOPN.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/W8aj68s9.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DHsDDbHh.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/QqLkXUPV.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/B-eN9XNX.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/C6iUor_U.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/AsWAPDv1.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/1IPPVSMY.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/0.DgRsp5C8.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Dn6m01Wt.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DZxdjYg5.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CVM844WK.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DNxLwEpJ.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BlGy7pGB.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/-X8ACxro.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Ck6BX3gD.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/C932wzq6.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/3.CNADZyk3.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/aCt_8dWO.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BoY8E5NL.js"><!--[--><meta name="description" content="Applying my skills in performance optimization in a new domain: terminal (zsh) startup speed." class="svelte-de2ged"> <meta property="og:title" content="Improving zsh startup times" class="svelte-de2ged"> <meta property="og:type" content="article" class="svelte-de2ged"> <meta property="og:url" content="https://allandeutsch.com/notes/zsh-startup" class="svelte-de2ged"> <meta property="og:description" content="Applying my skills in performance optimization in a new domain: terminal (zsh) startup speed." class="svelte-de2ged"> <meta property="og:locale" content="en_US" class="svelte-de2ged"> <meta property="twitter:card" content="summary" class="svelte-de2ged"> <meta property="twitter:url" content="https://allandeutsch.com" class="svelte-de2ged"> <meta property="twitter:title" content="Improving zsh startup times" class="svelte-de2ged"> <meta property="twitter:description" content="Applying my skills in performance optimization in a new domain: terminal (zsh) startup speed." class="svelte-de2ged"> <meta property="twitter:site" content="@AllanDeutsch" class="svelte-de2ged"> <meta property="twitter:creator" content="@AllanDeutsch" class="svelte-de2ged"> <link rel="canonical" href="https://allandeutsch.com/notes/zsh-startup" class="svelte-de2ged"> <script type="module" src="https://docduck.dev/selection.js" class="svelte-de2ged"></script> <script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="AllanDeutsch" data-description="Support me on Buy me a coffee!" data-message="" data-color="#5F7FFF" data-position="Right" data-x_margin="18" data-y_margin="18" class="svelte-de2ged"></script><!--]--><!--[--><!--[--><meta name="theme-color" content="dark"><!--]--> <!----><script>(function setInitialMode({ defaultMode = "system", themeColors: themeColors2, darkClassNames: darkClassNames2 = ["dark"], lightClassNames: lightClassNames2 = [], defaultTheme = "", modeStorageKey: modeStorageKey2 = "mode-watcher-mode", themeStorageKey: themeStorageKey2 = "mode-watcher-theme" }) {
  const rootEl = document.documentElement;
  const mode = localStorage.getItem(modeStorageKey2) || defaultMode;
  const theme2 = localStorage.getItem(themeStorageKey2) || defaultTheme;
  const light = mode === "light" || mode === "system" && window.matchMedia("(prefers-color-scheme: light)").matches;
  if (light) {
    if (darkClassNames2.length)
      rootEl.classList.remove(...darkClassNames2);
    if (lightClassNames2.length)
      rootEl.classList.add(...lightClassNames2);
  } else {
    if (lightClassNames2.length)
      rootEl.classList.remove(...lightClassNames2);
    if (darkClassNames2.length)
      rootEl.classList.add(...darkClassNames2);
  }
  rootEl.style.colorScheme = light ? "light" : "dark";
  if (themeColors2) {
    const themeMetaEl = document.querySelector('meta[name="theme-color"]');
    if (themeMetaEl) {
      themeMetaEl.setAttribute("content", mode === "light" ? themeColors2.light : themeColors2.dark);
    }
  }
  if (theme2) {
    rootEl.setAttribute("data-theme", theme2);
    localStorage.setItem(themeStorageKey2, theme2);
  }
  localStorage.setItem(modeStorageKey2, mode);
})({"defaultMode":"system","themeColors":{"dark":"dark","light":"light"},"darkClassNames":["dark"],"lightClassNames":[],"defaultTheme":"","modeStorageKey":"mode-watcher-mode","themeStorageKey":"mode-watcher-theme"});</script><!----><!--]--><title>Improving zsh startup times - Allan Deutsch</title>
		<!-- Global site tag (gtag.js) - Google Analytics -->
		<script
			async
			src="https://www.googletagmanager.com/gtag/js?id=UA-86124920-1"></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag() {
				dataLayer.push(arguments);
			}
			gtag('js', new Date());

			gtag('config', 'UA-86124920-1');
		</script>
	</head>
	<body
		data-sveltekit-preload-data="hover"
		data-sveltekit-preload-data="viewport"
		class="h-full min-h-[100vh] bg-base-100">
		<div style="display: contents"><!--[--><!--[--><!----><div class="h-full min-h-[100dvh]"><!--[!--><!--]--><!----> <div class="flex w-full items-center bg-base-100 p-2 print:hidden"><!----><!----><!--[!--><button class="px-4 sm:hidden" id="bits-10" aria-haspopup="menu" aria-expanded="false" data-state="closed" data-dropdown-menu-trigger="" type="button"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h8m-8 6h16"></path></svg> <span class="sr-only">Open navigation menu</span><!----></button><!--]--><!----><!----> <!----><!----><!--[!--><!--]--><!----><!----><!----><!----><!----><!----> <div class="w-1/2 px-4 text-xl font-semibold"><a href="/">Allan Deutsch</a></div> <div class="hidden shrink-0 sm:flex"><ul class="menu menu-horizontal px-1 text-base"><!--[--><!--[!--><li><a href="/">Home</a></li><!--]--><!--[!--><li><a href="/notes">Notes</a></li><!--]--><!--[!--><li><a href="/devlog">Devlog</a></li><!--]--><!--]--></ul></div> <div class="flex w-1/2 justify-end"><!--[!--><div><a href="https://twitter.com/AllanDeutsch" class="group"><span class="sr-only">Follow me on Twitter</span> <svg height="24" width="24" class="mr-1.5 inline fill-base-content transition-colors duration-300 group-hover:fill-primary" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612"><path d="M612 116.258a250.714 250.714 0 01-72.088 19.772c25.929-15.527 45.777-40.155 55.184-69.411-24.322 14.379-51.169 24.82-79.775 30.48-22.907-24.437-55.49-39.658-91.63-39.658-69.334 0-125.551 56.217-125.551 125.513 0 9.828 1.109 19.427 3.251 28.606-104.326-5.24-196.835-55.223-258.75-131.174-10.823 18.51-16.98 40.078-16.98 63.101 0 43.559 22.181 81.993 55.835 104.479a125.556 125.556 0 01-56.867-15.756v1.568c0 60.806 43.291 111.554 100.693 123.104-10.517 2.83-21.607 4.398-33.08 4.398-8.107 0-15.947-.803-23.634-2.333 15.985 49.907 62.336 86.199 117.253 87.194-42.947 33.654-97.099 53.655-155.916 53.655-10.134 0-20.116-.612-29.944-1.721 55.567 35.681 121.536 56.485 192.438 56.485 230.948 0 357.188-191.291 357.188-357.188l-.421-16.253c24.666-17.593 46.005-39.697 62.794-64.861z"></path></svg></a> <a href="https://github.com/masstronaut" class="group"><span class="sr-only">Follow me on GitHub</span> <svg height="24" aria-hidden="true" viewBox="0 0 16 16" version="1.1" width="24" data-view-component="true" class="mr-1.5 inline fill-base-content transition-colors duration-300 group-hover:fill-primary"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg></a></div><!--]--></div></div><!----> <div class="h-full p-1 sm:p-4"><!----><docduck-feedback team="TKxfdiO22xOXIrW0c0Pfi" class="svelte-de2ged"></docduck-feedback> <div class="grid w-full grid-cols-[1fr_min(65ch,100%)_1fr] svelte-de2ged"><h1 class="col-start-2 col-end-3 text-left text-4xl font-bold svelte-de2ged" style="view-transition-name: title">Improving zsh startup times</h1></div> <article class="note-container prose mb-8 max-w-full px-2 svelte-de2ged" style="view-transition-name: article;"><header class="w-full max-w-3xl self-center svelte-de2ged"><div class="text-md border-t-neutral/20 text-base-content mt-4 mb-12 flex justify-between border-t pt-1 svelte-de2ged"><div class="svelte-de2ged"><span class="pr-2 svelte-de2ged">🌱</span><span class="hidden sm:inline svelte-de2ged">Planted</span>January 31, 2025. <!--[--><br class="svelte-de2ged">Last tended February 2, 2025.<!--]--></div> <div class="flex flex-col items-end svelte-de2ged"><div class="note__status budding svelte-de2ged">budding 🌿</div> <!--[--><div class="svelte-de2ged">13 minutes read ⏱</div><!--]--></div></div></header> <!----><p>I found an excellent article by Scott Spence on <a href="https://scottspence.com/posts/speeding-up-my-zsh-shell" rel="nofollow">Speeding up my zsh shell</a>. I’ve been spending a lot more time in the terminal since <a href="/notes/use-neovim">switching to neovim</a> last Summer, and thought it was a good opportunity to improve my own zsh startup times.</p> <h2 id="profiling-zsh-startup"><a aria-hidden="true" tabindex="-1" href="#profiling-zsh-startup"><span class="icon icon-link"></span></a><a href="#profiling-zsh-startup" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Profiling zsh startup</h2> <p>To get started with any performance-related work, the first step is to do some profiling. Profiling is what tells me how long everything is taking, and whether optimizing a game engine, a frontend application, or a terminal emulator startup, profiling is <em>always</em> the first step!</p> <h3 id="establish-a-baseline-startup-time"><a aria-hidden="true" tabindex="-1" href="#establish-a-baseline-startup-time"><span class="icon icon-link"></span></a><a href="#establish-a-baseline-startup-time" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Establish a baseline startup time</h3> <p>It’s important to understand the <em>actual</em> time something takes. That makes it possible to understand when it is fast enough. “Fast enough” depends on the context. For my zsh startup, I’ll be happy with a time around 0.5-0.25 seconds.</p> <p>There’s often performance variability from one run to the next due to a variety of factors outside the actual code being profiled. Think of scenarios like the serverless cold start problem, running code that is vs isn’t in CPU cache, or starting an application from disk vs already loaded in memory. To get a better idea of how long something takes on average, it’s typical to run it multiple times to get a range of execution times and identify an average. I do this for zsh startup times with the following command:</p> <!----><pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code><span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">for</span><span style="color:#B07D48;--shiki-dark:#BD976A"> i</span><span style="color:#1E754F;--shiki-dark:#4D9375"> in</span><span style="color:#999999;--shiki-dark:#666666"> $(</span><span style="color:#59873A;--shiki-dark:#80A665">seq</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 10</span><span style="color:#999999;--shiki-dark:#666666">);</span><span style="color:#1E754F;--shiki-dark:#4D9375"> do</span><span style="color:#59873A;--shiki-dark:#80A665"> /usr/bin/time</span><span style="color:#B56959;--shiki-dark:#C98A7D"> zsh</span><span style="color:#A65E2B;--shiki-dark:#C99076"> -i</span><span style="color:#A65E2B;--shiki-dark:#C99076"> -c</span><span style="color:#B56959;--shiki-dark:#C98A7D"> exit</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#1E754F;--shiki-dark:#4D9375"> done</span></span></code></pre><!----><!----><pre class="code-copy-target hidden">for i in $(seq 1 10); do /usr/bin/time zsh -i -c exit; done</pre><!----> <p>Briefly what’s going on here is:</p> <ul><li><code>for i in ...</code> is a for loop that runs once for each value in a list, with <code>i</code> set to the current list item’s value</li> <li><code>$(seq 1 10)</code> uses the <code>seq</code> command to generate a list of numbers from 1-10 and captures the list as a value to be used by <code>for</code></li> <li><code>time</code> is a utility that times how long a command took to execute</li> <li><code>zsh -i</code> starts an interactive zsh session, ie one that can run commands</li> <li><code>-c</code> tells <code>zsh</code> to run the next argument (<code>exit</code>) as a command, rather than treating it as parameter to the current command</li></ul> <p>When I run this, I got a range from ~1.05-1.1 seconds:</p> <!----><pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code><span class="line"><span>1.06 real         0.56 user         0.46 sys</span></span></code></pre><!----><!----><pre class="code-copy-target hidden">1.06 real         0.56 user         0.46 sys</pre><!----> <p>So I’ll need to shave off a bit more than 50% to get to the top end of my acceptable time of 0.5s. With that in mind, it’s go time!</p> <h3 id="detailed-profiling"><a aria-hidden="true" tabindex="-1" href="#detailed-profiling"><span class="icon icon-link"></span></a><a href="#detailed-profiling" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>detailed profiling</h3> <p>Simply knowing how long my <code>zsh</code> startup takes and how fast I want it to be is insufficient. To know what needs optimizing, it’s important to <strong>profile the code</strong>. Profiling produces a detailed breakdown of how long each piece takes. Most technology stacks have some sort of performance profiling tool available for this reason.</p> <p>Zsh comes with a profiler, and it’s pretty easy to use. Crack open <code>.zshrc</code> and add two commands:</p> <!----><pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0" sh filename=".zshrc"><code><span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD"># Start the profiler at the top of the .zshrc</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">zmodload</span><span style="color:#B56959;--shiki-dark:#C98A7D"> zsh/zprof</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD"># all of my existing config in the middle....</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD"># ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD"># Finish the profiler and print the results</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">zprof</span></span></code></pre><!----><!----><pre class="code-copy-target hidden"># Start the profiler at the top of the .zshrc
zmodload zsh/zprof

# all of my existing config in the middle....
# ...

# Finish the profiler and print the results
zprof</pre><!----> <p>Save the file and start up a new zsh session (I do this by opening a new tab in WezTerm). After a slight delay, I see a printout of how long everything took:</p> <!----><pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code><span class="line"><span>num  calls                time                       self            name</span></span>
<span class="line"><span>-----------------------------------------------------------------------------------</span></span>
<span class="line"><span> 1)    1         544.25   544.25   87.38%    263.45   263.45   42.30%  nvm_auto</span></span>
<span class="line"><span> 2)    2         254.65   127.32   40.89%    142.52    71.26   22.88%  nvm</span></span>
<span class="line"><span> 3)    1          88.13    88.13   14.15%     74.74    74.74   12.00%  nvm_ensure_version_installed</span></span>
<span class="line"><span> 4)    2          46.76    23.38    7.51%     46.76    23.38    7.51%  compaudit</span></span>
<span class="line"><span> 5)    1          22.84    22.84    3.67%     17.54    17.54    2.82%  nvm_die_on_prefix</span></span>
<span class="line"><span> 6)    1          61.34    61.34    9.85%     14.58    14.58    2.34%  compinit</span></span>
<span class="line"><span> 7)    1          13.39    13.39    2.15%     13.39    13.39    2.15%  nvm_is_version_installed</span></span>
<span class="line"><span> 8)    1          26.15    26.15    4.20%     11.59    11.59    1.86%  nvm_is_valid_version</span></span>
<span class="line"><span> 9)    1          12.21    12.21    1.96%      8.64     8.64    1.39%  nvm_validate_implicit_alias</span></span>
<span class="line"><span>10)    1           7.36     7.36    1.18%      7.28     7.28    1.17%  _zsh_highlight_load_highlighters</span></span>
<span class="line"><span>...</span></span></code></pre><!----><!----><pre class="code-copy-target hidden">num  calls                time                       self            name
-----------------------------------------------------------------------------------
 1)    1         544.25   544.25   87.38%    263.45   263.45   42.30%  nvm_auto
 2)    2         254.65   127.32   40.89%    142.52    71.26   22.88%  nvm
 3)    1          88.13    88.13   14.15%     74.74    74.74   12.00%  nvm_ensure_version_installed
 4)    2          46.76    23.38    7.51%     46.76    23.38    7.51%  compaudit
 5)    1          22.84    22.84    3.67%     17.54    17.54    2.82%  nvm_die_on_prefix
 6)    1          61.34    61.34    9.85%     14.58    14.58    2.34%  compinit
 7)    1          13.39    13.39    2.15%     13.39    13.39    2.15%  nvm_is_version_installed
 8)    1          26.15    26.15    4.20%     11.59    11.59    1.86%  nvm_is_valid_version
 9)    1          12.21    12.21    1.96%      8.64     8.64    1.39%  nvm_validate_implicit_alias
10)    1           7.36     7.36    1.18%      7.28     7.28    1.17%  _zsh_highlight_load_highlighters
...</pre><!----> <p>Note: I’ve truncated this list to exclude anything taking less than 1% of startup time, denoted by the <code>...</code></p> <p>This gives me a fairly detailed list of how long each item takes to run, sorted from the slowest to the fastest. This is great, because the slowest bits for me were at the bottom of my <code>.zshrc</code>. If I’d optimized that file from top to bottom I would’ve done a ton of work with no impact!</p> <h2 id="optimize-the-slowest-stuff-first"><a aria-hidden="true" tabindex="-1" href="#optimize-the-slowest-stuff-first"><span class="icon icon-link"></span></a><a href="#optimize-the-slowest-stuff-first" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Optimize the slowest stuff first</h2> <p>There’s one obvious culprit behind my zsh startup times. Over 75% of the time is spent on various <code>nvm</code> tasks. Most of the time I am not even using <code>nvm</code>!</p> <p>This is great news since I only need a ~50% speed up to hit my performance target. I might be able to get away with an easy win and be done!</p> <h3 id="identify-the-slowest-code"><a aria-hidden="true" tabindex="-1" href="#identify-the-slowest-code"><span class="icon icon-link"></span></a><a href="#identify-the-slowest-code" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Identify the slowest code</h3> <p>Here’s the offending <code>nvm</code> bits from near the bottom of my <code>.zshrc</code>:</p> <!----><pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0" sh filename=".zshrc"><code><span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">export</span><span style="color:#B07D48;--shiki-dark:#BD976A"> NVM_DIR</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">$HOME/.nvm</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#AB5959;--shiki-dark:#CB7676"> -s</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">$NVM_DIR/nvm.sh</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666"> ]</span><span style="color:#999999;--shiki-dark:#666666"> &#x26;&#x26;</span><span style="color:#59873A;--shiki-dark:#80A665"> .</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">$NVM_DIR/nvm.sh</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#A0ADA0;--shiki-dark:#758575DD">  # This loads nvm</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#AB5959;--shiki-dark:#CB7676"> -s</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">$NVM_DIR/bash_completion</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#999999;--shiki-dark:#666666"> ]</span><span style="color:#999999;--shiki-dark:#666666"> &#x26;&#x26;</span><span style="color:#59873A;--shiki-dark:#80A665"> .</span><span style="color:#B5695977;--shiki-dark:#C98A7D77"> "</span><span style="color:#B56959;--shiki-dark:#C98A7D">$NVM_DIR/bash_completion</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#A0ADA0;--shiki-dark:#758575DD">  # This loads nvm bash_completion</span></span></code></pre><!----><!----><pre class="code-copy-target hidden">export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"  # This loads nvm
[ -s "$NVM_DIR/bash_completion" ] && . "$NVM_DIR/bash_completion"  # This loads nvm bash_completion</pre><!----> <p>I tried commenting out the line for completions and all the slowest bits were still there according to <code>zprof</code>, so it’s definitely loading <code>nvm</code> that’s slow. Commenting out the <code>nvm</code> loading code gets me down to ~0.55s startup time, so this is definitely a great place to start.</p> <p>I don’t use <code>nvm</code> much, which means two things to me:</p> <ol><li>it I’m okay with it starting slower instead of paying the load times on every shell startup. That makes it a perfect candidate for lazy loading!</li> <li>I’m not very familiar with its config or if it has built-in support for lazy-loading.</li></ol> <p>If it does, great! If it doesn’t, I’m going to have to DIY a solution. A quick search led me to Armno Prommarak’s article, aptly titled <a href="https://armno.in.th/blog/zsh-startup-time/" rel="nofollow">Lazy-load nvm to Reduce ZSH’s Startup Time</a>. Perfect! That’s exactly what I’m trying to do.</p> <h3 id="lazy-loading-nvm-to-improve-zsh-startup-performance"><a aria-hidden="true" tabindex="-1" href="#lazy-loading-nvm-to-improve-zsh-startup-performance"><span class="icon icon-link"></span></a><a href="#lazy-loading-nvm-to-improve-zsh-startup-performance" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>lazy-loading nvm to improve zsh startup performance</h3> <p>It seems that <code>nvm</code> doesn’t have lazy loading out of the box. Fortunately, there’s <a href="https://github.com/lukechilds/zsh-nvm" rel="nofollow">a zsh plugin that wraps nvm</a> with some extra features, including lazy loading!</p> <p>The obvious move here is to install the plugin, set it up, and be done. I <em>really</em> dislike repetitive and tedious tasks, and manually reinstalling dependencies is very boring for me. So instead, I’m going to set up my <code>.zshrc</code> to check if <code>zsh-nvm</code> is installed (very fast) and if it isn’t, install it. That way when I clone <a href="https://github.com/Masstronaut/dotfiles" rel="nofollow">my dotfiles repo</a> on another machine in the future, it’ll automatically install <code>zsh-nvm</code> for me with no effort on my part. The way I’m going to do this is:</p> <ol><li>Check if <code>zsh-nvm</code> is installed <ol><li>if it’s not installed, install it via git</li></ol></li> <li>Set it to lazy-load <code>nvm</code></li> <li><code>source</code> the plugin code</li></ol> <p>Here’s what that looks like in code:</p> <!----><pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0" sh filename=".zshrc"><code><span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD"># Install zsh-nvm if it's not already installed</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">if</span><span style="color:#999999;--shiki-dark:#666666"> [[</span><span style="color:#AB5959;--shiki-dark:#CB7676"> !</span><span style="color:#AB5959;--shiki-dark:#CB7676"> -f</span><span style="color:#AB5959;--shiki-dark:#CB7676"> ~</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">/.zsh_plugins/zsh-nvm/zsh-nvm.plugin.zsh </span><span style="color:#999999;--shiki-dark:#666666">]];</span><span style="color:#1E754F;--shiki-dark:#4D9375"> then</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">	git</span><span style="color:#B56959;--shiki-dark:#C98A7D"> clone</span><span style="color:#B56959;--shiki-dark:#C98A7D"> https://github.com/lukechilds/zsh-nvm.git</span><span style="color:#B56959;--shiki-dark:#C98A7D"> ~/.zsh_plugins/zsh-nvm</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD"># Set the nvm</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">export</span><span style="color:#B07D48;--shiki-dark:#BD976A"> NVM_DIR</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span><span style="color:#B56959;--shiki-dark:#C98A7D">$HOME/.nvm</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD"># Tell zsh-nvm to lazy-load nvm</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">export</span><span style="color:#B07D48;--shiki-dark:#BD976A"> NVM_LAZY_LOAD</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#B07D48;--shiki-dark:#BD976A">true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD"># also load nvm when launching nvim</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD"># Some web dev tooling depends on node</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">export</span><span style="color:#B07D48;--shiki-dark:#BD976A"> NVM_LAZY_LOAD_EXTRA_COMMANDS</span><span style="color:#999999;--shiki-dark:#666666">=(</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">'</span><span style="color:#B56959;--shiki-dark:#C98A7D">nvim</span><span style="color:#B5695977;--shiki-dark:#C98A7D77">'</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD"># Tell zsh-nvm plugin to load nvm's bash completions</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">export</span><span style="color:#B07D48;--shiki-dark:#BD976A"> NVM_COMPLETION</span><span style="color:#999999;--shiki-dark:#666666">=</span><span style="color:#B07D48;--shiki-dark:#BD976A">true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD"># Load zsh-nvm</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">source</span><span style="color:#B56959;--shiki-dark:#C98A7D"> ~/.zsh_plugins/zsh-nvm/zsh-nvm.plugin.zsh</span></span></code></pre><!----><!----><pre class="code-copy-target hidden"># Install zsh-nvm if it's not already installed
if [[ ! -f ~/.zsh_plugins/zsh-nvm/zsh-nvm.plugin.zsh ]]; then
	git clone https://github.com/lukechilds/zsh-nvm.git ~/.zsh_plugins/zsh-nvm
fi

# Set the nvm
export NVM_DIR="$HOME/.nvm"

# Tell zsh-nvm to lazy-load nvm
export NVM_LAZY_LOAD=true

# also load nvm when launching nvim
# Some web dev tooling depends on node
export NVM_LAZY_LOAD_EXTRA_COMMANDS=('nvim')

# Tell zsh-nvm plugin to load nvm's bash completions
export NVM_COMPLETION=true

# Load zsh-nvm
source ~/.zsh_plugins/zsh-nvm/zsh-nvm.plugin.zsh</pre><!----> <p>After a single .99s cold start, my remaining startups were ~.65s with this one change. Awesome! Shoutout to Luke Childs for making this great nvm plugin.</p> <p>Taking a look with <code>zprof</code> on, I get the following as my 3 slowest zsh startup steps:</p> <!----><pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code><span class="line"><span>num  calls                time                       self            name</span></span>
<span class="line"><span>-----------------------------------------------------------------------------------</span></span>
<span class="line"><span> 1)    1         372.07   372.07   89.50%    124.22   124.22   29.88%  compinit</span></span>
<span class="line"><span> 2)    1         115.43   115.43   27.76%    115.43   115.43   27.76%  compdump</span></span>
<span class="line"><span> 3)  811         107.50     0.13   25.86%    107.50     0.13   25.86%  compdef</span></span></code></pre><!----><!----><pre class="code-copy-target hidden">num  calls                time                       self            name
-----------------------------------------------------------------------------------
 1)    1         372.07   372.07   89.50%    124.22   124.22   29.88%  compinit
 2)    1         115.43   115.43   27.76%    115.43   115.43   27.76%  compdump
 3)  811         107.50     0.13   25.86%    107.50     0.13   25.86%  compdef</pre><!----> <p>Those are related to the completion system in zsh, so it looks like that’s up next!</p> <h2 id="speeding-up-zsh-completion-system-loading"><a aria-hidden="true" tabindex="-1" href="#speeding-up-zsh-completion-system-loading"><span class="icon icon-link"></span></a><a href="#speeding-up-zsh-completion-system-loading" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Speeding up zsh completion system loading</h2> <p>Unlike with <code>nvm</code>, I’m always using commands when I open a new shell. Completions help me write commands faster and with better accuracy. I definitely want them every time I open my shell, so I can’t get away with lazy loading this time.</p> <p>Fortunately for me, Scott Spence also called out slow completion startups in their <a href="https://scottspence.com/posts/speeding-up-my-zsh-shell#fixing-the-completion-system-3076--10" rel="nofollow">zsh startup times blog post</a>. It was a quick fix too! The change is to only rebuild the completions cache if it doesn’t exist or is over 24h old, based on <a href="https://gist.github.com/ctechols/ca1035271ad134841284" rel="nofollow">this github gist</a>:</p> <!----><pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0" zsh filename=".zshrc"><code><span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD"># On slow systems, checking the cached .zcompdump file to see if it must be </span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD"># regenerated adds a noticable delay to zsh startup.  This little hack restricts </span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD"># it to once a day.  It should be pasted into your own completion file.</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">#</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD"># The globbing is a little complicated here:</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD"># - '#q' is an explicit glob qualifier that makes globbing work within zsh's [[ ]] construct.</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD"># - 'N' makes the glob pattern evaluate to nothing when it doesn't match (rather than throw a globbing error)</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD"># - '.' matches "regular files"</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD"># - 'mh+24' matches files (or directories or whatever) that are older than 24 hours.</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">autoload</span><span style="color:#A65E2B;--shiki-dark:#C99076"> -Uz</span><span style="color:#B56959;--shiki-dark:#C98A7D"> compinit</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> </span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">if</span><span style="color:#999999;--shiki-dark:#666666"> [[</span><span style="color:#AB5959;--shiki-dark:#CB7676"> -n</span><span style="color:#AB5959;--shiki-dark:#CB7676"> ~</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">/.zcompdump</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">#</span><span style="color:#B07D48;--shiki-dark:#BD976A">qN</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">mh</span><span style="color:#AB5959;--shiki-dark:#CB7676">+</span><span style="color:#2F798A;--shiki-dark:#4C9A91">24</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#999999;--shiki-dark:#666666"> ]];</span><span style="color:#1E754F;--shiki-dark:#4D9375"> then</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">	compinit</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">else</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">	compinit</span><span style="color:#A65E2B;--shiki-dark:#C99076"> -C</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">fi</span><span style="color:#999999;--shiki-dark:#666666">;</span></span></code></pre><!----><!----><pre class="code-copy-target hidden"># On slow systems, checking the cached .zcompdump file to see if it must be 
# regenerated adds a noticable delay to zsh startup.  This little hack restricts 
# it to once a day.  It should be pasted into your own completion file.
#
# The globbing is a little complicated here:
# - '#q' is an explicit glob qualifier that makes globbing work within zsh's [[ ]] construct.
# - 'N' makes the glob pattern evaluate to nothing when it doesn't match (rather than throw a globbing error)
# - '.' matches "regular files"
# - 'mh+24' matches files (or directories or whatever) that are older than 24 hours.
autoload -Uz compinit 
if [[ -n ~/.zcompdump(#qN.mh+24) ]]; then
	compinit;
else
	compinit -C;
fi;</pre><!----> <p>I found that this made almost 0 impact on my zsh startup time, so for me it’s probably not worth the added config complexity and the disabled security check.</p> <h2 id="hidden-in-plain-sight"><a aria-hidden="true" tabindex="-1" href="#hidden-in-plain-sight"><span class="icon icon-link"></span></a><a href="#hidden-in-plain-sight" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Hidden in plain sight</h2> <p>I noticed a major omission from my <code>zprof</code> output - neofetch! Neofetch is a mostly useless tool; it prints out a pretty display with ASCII art of the OS logo and some system info. I have it run at the end of my <code>.zshrc</code>, and so its absence in <code>zprof</code> is peculiar. I’m not sure why it’s not in <code>zprof</code>, but was able to time it directly:</p> <!----><pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code><span class="line"><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">time /opt/homebrew/bin/neofetch</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#59873A;--shiki-dark:#80A665"> 2</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">></span><span style="color:#999999;--shiki-dark:#666666">&#x26;</span><span style="color:#59873A;--shiki-dark:#80A665">1</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">/opt/homebrew/bin/neofetch</span><span style="color:#B56959;--shiki-dark:#C98A7D">  0.28s</span><span style="color:#B56959;--shiki-dark:#C98A7D"> user</span><span style="color:#B56959;--shiki-dark:#C98A7D"> 0.26s</span><span style="color:#B56959;--shiki-dark:#C98A7D"> system</span><span style="color:#B56959;--shiki-dark:#C98A7D"> 86%</span><span style="color:#B56959;--shiki-dark:#C98A7D"> cpu</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 0.626</span><span style="color:#B56959;--shiki-dark:#C98A7D"> total</span></span></code></pre><!----><!----><pre class="code-copy-target hidden">(time /opt/homebrew/bin/neofetch) 2&gt;&1
/opt/homebrew/bin/neofetch  0.28s user 0.26s system 86% cpu 0.626 total</pre><!----> <p>That is a substantial chunk of my ~.65s startup time. I went to check the <a href="https://github.com/dylanaraps/neofetch" rel="nofollow">neofetch repo</a> for any discussion about improving performance, and found the project has been archived. 😱</p> <p>Apparently the last release was in 2020! While it still works, I prefer not to run unmaintained software. The biggest reason is that unmaintained software likely still has vulnerabilities. If they are discovered and exploited, no software update will be released to fix it.</p> <p>Fortunately there are some maintained forks of neofetch! I found <a href="https://github.com/fastfetch-cli/fastfetch" rel="nofollow">fastfetch</a>, which is one written in C that has a focus on performance. I gave it a go with the following:</p> <!----><pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code><span class="line"><span style="color:#59873A;--shiki-dark:#80A665">brew</span><span style="color:#B56959;--shiki-dark:#C98A7D"> install</span><span style="color:#B56959;--shiki-dark:#C98A7D"> fastfetch</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">fastfetch</span></span></code></pre><!----><!----><pre class="code-copy-target hidden">brew install fastfetch
fastfetch</pre><!----> <p>It grabs a bunch more data than my neofetch config does, and is configured via <code>jsonc</code>.  Importantly, it runs quite a bit faster:</p> <!----><pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code><span class="line"><span>(time /opt/homebrew/bin/neofetch) 2>&#x26;1</span></span>
<span class="line"><span>                    ..'          allan@Allans-MacBook-Pro</span></span>
<span class="line"><span>                 ,xNMM.           ------------------------</span></span>
<span class="line"><span>               .OMMMMo            OS: macOS Sequoia 15.2 arm64</span></span>
<span class="line"><span>               lMM"               Host: MacBook Pro (13-inch, M1, 2020)</span></span>
<span class="line"><span>     .;loddo:.  .olloddol;.       Kernel: Darwin 24.2.0</span></span>
<span class="line"><span>   cKMMMMMMMMMMNWMMMMMMMMMM0:     Uptime: 47 days, 5 hours, 22 mins</span></span>
<span class="line"><span> .KMMMMMMMMMMMMMMMMMMMMMMMWd.     Packages: 173 (brew), 11 (brew-cask)</span></span>
<span class="line"><span> XMMMMMMMMMMMMMMMMMMMMMMMX.       Shell: zsh 5.9</span></span>
<span class="line"><span>;MMMMMMMMMMMMMMMMMMMMMMMM:        Display (Color LCD): 1920x1200 @ 60 Hz in 13" [Built-in]</span></span>
<span class="line"><span>:MMMMMMMMMMMMMMMMMMMMMMMM:        DE: Aqua</span></span>
<span class="line"><span>.MMMMMMMMMMMMMMMMMMMMMMMMX.       WM: Quartz Compositor 278.2.7</span></span>
<span class="line"><span> kMMMMMMMMMMMMMMMMMMMMMMMMWd.     WM Theme: Pink (Dark)</span></span>
<span class="line"><span> 'XMMMMMMMMMMMMMMMMMMMMMMMMMMk    Font: .AppleSystemUIFont [System], Helvetica [User]</span></span>
<span class="line"><span>  'XMMMMMMMMMMMMMMMMMMMMMMMMK.    Cursor: Fill - Black, Outline - White (32px)</span></span>
<span class="line"><span>    kMMMMMMMMMMMMMMMMMMMMMMd      Terminal: WezTerm 20240203-110809-5046fc22</span></span>
<span class="line"><span>     ;KMMMMMMMWXXWMMMMMMMk.       Terminal Font: Hack Nerd Font</span></span>
<span class="line"><span>       "cooc*"    "*coo'"         CPU: Apple M1 (8) @ 3.20 GHz</span></span>
<span class="line"><span>                                  GPU: Apple M1 (8) [Integrated]</span></span>
<span class="line"><span>                                  Memory: 12.48 GiB / 16.00 GiB (78%)</span></span>
<span class="line"><span>                                  Swap: 5.51 GiB / 7.00 GiB (79%)</span></span>
<span class="line"><span>                                  Disk (/): 612.69 GiB / 926.35 GiB (66%) - apfs [Read-only]</span></span>
<span class="line"><span>                                  Local IP (en0): ***.***.***.***</span></span>
<span class="line"><span>                                  Battery (bq20z451): 100% (13 hours, 13 mins remaining) [Discharging]</span></span>
<span class="line"><span>                                  Locale: en_US.UTF-8</span></span>
<span class="line"><span>/opt/homebrew/bin/fastfetch  0.09s user 0.07s system 49% cpu 0.325 total</span></span></code></pre><!----><!----><pre class="code-copy-target hidden">(time /opt/homebrew/bin/neofetch) 2&gt;&1
                    ..'          allan@Allans-MacBook-Pro
                 ,xNMM.           ------------------------
               .OMMMMo            OS: macOS Sequoia 15.2 arm64
               lMM"               Host: MacBook Pro (13-inch, M1, 2020)
     .;loddo:.  .olloddol;.       Kernel: Darwin 24.2.0
   cKMMMMMMMMMMNWMMMMMMMMMM0:     Uptime: 47 days, 5 hours, 22 mins
 .KMMMMMMMMMMMMMMMMMMMMMMMWd.     Packages: 173 (brew), 11 (brew-cask)
 XMMMMMMMMMMMMMMMMMMMMMMMX.       Shell: zsh 5.9
;MMMMMMMMMMMMMMMMMMMMMMMM:        Display (Color LCD): 1920x1200 @ 60 Hz in 13" [Built-in]
:MMMMMMMMMMMMMMMMMMMMMMMM:        DE: Aqua
.MMMMMMMMMMMMMMMMMMMMMMMMX.       WM: Quartz Compositor 278.2.7
 kMMMMMMMMMMMMMMMMMMMMMMMMWd.     WM Theme: Pink (Dark)
 'XMMMMMMMMMMMMMMMMMMMMMMMMMMk    Font: .AppleSystemUIFont [System], Helvetica [User]
  'XMMMMMMMMMMMMMMMMMMMMMMMMK.    Cursor: Fill - Black, Outline - White (32px)
    kMMMMMMMMMMMMMMMMMMMMMMd      Terminal: WezTerm 20240203-110809-5046fc22
     ;KMMMMMMMWXXWMMMMMMMk.       Terminal Font: Hack Nerd Font
       "cooc*"    "*coo'"         CPU: Apple M1 (8) @ 3.20 GHz
                                  GPU: Apple M1 (8) [Integrated]
                                  Memory: 12.48 GiB / 16.00 GiB (78%)
                                  Swap: 5.51 GiB / 7.00 GiB (79%)
                                  Disk (/): 612.69 GiB / 926.35 GiB (66%) - apfs [Read-only]
                                  Local IP (en0): ***.***.***.***
                                  Battery (bq20z451): 100% (13 hours, 13 mins remaining) [Discharging]
                                  Locale: en_US.UTF-8
/opt/homebrew/bin/fastfetch  0.09s user 0.07s system 49% cpu 0.325 total</pre><!----> <p>That’s 3x faster than neofetch, and it’s grabbing more system info. With a bit of config tweaking, I’m sure I can get that down a little further. Strangely, after swapping it with <code>neofetch</code> in my <code>.zshrc</code>, <code>zprof</code> doesn’t show fastfetch as a line item either. If you know why these aren’t covered in zprof please let me know!</p> <p>Anyway I tried timing my zsh startups again and got great results:</p> <!----><pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code><span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">for</span><span style="color:#B07D48;--shiki-dark:#BD976A"> i</span><span style="color:#1E754F;--shiki-dark:#4D9375"> in</span><span style="color:#999999;--shiki-dark:#666666"> $(</span><span style="color:#59873A;--shiki-dark:#80A665">seq</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 1</span><span style="color:#2F798A;--shiki-dark:#4C9A91"> 10</span><span style="color:#999999;--shiki-dark:#666666">);</span><span style="color:#1E754F;--shiki-dark:#4D9375"> do</span><span style="color:#59873A;--shiki-dark:#80A665"> /usr/bin/time</span><span style="color:#B56959;--shiki-dark:#C98A7D"> zsh</span><span style="color:#A65E2B;--shiki-dark:#C99076"> -i</span><span style="color:#A65E2B;--shiki-dark:#C99076"> -c</span><span style="color:#B56959;--shiki-dark:#C98A7D"> exit</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#1E754F;--shiki-dark:#4D9375"> done</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">0.45</span><span style="color:#B56959;--shiki-dark:#C98A7D"> real</span><span style="color:#2F798A;--shiki-dark:#4C9A91">         0.25</span><span style="color:#B56959;--shiki-dark:#C98A7D"> user</span><span style="color:#2F798A;--shiki-dark:#4C9A91">         0.16</span><span style="color:#B56959;--shiki-dark:#C98A7D"> sys</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">0.18</span><span style="color:#B56959;--shiki-dark:#C98A7D"> real</span><span style="color:#2F798A;--shiki-dark:#4C9A91">         0.08</span><span style="color:#B56959;--shiki-dark:#C98A7D"> user</span><span style="color:#2F798A;--shiki-dark:#4C9A91">         0.06</span><span style="color:#B56959;--shiki-dark:#C98A7D"> sys</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">0.18</span><span style="color:#B56959;--shiki-dark:#C98A7D"> real</span><span style="color:#2F798A;--shiki-dark:#4C9A91">         0.08</span><span style="color:#B56959;--shiki-dark:#C98A7D"> user</span><span style="color:#2F798A;--shiki-dark:#4C9A91">         0.06</span><span style="color:#B56959;--shiki-dark:#C98A7D"> sys</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">0.17</span><span style="color:#B56959;--shiki-dark:#C98A7D"> real</span><span style="color:#2F798A;--shiki-dark:#4C9A91">         0.08</span><span style="color:#B56959;--shiki-dark:#C98A7D"> user</span><span style="color:#2F798A;--shiki-dark:#4C9A91">         0.06</span><span style="color:#B56959;--shiki-dark:#C98A7D"> sys</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">...</span></span></code></pre><!----><!----><pre class="code-copy-target hidden">for i in $(seq 1 10); do /usr/bin/time zsh -i -c exit; done
0.45 real         0.25 user         0.16 sys
0.18 real         0.08 user         0.06 sys
0.18 real         0.08 user         0.06 sys
0.17 real         0.08 user         0.06 sys
...</pre><!----> <p>It <em>feels</em> fast, and the numbers support that. Even with a cold start I’m under my 0.5s startup time target, and the typical startups are even faster than I was shooting for. Fantastic!</p> <h2 id="conclusion"><a aria-hidden="true" tabindex="-1" href="#conclusion"><span class="icon icon-link"></span></a><a href="#conclusion" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Conclusion</h2> <p>To get my shell starting fast again, I used zsh’s profiler and the <code>time</code> utility to figure out what was taking the longest time. By starting with the slowest pieces, I was able to hit my performance target in only a few changes:</p> <ol><li>Lazy-loading <code>nvm</code> only when I’m going to need node.js</li> <li>[Skipped] limit how often completions are rebuilt. I opted not to keep this change as the performance gain was minimal and not worth the added security risk</li> <li>Swapping out archived software, neofetch, for a faster and maintained replacement: fastfetch</li></ol> <p>I’ll have to tinker with my fastfetch config to get the same output I had in neofetch. I’m glad I found that it was deprecated though. There’s one last step and this is a wrap:</p> <!----><pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code><span class="line"><span style="color:#59873A;--shiki-dark:#80A665">brew</span><span style="color:#B56959;--shiki-dark:#C98A7D"> uninstall</span><span style="color:#B56959;--shiki-dark:#C98A7D"> neofetch</span></span></code></pre><!----><!----><pre class="code-copy-target hidden">brew uninstall neofetch</pre><!----> <p>🫡 So long, old friend!</p><!----><!----> <div class="divider svelte-de2ged"></div> <aside class="prose svelte-de2ged"><p class="svelte-de2ged">If you're feeling extra generous, you can show your support by buying me a
			coffee with the button in the bottom right corner of the page.</p> <div class="divider svelte-de2ged"></div></aside></article> <!----><p class="svelte-de2ged">Loading comments...</p><!---->  <!--[--><div class="flex w-full flex-col items-center"><h2 class="text-base-content my-6 self-center text-5xl">Linked notes</h2> <!--[!--><!--]--> <div class="col-auto grid w-full grid-cols-[repeat(auto-fill,_minmax(300px,_1fr))] justify-items-center gap-3"><!--[--><a style="--statusColor: 85, 40%, 55%;" href="/notes/use-neovim" class="m-4 flex w-full min-w-[300px] max-w-[450px] flex-1 basis-80 text-inherit no-underline"><article class="group flex h-64 w-full flex-col justify-between border border-solid border-base-300 bg-base-100 px-10 py-8 text-base-content text-opacity-80 transition-all duration-200 hover:border-[hsl(var(--statusColor))] hover:text-opacity-100 hover:shadow-xl hover:shadow-[hsla(var(--statusColor),.25)] active:-translate-y-1 active:scale-[1.01] active:shadow-md svelte-15ajeer"><section class="notecontent"><header class="svelte-15ajeer"><h1 class="line-clamp-2 h-16 text-lg svelte-15ajeer">I use Neovim btw</h1></header> <!--[--><p class="mt-3 line-clamp-3 h-[4.5em] leading-[1.5em] transition-all duration-200">Imagine a world where something as simple as editing text becomes a fun and challenging puzzle to be solved.</p><!--]--></section> <section class="notemetadata border-t border-t-neutral-content border-opacity-60 pt-1 text-right text-sm svelte-15ajeer"><div class="date min-w-[12ch] text-opacity-50 svelte-15ajeer">Jul 30, 2024</div> <div class="min-w-[12ch] capitalize text-[hsl(var(--statusColor))] svelte-15ajeer">seedling 🌱</div></section></article></a><!--]--></div></div><!--]--> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css" integrity="sha384-KiWOvVjnN8qwAZbuQyWDIbfCLFhLXNETzBQjA/92pIowpC0d2O3nppDGQVgwd2nB" crossorigin="anonymous" class="svelte-de2ged"><!----><!----></div></div> <!--[!--><!--]--><!----><!----><!--]--> <!--[!--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_afwqym = {
						base: new URL("..", location).pathname.slice(0, -1)
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("../_app/immutable/entry/start.CpQz3iB1.js"),
						import("../_app/immutable/entry/app.B0u9XG_K.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 3],
							data: [null,null],
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
