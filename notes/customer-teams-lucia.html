<!DOCTYPE html>
<html lang="en" class="min-h-full">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="../favicon.svg" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link href="../_app/immutable/assets/0.2fa4ea1c.css" rel="stylesheet">
		<link href="../_app/immutable/assets/LoadNote.144730f5.css" rel="stylesheet">
		<link href="../_app/immutable/assets/MDSveXNoteLayout.61812917.css" rel="stylesheet">
		<link href="../_app/immutable/assets/6.8a973cea.css" rel="stylesheet">
		<link rel="modulepreload" href="../_app/immutable/entry/start.f195b3cc.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/scheduler.7131e7f1.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/singletons.9f58a6d2.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/paths.ff3aa747.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/parse.bee59afc.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/control.c2cf8273.js">
		<link rel="modulepreload" href="../_app/immutable/entry/app.b1f7e12b.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/preload-helper.a4192956.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/index.9e889c2d.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/0.02dd3792.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/each.49c20442.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/LoadNote.eb330e4b.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/navigation.3627f6fd.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/toast.47b55de1.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/6.6ceb6350.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/stores.215c6bea.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/NoteGrid.f4c44696.js"><title>Adding users to new teams with Lucia auth and Prisma - Allan Deutsch</title><!-- HEAD_svelte-x3qw35_START --><meta name="description" content="When building a B2B product, most customers will want to invite their team members. This post explores how I added support for that to Doc Duck, a documentation feedback solution I'm building."><meta property="og:title" content="Adding users to new teams with Lucia auth and Prisma"><meta property="og:type" content="article"><meta property="og:url" content="https://allandeutsch.com/notes/customer-teams-lucia"><meta property="og:description" content="When building a B2B product, most customers will want to invite their team members. This post explores how I added support for that to Doc Duck, a documentation feedback solution I'm building."><meta property="og:locale" content="en_US"><meta property="twitter:card" content="summary"><meta property="twitter:url" content="https://allandeutsch.com"><meta property="twitter:title" content="Adding users to new teams with Lucia auth and Prisma"><meta property="twitter:description" content="When building a B2B product, most customers will want to invite their team members. This post explores how I added support for that to Doc Duck, a documentation feedback solution I'm building."><meta property="twitter:site" content="@AllanDeutsch"><meta property="twitter:creator" content="@AllanDeutsch"><link rel="canonical" href="https://allandeutsch.com/notes/customer-teams-lucia"><script type="module" src="https://docduck.dev/selection.js" data-svelte-h="svelte-1qfon0b"></script><script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="AllanDeutsch" data-description="Support me on Buy me a coffee!" data-message="" data-color="#5F7FFF" data-position="Right" data-x_margin="18" data-y_margin="18" data-svelte-h="svelte-bv2cpr"></script><!-- HEAD_svelte-x3qw35_END --><!-- HEAD_svelte-cpyj77_START -->   <meta name="theme-color" content="dark"><!-- HTML_TAG_START --><script nonce="%sveltekit.nonce%">(function setInitialMode(defaultMode, themeColors2) {
  const rootEl = document.documentElement;
  const mode = localStorage.getItem("mode-watcher-mode") || defaultMode;
  const light = mode === "light" || mode === "system" && window.matchMedia("(prefers-color-scheme: light)").matches;
  rootEl.classList[light ? "remove" : "add"]("dark");
  rootEl.style.colorScheme = light ? "light" : "dark";
  if (themeColors2) {
    const themeMetaEl = document.querySelector('meta[name="theme-color"]');
    if (themeMetaEl) {
      themeMetaEl.setAttribute("content", mode === "light" ? themeColors2.light : themeColors2.dark);
    }
  }
  localStorage.setItem("mode-watcher-mode", mode);
})("system", {"dark":"dark","light":"light"});</script><!-- HTML_TAG_END --><!-- HEAD_svelte-cpyj77_END -->
		<!-- Global site tag (gtag.js) - Google Analytics -->
		<script
			async
			src="https://www.googletagmanager.com/gtag/js?id=UA-86124920-1"></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag() {
				dataLayer.push(arguments);
			}
			gtag('js', new Date());

			gtag('config', 'UA-86124920-1');
		</script>
	</head>
	<body class="h-full min-h-[100vh] bg-base-100">
		<div style="display: contents">  <div class="h-full min-h-[100dvh]"><div class="toaster  svelte-jyff3d"> </div> <div class="navbar bg-base-100 print:hidden"><div class="navbar-start"><div class="dropdown"><button tabindex="0" class="btn btn-ghost sm:hidden" data-svelte-h="svelte-o7egld"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h8m-8 6h16"></path></svg></button> <ul tabindex="0" class="dropdown-content menu rounded-box menu-sm mt-3 w-52 bg-base-100 p-2 shadow"><li><a href="/">Home</a></li><li><a href="/notes">Notes</a></li><li><a href="/devlog">Devlog</a></li></ul></div> <a class="btn btn-ghost text-xl normal-case" href="/">Allan Deutsch</a></div> <div class="navbar-center hidden sm:flex"><ul class="menu menu-horizontal px-1 text-base"><li><a href="/">Home</a></li><li><a href="/notes">Notes</a></li><li><a href="/devlog">Devlog</a></li></ul></div> <div class="navbar-end"> <div class="h-8" data-svelte-h="svelte-1hosge2"><a href="https://twitter.com/AllanDeutsch" class="group"><svg height="24" width="24" class="mr-1.5 inline fill-base-content transition-colors duration-300 group-hover:fill-primary" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612"><path d="M612 116.258a250.714 250.714 0 01-72.088 19.772c25.929-15.527 45.777-40.155 55.184-69.411-24.322 14.379-51.169 24.82-79.775 30.48-22.907-24.437-55.49-39.658-91.63-39.658-69.334 0-125.551 56.217-125.551 125.513 0 9.828 1.109 19.427 3.251 28.606-104.326-5.24-196.835-55.223-258.75-131.174-10.823 18.51-16.98 40.078-16.98 63.101 0 43.559 22.181 81.993 55.835 104.479a125.556 125.556 0 01-56.867-15.756v1.568c0 60.806 43.291 111.554 100.693 123.104-10.517 2.83-21.607 4.398-33.08 4.398-8.107 0-15.947-.803-23.634-2.333 15.985 49.907 62.336 86.199 117.253 87.194-42.947 33.654-97.099 53.655-155.916 53.655-10.134 0-20.116-.612-29.944-1.721 55.567 35.681 121.536 56.485 192.438 56.485 230.948 0 357.188-191.291 357.188-357.188l-.421-16.253c24.666-17.593 46.005-39.697 62.794-64.861z"></path></svg></a> <a href="https://github.com/masstronaut" class="group"><svg height="24" aria-hidden="true" viewBox="0 0 16 16" version="1.1" width="24" data-view-component="true" class="mr-1.5 inline fill-base-content transition-colors duration-300 group-hover:fill-primary"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg></a></div> </div></div> <div class="h-full p-1 sm:p-4"> <docduck-feedback team="TKxfdiO22xOXIrW0c0Pfi"></docduck-feedback> <article class="note-container prose mb-8 max-w-full px-2 svelte-1w2p8sa"><header class="w-full max-w-3xl self-center"><h1 class="mb-8 text-left text-4xl font-bold">Adding users to new teams with Lucia auth and Prisma</h1> <div class="text-md mb-12 mt-4 flex justify-between border-t border-t-neutral border-opacity-20 pt-1 text-base-content"><div><span class="pr-2" data-svelte-h="svelte-114jejz">üå±</span><span class="hidden sm:inline" data-svelte-h="svelte-1psjisz">Planted
				</span>October 16, 2023.
				<br>Last tended October 22, 2023.</div> <div class="flex flex-col items-end"><div class="note__status seedling svelte-1w2p8sa">seedling üå±</div>  <div>18 minutes read ‚è±</div></div></div></header>  <p data-svelte-h="svelte-1goo9gi">Recently I‚Äôve been building <a href="https://docduck.dev" rel="nofollow">Doc Duck</a>, a user feedback platform. I wanted to add support for teams so that a customer can invite their coworkers to also participate. Multiple people from a team/company wanting access to the software is a really common scenario in B2B. For Doc Duck, I anticipate that an analyst or PM will want to view data in the dashboard and share it with their team. Plus they will want an engineer to do the integration work. In this post, I‚Äôm going to explain how I added support for teams and wired up that information in the auth library I‚Äôm using, <a href="https://lucia-auth.com/" rel="nofollow">Lucia-auth</a> so that when accessing a user‚Äôs session I also get the information about teams they are on.</p> <h2 id="updating-the-database-with-tables-for-auth-and-teams" data-svelte-h="svelte-18yhcry"><a aria-hidden="true" tabindex="-1" href="#updating-the-database-with-tables-for-auth-and-teams"><span class="icon icon-link"></span></a><a href="#updating-the-database-with-tables-for-auth-and-teams" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Updating the database with tables for auth and teams</h2> <p data-svelte-h="svelte-1h26wko">First, I needed to add the relevant tables and fields to my database to support auth &amp; teams. I‚Äôm using <code>prisma</code>, so the following is what I‚Äôve added to my <code>schema.prisma</code> file to support the <a href="https://lucia-auth.com/database-adapters/prisma/#prisma-schema" rel="nofollow">fields needed for Lucia</a>  and to add support for teams.</p> <!-- HTML_TAG_START --><pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0"><code><span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">// This describes a user's role in a team.</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">enum</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> Role</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	admin</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	user</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">	@@map</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B56959;--shiki-dark:#C98A7D">"role"</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">model</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> User</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">	// These 3 fields are the User model defined by Lucia</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	id</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> String</span><span style="color:#59873A;--shiki-dark:#80A665"> @id</span><span style="color:#59873A;--shiki-dark:#80A665"> @unique</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	auth_session</span><span style="color:#A65E2B;--shiki-dark:#C99076"> Session</span><span style="color:#AB5959;--shiki-dark:#CB7676">[]</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	key</span><span style="color:#A65E2B;--shiki-dark:#C99076"> Key</span><span style="color:#AB5959;--shiki-dark:#CB7676">[]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">	// These are additional fields I want</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	email</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> String</span><span style="color:#59873A;--shiki-dark:#80A665"> @unique</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	created_date</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> DateTime</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">	// This defines a relation to the TeamMember table where a user can be a member of multiple teams </span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	teams</span><span style="color:#A65E2B;--shiki-dark:#C99076"> TeamMember</span><span style="color:#AB5959;--shiki-dark:#CB7676">[]</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">  </span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">// The  Session model defined by Lucia</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">model</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> Session</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	id</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> String</span><span style="color:#59873A;--shiki-dark:#80A665"> @id</span><span style="color:#59873A;--shiki-dark:#80A665"> @unique</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	user_id</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> String</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	active_expires</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> BigInt</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	idle_expires</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> BigInt</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	user</span><span style="color:#A65E2B;--shiki-dark:#C99076"> User</span><span style="color:#59873A;--shiki-dark:#80A665"> @relation</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">fields</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> [</span><span style="color:#A65E2B;--shiki-dark:#C99076">user_id</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">], </span><span style="color:#B07D48;--shiki-dark:#BD976A">references</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> [</span><span style="color:#A65E2B;--shiki-dark:#C99076">id</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">], </span><span style="color:#B07D48;--shiki-dark:#BD976A">onDelete</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#A65E2B;--shiki-dark:#C99076"> Cascade</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">	@@index</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">[</span><span style="color:#A65E2B;--shiki-dark:#C99076">user_id</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">]</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">// The Key model defined by Lucia</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">model</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> Key</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	id</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> String</span><span style="color:#59873A;--shiki-dark:#80A665"> @id</span><span style="color:#59873A;--shiki-dark:#80A665"> @unique</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	hashed_password</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> String</span><span style="color:#AB5959;--shiki-dark:#CB7676">?</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	user_id</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> String</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	user</span><span style="color:#A65E2B;--shiki-dark:#C99076"> User</span><span style="color:#59873A;--shiki-dark:#80A665"> @relation</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">fields</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> [</span><span style="color:#A65E2B;--shiki-dark:#C99076">user_id</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">], </span><span style="color:#B07D48;--shiki-dark:#BD976A">references</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> [</span><span style="color:#A65E2B;--shiki-dark:#C99076">id</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">], </span><span style="color:#B07D48;--shiki-dark:#BD976A">onDelete</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#A65E2B;--shiki-dark:#C99076"> Cascade</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">// This model represents teams in the database</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">model</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> Team</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	id</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> String</span><span style="color:#59873A;--shiki-dark:#80A665"> @id</span><span style="color:#59873A;--shiki-dark:#80A665"> @unique</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	name</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> String</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	created_date</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> DateTime</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	users</span><span style="color:#A65E2B;--shiki-dark:#C99076"> TeamMember</span><span style="color:#AB5959;--shiki-dark:#CB7676">[]</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34;--shiki-dark:#DBD7CAEE">  </span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">// This model defines team membership - each row represents one user's membership in one team</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">model</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> TeamMember</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	team_id</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> String</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	user_id</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> String</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	role</span><span style="color:#A65E2B;--shiki-dark:#C99076"> Role</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	joined</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> DateTime</span><span style="color:#59873A;--shiki-dark:#80A665"> @default</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#998418;--shiki-dark:#B8A965">now</span><span style="color:#999999;--shiki-dark:#666666">())</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	team</span><span style="color:#A65E2B;--shiki-dark:#C99076"> Team</span><span style="color:#59873A;--shiki-dark:#80A665"> @relation</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">fields</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> [</span><span style="color:#A65E2B;--shiki-dark:#C99076">team_id</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">], </span><span style="color:#B07D48;--shiki-dark:#BD976A">references</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> [</span><span style="color:#A65E2B;--shiki-dark:#C99076">id</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">], </span><span style="color:#B07D48;--shiki-dark:#BD976A">onDelete</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#A65E2B;--shiki-dark:#C99076"> Cascade</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	user</span><span style="color:#A65E2B;--shiki-dark:#C99076"> User</span><span style="color:#59873A;--shiki-dark:#80A665"> @relation</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">fields</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> [</span><span style="color:#A65E2B;--shiki-dark:#C99076">user_id</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">], </span><span style="color:#B07D48;--shiki-dark:#BD976A">references</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE"> [</span><span style="color:#A65E2B;--shiki-dark:#C99076">id</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">], </span><span style="color:#B07D48;--shiki-dark:#BD976A">onDelete</span><span style="color:#999999;--shiki-dark:#666666">:</span><span style="color:#A65E2B;--shiki-dark:#C99076"> Cascade</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">	@@id</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">[</span><span style="color:#A65E2B;--shiki-dark:#C99076">team_id</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">, </span><span style="color:#A65E2B;--shiki-dark:#C99076">user_id</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">]</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&#125;</span></span></code></pre><!-- HTML_TAG_END --><!-- HTML_TAG_START --><pre class="code-copy-target hidden">// This describes a user's role in a team.
enum Role &#123;
	admin
	user
	@@map("role")
&#125;

model User &#123;
	// These 3 fields are the User model defined by Lucia
	id String @id @unique
	auth_session Session[]
	key Key[]

	// These are additional fields I want
	email String @unique
	created_date DateTime

	// This defines a relation to the TeamMember table where a user can be a member of multiple teams 
	teams TeamMember[]
&#125;

  
// The  Session model defined by Lucia
model Session &#123;
	id String @id @unique
	user_id String
	active_expires BigInt
	idle_expires BigInt
	user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
	@@index([user_id])
&#125;

// The Key model defined by Lucia
model Key &#123;
	id String @id @unique
	hashed_password String?
	user_id String
	user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
&#125;

// This model represents teams in the database
model Team &#123;
	id String @id @unique
	name String
	created_date DateTime
	users TeamMember[]
&#125;

  
// This model defines team membership - each row represents one user's membership in one team
model TeamMember &#123;
	team_id String
	user_id String
	role Role
	joined DateTime @default(now())
	team Team @relation(fields: [team_id], references: [id], onDelete: Cascade)
	user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
	@@id([team_id, user_id])
&#125;</pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-ntem2n">For simplicity I‚Äôm only using a <code>Role</code> enum to manage user permissions within a team. For more complex permission setups like <a href="https://support.discord.com/hc/en-us/articles/214836687-Role-Management-101" rel="nofollow">Discord‚Äôs role management system</a>, I‚Äôd recommend implementing a more advanced permission system like <a href="https://en.wikipedia.org/wiki/Role-based_access_control" rel="nofollow">Role-based access control</a>. RBAC is out of scope for this article, but if you‚Äôd like one from me in the future, let me know on <a href="https://twitter.com/AllanDeutsch" rel="nofollow">Twitter</a>. If it gets enough interest, I might do it.</p> <p data-svelte-h="svelte-171n2w">Now that the model is defined, we can:</p> <ol data-svelte-h="svelte-1ezl9wp"><li><code>npx prisma generate</code> to generate the type definitions we will be using</li> <li><code>npx prisma db push</code> to push these changes to the database</li></ol> <h2 id="implementing-team-support-in-the-database-model" data-svelte-h="svelte-1a68icg"><a aria-hidden="true" tabindex="-1" href="#implementing-team-support-in-the-database-model"><span class="icon icon-link"></span></a><a href="#implementing-team-support-in-the-database-model" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Implementing team support in the database model</h2> <p data-svelte-h="svelte-j9soaa">I care a lot about providing a great user experience - both to myself as a developer, and to users of the software I develop. I don‚Äôt want new users to start their experience using <a href="https://docduck.dev" rel="nofollow">Doc Duck</a> by signing up and then creating a team. I want to minimize the time it takes to get from 0 to the ‚Äúaha‚Äù moment, so when they sign up I‚Äôm going to create a team for them.</p> <h3 id="requirements-for-user-and-team-creation" data-svelte-h="svelte-1s4v0r1"><a aria-hidden="true" tabindex="-1" href="#requirements-for-user-and-team-creation"><span class="icon icon-link"></span></a><a href="#requirements-for-user-and-team-creation" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Requirements for user and team creation</h3> <p data-svelte-h="svelte-183vic2">Creating a team and a user in the database simultaneously poses an additional challenge over doing them as separate operations. If creating one of them fails, both should fail. They need to be completed in a single ACID transaction.</p> <p data-svelte-h="svelte-1ueajyd">Since Lucia doesn‚Äôt support this, I‚Äôm going to have to define my own function for creating a user that meets my requirements. Those requirements are:</p> <ol data-svelte-h="svelte-15tt5b"><li>When a signing up a user, an <em>account and team</em> must be created</li> <li>Both need to succeed or fail completely - partial success is a full failure</li> <li>The results must still work with Lucia.</li> <li>On success, it should return the created <code>User</code> and <code>Team</code></li> <li>On failure, it should return the error information</li> <li>I want to use TypeScript to easily and safely determine whether it succeeded or failed and get the corresponding data</li></ol> <p data-svelte-h="svelte-wdhu5f">For now, I‚Äôm only supporting email &amp; password combos, so that‚Äôs what the function will take in as a parameter. Since database requests happen over a network, the most efficient way to write them is using async functions. Here‚Äôs the function signature for creating a user:</p> <!-- HTML_TAG_START --><pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0" data-tsplay="https://typescriptlang.org/play/#code/KYDwDg9gTgLgBAYwgOwM7wVYBDGwCqqwUcAvHNqgJ7IJwAUArkVACK7YBccA3gFABIYAFtsASwA23dFDHIA5gG5BYSqgDu0ACbSYshcoC+ASjIA+XnzhwA9DbgB1ABa448iMFRwnxYAH4+QyA"><code><span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">export</span><span style="color:#AB5959;--shiki-dark:#CB7676"> const </span><span style="color:#59873A;--shiki-dark:#80A665">createUser</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#AB5959;--shiki-dark:#CB7676"> async </span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">userData</span><span style="color:#999999;--shiki-dark:#666666">: &#123;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	email</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#2E8F82;--shiki-dark:#5DA994">string</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	password</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#2E8F82;--shiki-dark:#5DA994">string</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&#125;)</span><span style="color:#999999;--shiki-dark:#666666"> =></span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">  // What goes here?</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&#125;</span></span></code></pre><!-- HTML_TAG_END --><!-- HTML_TAG_START --><pre class="code-copy-target hidden">export const createUser = async (userData: &#123;
	email: string;
	password: string;
&#125;) =&gt; &#123;
  // What goes here?
&#125;</pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-b3oolo">Next I‚Äôm building the Prisma query for creating the user, team, and the relationship between them. To do this I used the prisma client and a couple utilities from Lucia for password hashing and creating a key.</p> <!-- HTML_TAG_START --><pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0" data-tsplay="https://typescriptlang.org/play/#code/JYWwDg9gTgLgBAbzmKwDOICGcC+cBmUEIcA5ACQA2wARgPRoCmUAbs3SulqQNwBQoSLERwA5owB2zTDEYAZAK4BjYJgAKmNGgDu0ACYAJTQAtcBIiVKVlqugpjBKaXgPDR4SJVEYzGAaUYATwBJPTNCYjJrFUxeIA"><code><span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span><span style="color:#B07D48;--shiki-dark:#BD976A"> prisma</span><span style="color:#999999;--shiki-dark:#666666"> &#125;</span><span style="color:#1E754F;--shiki-dark:#4D9375"> from</span><span style="color:#B5695999;--shiki-dark:#C98A7D99"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">$lib/server/prisma</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span><span style="color:#B07D48;--shiki-dark:#BD976A"> generateLuciaPasswordHash</span><span style="color:#999999;--shiki-dark:#666666"> &#125;</span><span style="color:#1E754F;--shiki-dark:#4D9375"> from</span><span style="color:#B5695999;--shiki-dark:#C98A7D99"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">lucia/utils</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span><span style="color:#B07D48;--shiki-dark:#BD976A"> createKeyId</span><span style="color:#999999;--shiki-dark:#666666"> &#125;</span><span style="color:#1E754F;--shiki-dark:#4D9375"> from</span><span style="color:#B5695999;--shiki-dark:#C98A7D99"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">lucia</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">;</span></span></code></pre><!-- HTML_TAG_END --><!-- HTML_TAG_START --><pre class="code-copy-target hidden">import &#123; prisma &#125; from '$lib/server/prisma';
import &#123; generateLuciaPasswordHash &#125; from 'lucia/utils';
import &#123; createKeyId &#125; from 'lucia';</pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-sa7b3x">I create a single Prisma client to use across my backend in <code>&#39;$lib/server/prisma&#39;</code>, which is that first import. I‚Äôm using the slick   <a href="https://kit.svelte.dev/docs/server-only-modules#your-modules" rel="nofollow">server-only module feature of SvelteKit</a>. By putting my Prisma module in <code>$lib/server</code>, SvelteKit will not let me import it into client code. Nifty!</p> <h3 id="including-the-right-data" data-svelte-h="svelte-14vkinb"><a aria-hidden="true" tabindex="-1" href="#including-the-right-data"><span class="icon icon-link"></span></a><a href="#including-the-right-data" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Including the right data</h3> <p data-svelte-h="svelte-1s75687">Now let‚Äôs look at the Prisma query itself! I am making a query to create a <code>User</code> and inside it I‚Äôm nesting the insertion of a <code>Key</code>, <code>TeamMember</code>, <code>Team</code>. <a href="https://www.prisma.io/docs/reference/api-reference/prisma-client-reference#create" rel="nofollow">Prisma performs nested inserts as a transaction</a>, which means the inserts will all succeed or all fail.</p> <p data-svelte-h="svelte-1mv4nlg">I split it out into the constituent parts to make it a bit easier to discuss here. There are 3 parts:</p> <ol data-svelte-h="svelte-2ivfyw"><li>The <code>data</code> object contains the data I want to insert to the database</li> <li>the <code>include</code> argument tells Prisma what to include in the response, in addition to the inserted <code>User</code></li> <li>Perform the query</li></ol> <p data-svelte-h="svelte-du8hpw">This is based on the excellent Lucia documentation about <a href="https://lucia-auth.com/basics/fallback-database-queries/" rel="nofollow">falling back to database queries in Lucia</a>.</p> <!-- HTML_TAG_START --><pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0" data-tsplay="https://typescriptlang.org/play/#code/PTAEAEDsHsFECd7XgZwFAGNqRQF1ACYCGuRoAvKAN5oCQIou0AtAdGgL6gokCWKAM14BTFKAAK8fgFsiAOgCqKYfADC8YSWEBBeAHMUAbQDkxUsYC6AbjSZseUL0gYANgFcCwitToMmrdi4eXH4hUQkpFFlFZTUNLV0DEydXD2FLGzQ-AAt+UAAHFQFkaTFcbK8iDFw3IhdQAEc3FQBPOxx8DRQ3F3xKIgB3Il58fMjot1i5DHjcYQAKGloU908AGjozIiywAEkBUBboN2MNUAw3KWOxIgAjY-xyrxRsokLQaAOnxub4FtAuj1cGtGLkxHlstABoxoKA9MJ8CNQAIkNICuNtgxlF4KhoAFygABqnAAlNw+IIRGJJDJ5EoVABxBHiIgtFzQIgEAA8VBWaQJuBahU+jmcq2EHAAfFYgA"><code><span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">// @noErrors</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">const </span><span style="color:#B07D48;--shiki-dark:#BD976A">data</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">	// to-do</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&#125;</span><span style="color:#1E754F;--shiki-dark:#4D9375"> satisfies</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> Prisma</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#2E8F82;--shiki-dark:#5DA994">UserCreateArgs</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#B56959;--shiki-dark:#C98A7D">data</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">const </span><span style="color:#B07D48;--shiki-dark:#BD976A">include</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">	// to-do</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&#125;</span><span style="color:#1E754F;--shiki-dark:#4D9375"> satisfies</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> Prisma</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#2E8F82;--shiki-dark:#5DA994">UserCreateArgs</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#B56959;--shiki-dark:#C98A7D">include</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">// this performs the actual query</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">const </span><span style="color:#B07D48;--shiki-dark:#BD976A">result</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#1E754F;--shiki-dark:#4D9375"> await</span><span style="color:#B07D48;--shiki-dark:#BD976A"> prisma</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">user</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">create</span><span style="color:#999999;--shiki-dark:#666666">(&#123;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	include</span><span style="color:#999999;--shiki-dark:#666666">,</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	data</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">// If you're curious about the shape of the query result, this is how to get it from prisma</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">// see here: V</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&#125;)</span><span style="color:#1E754F;--shiki-dark:#4D9375"> satisfies</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> Prisma</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#2E8F82;--shiki-dark:#5DA994">UserGetPayload</span><span style="color:#999999;--shiki-dark:#666666">&#x3C;&#123;</span><span style="color:#B07D48;--shiki-dark:#BD976A">include</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#AB5959;--shiki-dark:#CB7676">typeof</span><span style="color:#B07D48;--shiki-dark:#BD976A"> include</span><span style="color:#999999;--shiki-dark:#666666">&#125;>;</span></span></code></pre><!-- HTML_TAG_END --><!-- HTML_TAG_START --><pre class="code-copy-target hidden">// @noErrors
const data = &#123;
	// to-do
&#125; satisfies Prisma.UserCreateArgs['data'];

const include = &#123;
	// to-do
&#125; satisfies Prisma.UserCreateArgs['include'];

// this performs the actual query
const result = await prisma.user.create(&#123;
	include,
	data
// If you're curious about the shape of the query result, this is how to get it from prisma
// see here: V
&#125;) satisfies Prisma.UserGetPayload&lt;&#123;include: typeof include&#125;&gt;;</pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-1ugkl30">I‚Äôve used <code>satisfies Prisma.&lt;something&gt;</code> in all of these to get better type safety and tooling support. Note that for <code>include</code> and <code>data</code> it‚Äôs important to use <code>satisfies</code> rather than a type annotation. This is because a type annotation will <em>widen</em> the value to the type of the annotation. In contrast, <code>satisfies</code> enforces the constraints of the specified type, but won‚Äôt widen the value into that type. This behavior is necessary for <code>Prisma.UserGetPayload&lt;&gt;</code> to provide the correct result type. You can learn more about the <code>satisfies</code> operator in the <a href="https://www.typescriptlang.org/docs/handbook/release-notes/typescript-4-9.html#the-satisfies-operator" rel="nofollow">Typescript 4.9 release announcement</a>.</p> <p data-svelte-h="svelte-1m2k7vv">Now that I have the structure of the query and result, lets look at the meat of the request, starting with include:</p> <!-- HTML_TAG_START --><pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0" data-tsplay="https://typescriptlang.org/play/#code/PTAEAEDsHsFECd7XgZwFAGNqRQF1AJaQYA2ArgCYCmoAvKAN5oCQuVAhgLYoBcjLzIqUpU+TZhLZc+ueGSoCAvi2WLQKdrgIoAZgSopQABXjbO7AHQBVFFXgBheBzYBBeAHMUAbQDkQ8tQ+ALoA3EA"><code><span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">// @noErrors</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">const </span><span style="color:#B07D48;--shiki-dark:#BD976A">include</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">	teams</span><span style="color:#999999;--shiki-dark:#666666">: &#123;</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">		include</span><span style="color:#999999;--shiki-dark:#666666">: &#123;</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">			team</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#1E754F;--shiki-dark:#4D9375">true</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">		&#125;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">	&#125;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&#125;</span><span style="color:#1E754F;--shiki-dark:#4D9375"> satisfies</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> Prisma</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#2E8F82;--shiki-dark:#5DA994">UserCreateArgs</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#B56959;--shiki-dark:#C98A7D">include</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">];</span></span></code></pre><!-- HTML_TAG_END --><!-- HTML_TAG_START --><pre class="code-copy-target hidden">// @noErrors
const include = &#123;
	teams: &#123;
		include: &#123;
			team: true
		&#125;
	&#125;
&#125; satisfies Prisma.UserCreateArgs['include'];</pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-xsqc6v">This include object might look a little convoluted. Think back to the data model; to support users being in multiple teams, I have 3 tables:</p> <ol data-svelte-h="svelte-r9uh3h"><li>User - the table with user properties</li> <li>Team - the table with team properties</li> <li>TeamMember - the table that defines relationships between users and teams</li></ol> <p data-svelte-h="svelte-mhfx4l">So the include statement above is telling Prisma what fields to give us in response. In addition to the basic fields of the <code>User</code> model, I‚Äôve told it to include an array of <code>TeamMember</code>s and corresponding <code>team</code>s that the user is in. Because I‚Äôm inserting a new user and team here, I know that <code>teams</code> will be an array of exactly 1 team.</p> <h4 id="shape-of-a-user-type-that-includes-teams" data-svelte-h="svelte-17htipy"><a aria-hidden="true" tabindex="-1" href="#shape-of-a-user-type-that-includes-teams"><span class="icon icon-link"></span></a><a href="#shape-of-a-user-type-that-includes-teams" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Shape of a <code>User</code> type that includes teams</h4> <p data-svelte-h="svelte-jdps8c">The result will be of the following shape, which I‚Äôve written out to provide annotations:</p> <!-- HTML_TAG_START --><pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0" data-tsplay="https://typescriptlang.org/play/#code/C4TwDgpgBAqgzhATgSQHYGMA2BXAJgS1QHMAVCAQwFsoBeKAbwCgBIAelahIAtoAjcuPnRQAZvgiZccUYgD21YDygADeEmVRKs3BJb5cALihxgiQkQDcLCJXL5MRk2eJXm6RBWARcAfVzkvIwARAIhXdihyTDhZKEIsPGhFaGUyKgBZG151KA9MAPxZVAAaKHQozG8VLyo4ZRYayjgjJmY2Dm4+ASFRcUlpETkFJVSKSkzKbMQNLR1MFmZGn31HU3NXZmwERGXDYzWXBblKowASAFFUbCaAOgAlWUqNgCtZQm9g0I2IqJi4jBwOigyRUaUoGjyBSKpXKmEquGqY2UBgWjRaC2YK32zksGNQVAgqxxGzcHlCvn8gSgIS8GwAviw6QBtAC6jDpQA"><code><span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">type</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> UserIncludingTeam</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">	// The basic fields from the &#96;User&#96; model</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	id</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#2E8F82;--shiki-dark:#5DA994">string</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	email</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#2E8F82;--shiki-dark:#5DA994">string</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	created_date</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#2E8F82;--shiki-dark:#5DA994">Date</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">	// also include the &#96;TeamMember&#96; relation, called &#96;teams&#96;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	teams</span><span style="color:#999999;--shiki-dark:#666666">: &#123;</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">		// The basic fields from the &#96;TeamMember&#96; model</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">		team_id</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#2E8F82;--shiki-dark:#5DA994">string</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">		user_id</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#2E8F82;--shiki-dark:#5DA994">string</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">		role</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#2E8F82;--shiki-dark:#5DA994">$Enums</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#2E8F82;--shiki-dark:#5DA994">Role</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">		joined</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#2E8F82;--shiki-dark:#5DA994">Date</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">		// also include the &#96;Team&#96; relation, called &#96;team&#96;:</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">		team</span><span style="color:#999999;--shiki-dark:#666666">: &#123;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">			id</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#2E8F82;--shiki-dark:#5DA994">string</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">			name</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#2E8F82;--shiki-dark:#5DA994">string</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">			created_date</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#2E8F82;--shiki-dark:#5DA994">Date</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">		&#125;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">	&#125;[]</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&#125;</span></span></code></pre><!-- HTML_TAG_END --><!-- HTML_TAG_START --><pre class="code-copy-target hidden">type UserIncludingTeam = &#123;
	// The basic fields from the &#96;User&#96; model
	id: string;
	email: string;
	created_date: Date;
	// also include the &#96;TeamMember&#96; relation, called &#96;teams&#96;
	teams: &#123;
		// The basic fields from the &#96;TeamMember&#96; model
		team_id: string;
		user_id: string;
		role: $Enums.Role;
		joined: Date;
		// also include the &#96;Team&#96; relation, called &#96;team&#96;:
		team: &#123;
			id: string;
			name: string;
			created_date: Date;
		&#125;
	&#125;[]
&#125;</pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-18inkye">Outside of an article, I prefer to use the <a href="https://www.prisma.io/docs/concepts/components/prisma-client/advanced-type-safety#type-utilities" rel="nofollow">Prisma utilities for advanced type safety</a>. They are generated based on the model definition, so are going to stay up-to-date when the model changes. An equivalent type can be produced by Prisma with a single line: <code>Prisma.UserGetPayload&lt;{include: typeof include}&gt;</code>. Much easier to write!</p> <h3 id="create-the-new-user-and-their-team" data-svelte-h="svelte-t5p31a"><a aria-hidden="true" tabindex="-1" href="#create-the-new-user-and-their-team"><span class="icon icon-link"></span></a><a href="#create-the-new-user-and-their-team" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Create the new user and their team</h3> <p data-svelte-h="svelte-1l1x545">Up next is the <code>data</code> object. This is how I specify what data should be used to create:</p> <ol data-svelte-h="svelte-1ounvow"><li>The user</li> <li>The <code>TeamMember</code> and corresponding <code>Team</code> that the user will be in</li> <li>A <code>Key</code> entry so the user can sign in with username and password</li></ol> <!-- HTML_TAG_START --><pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0" data-tsplay="https://typescriptlang.org/play/#code/MYewdgzgLgBAJgQygmBeGBvAUASAPR4wAqAFgKYwBGCEAlsDAK4RkBO8SCuwrZSZcAPqIoZAFwwwZAO4wAIvwAUC0QDowIaYoCU2gDS4yAWwS0ANgZy04EngE8ADlBCrWCMHBBGAqt4CScjp6MAQwCABupmYIlGYU4DBGINBUrJosrBBhHjAAciBwZABSAMq4oghGEBLYOPiEpLRZomZmWQAKrE0mMM4wPHyiYcR8RgCyxpRsMNK0UCTDvNFQtAl98xRSssxsuDgD-DV7OGlxEgDkCHBGtGDnlnUVRkd1daGNWQeizeSSMiOVY77XiHTBAnBgSriGDnMZ2AFGe7gr4CYSgrbyJQqMjqTQ6fTg6y2ViOZyudyeHz+QLaIEAX2ODLqTLplgA1mQ7C96jA-H8BL0QDBoCBeMMOfCIELbr1fgAzRhQRhijZMDL9dzC2gAczAMBlexR3J5pDILBgCrAwBW4CyCDFDjS4WsAso8IAMoxgLQEABaBCKkjHIn9EGiADSnL8cEU52MUXuMHj5lUzndmjYAGEaGR8Q8cCQaOQhA4aBBpKKbGFpKZYNqyFI3KJPd6EO0yxXWHAABJFxSliDlyu05m4BkEABqxBITTCbSFjpAzsKWW1Yf1YBaZiaDfNEEYDgcoqgAEIsHThUgmnLaGaYJ1ughVN4Mpmw2QAIKsbUQADa5xEBBzgAXQAbiAA"><code><span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">const </span><span style="color:#B07D48;--shiki-dark:#BD976A">data</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">	// The basic user data</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">	created_date</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#AB5959;--shiki-dark:#CB7676">new</span><span style="color:#59873A;--shiki-dark:#80A665"> Date</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">Date</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">now</span><span style="color:#999999;--shiki-dark:#666666">()),</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	email</span><span style="color:#999999;--shiki-dark:#666666">,</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">	id</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#B07D48;--shiki-dark:#BD976A">crypto</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">randomUUID</span><span style="color:#999999;--shiki-dark:#666666">(), </span><span style="color:#A0ADA0;--shiki-dark:#758575DD">// available on most browsers and NodeJS</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">	teams</span><span style="color:#999999;--shiki-dark:#666666">: &#123;</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">		// This tells Prisma to create a TeamMember with a relation to the new user</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">		create</span><span style="color:#999999;--shiki-dark:#666666">: &#123;</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">			role</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#B56959;--shiki-dark:#C98A7D">admin</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">,</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">			team</span><span style="color:#999999;--shiki-dark:#666666">: &#123;</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">				// This creates the new Team</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">				create</span><span style="color:#999999;--shiki-dark:#666666">: &#123;</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">					name</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#B56959;--shiki-dark:#C98A7D">My Team</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">,</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">					created_date</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#AB5959;--shiki-dark:#CB7676">new</span><span style="color:#59873A;--shiki-dark:#80A665"> Date</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">Date</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">now</span><span style="color:#999999;--shiki-dark:#666666">()),</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">					id</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#B07D48;--shiki-dark:#BD976A">crypto</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">randomUUID</span><span style="color:#999999;--shiki-dark:#666666">()</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">				&#125;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">			&#125;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">		&#125;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">	&#125;,</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">	key</span><span style="color:#999999;--shiki-dark:#666666">: &#123;</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">		// I need to store a key so in the future the user can sign in </span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">		create</span><span style="color:#999999;--shiki-dark:#666666">: &#123;</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">			// These functions are provided by Lucia-auth</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">			id</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#59873A;--shiki-dark:#80A665">createKeyId</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#B56959;--shiki-dark:#C98A7D">email</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">, </span><span style="color:#B07D48;--shiki-dark:#BD976A">email</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">toLowerCase</span><span style="color:#999999;--shiki-dark:#666666">()),</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">			hashed_password</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#1E754F;--shiki-dark:#4D9375">await</span><span style="color:#59873A;--shiki-dark:#80A665"> generateLuciaPasswordHash</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">password</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">		&#125;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">	&#125;</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">//V This also provides great intellisense support!</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&#125;</span><span style="color:#1E754F;--shiki-dark:#4D9375"> satisfies</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> Prisma</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#2E8F82;--shiki-dark:#5DA994">UserCreateArgs</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#B56959;--shiki-dark:#C98A7D">data</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">];</span></span></code></pre><!-- HTML_TAG_END --><!-- HTML_TAG_START --><pre class="code-copy-target hidden">const data = &#123;
	// The basic user data
	created_date: new Date(Date.now()),
	email,
	id: crypto.randomUUID(), // available on most browsers and NodeJS
	teams: &#123;
		// This tells Prisma to create a TeamMember with a relation to the new user
		create: &#123;
			role: 'admin',
			team: &#123;
				// This creates the new Team
				create: &#123;
					name: 'My Team',
					created_date: new Date(Date.now()),
					id: crypto.randomUUID()
				&#125;
			&#125;
		&#125;
	&#125;,
	key: &#123;
		// I need to store a key so in the future the user can sign in 
		create: &#123;
			// These functions are provided by Lucia-auth
			id: createKeyId('email', email.toLowerCase()),
			hashed_password: await generateLuciaPasswordHash(password)
		&#125;
	&#125;
//V This also provides great intellisense support!
&#125; satisfies Prisma.UserCreateArgs['data'];</pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-1826pb3">Finally I bring it all together and create the user and their new team. Whew!</p> <!-- HTML_TAG_START --><pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0" data-tsplay="https://typescriptlang.org/play/#code/MYewdgzgLgBAjgVwKYCcCeAlJEEBtYC8MAhgO7ECWsADihRALbEB0CEqzwKSxUSAFAG8AUAEgAJr2IAaMRTDBcCcUmEBfAJQBuIA"><code><span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">const </span><span style="color:#B07D48;--shiki-dark:#BD976A">queryResult</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#1E754F;--shiki-dark:#4D9375"> await</span><span style="color:#B07D48;--shiki-dark:#BD976A"> prisma</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">user</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">create</span><span style="color:#999999;--shiki-dark:#666666">(&#123;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	data</span><span style="color:#999999;--shiki-dark:#666666">,</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	include</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&#125;);</span></span></code></pre><!-- HTML_TAG_END --><!-- HTML_TAG_START --><pre class="code-copy-target hidden">const queryResult = await prisma.user.create(&#123;
	data,
	include
&#125;);</pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-9ybhdk">Now that the bulk of my <code>createUser()</code> logic is done, I need to return the results!</p> <h3 id="structuring-and-returning-the-result-of-creating-a-user" data-svelte-h="svelte-1250swe"><a aria-hidden="true" tabindex="-1" href="#structuring-and-returning-the-result-of-creating-a-user"><span class="icon icon-link"></span></a><a href="#structuring-and-returning-the-result-of-creating-a-user" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Structuring and returning the result of creating a user</h3> <p data-svelte-h="svelte-u2zlce">To get my <code>User</code> and <code>Team</code> back from the sign-up transaction, I‚Äôll use the types defined by prisma to build my result types. I‚Äôve opted to use separate types to represent success and failure, and combine them into a <a href="https://www.typescriptlang.org/docs/handbook/2/everyday-types.html#union-types" rel="nofollow">union type</a> called <code>CreateUserResult</code>:</p> <!-- HTML_TAG_START --><pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0" data-tsplay="https://typescriptlang.org/play/#code/JYWwDg9gTgLgBDAnmApnA3nAKighiAGjgFUBnFKOAXzgDMoIQ4ByAATCmFJFwHoBjADbAUAOxjMA3AChpSVHADCUPDBRkKAZQCu-filKk4AXgzSAkKV37DALgRRtKGee3ko9jVBdr89nPgyVDJyyGjKquruAGK4wILaKiZmltYGpPa0uILkLhQMHnCkMJyiAOYu-BAAJij2xaVlcAA+cNqitbTAoijVQTLy4Sq4al4ASgbagvCmESNRWmmGLUrDozFxCSoyKAAekLBwVaLFR2sLlKa4pIii-HAAFG4UACIjuPboFig88fUl3QqFjA11IAHdoNV-o0ggBKewABQYIC4KAAPHN1hQJlZpgA+EwEr68XhwAB0FOkVCAA"><code><span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#1E754F;--shiki-dark:#4D9375"> type</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span><span style="color:#B07D48;--shiki-dark:#BD976A"> Team</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> User</span><span style="color:#999999;--shiki-dark:#666666"> &#125;</span><span style="color:#1E754F;--shiki-dark:#4D9375"> from</span><span style="color:#B5695999;--shiki-dark:#C98A7D99"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">@prisma/client</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">type</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> CreateUserSuccess</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	success</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#AB5959;--shiki-dark:#CB7676">true</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	user</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#2E8F82;--shiki-dark:#5DA994">User</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	team</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#2E8F82;--shiki-dark:#5DA994">Team</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&#125;;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">type</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> CreateUserFailure</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	success</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#AB5959;--shiki-dark:#CB7676">false</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	error</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#2E8F82;--shiki-dark:#5DA994">string</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	code</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#2E8F82;--shiki-dark:#5DA994">string</span><span style="color:#999999;--shiki-dark:#666666"> | </span><span style="color:#AB5959;--shiki-dark:#CB7676">undefined</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&#125;;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">type</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> CreateUserResult</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> CreateUserSuccess</span><span style="color:#999999;--shiki-dark:#666666"> |</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> CreateUserFailure</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">export</span><span style="color:#AB5959;--shiki-dark:#CB7676"> const </span><span style="color:#59873A;--shiki-dark:#80A665">createUser</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#AB5959;--shiki-dark:#CB7676"> async </span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">userData</span><span style="color:#999999;--shiki-dark:#666666">: &#123;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	email</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#2E8F82;--shiki-dark:#5DA994">string</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">	password</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#2E8F82;--shiki-dark:#5DA994">string</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&#125;):</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> Promise</span><span style="color:#999999;--shiki-dark:#666666">&#x3C;</span><span style="color:#2E8F82;--shiki-dark:#5DA994">CreateUserResult</span><span style="color:#999999;--shiki-dark:#666666">></span><span style="color:#999999;--shiki-dark:#666666"> =></span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">// ...</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&#125;</span></span></code></pre><!-- HTML_TAG_END --><!-- HTML_TAG_START --><pre class="code-copy-target hidden">import type &#123; Team, User &#125; from '@prisma/client';

type CreateUserSuccess = &#123;
	success: true;
	user: User;
	team: Team;
&#125;;

type CreateUserFailure = &#123;
	success: false;
	error: string;
	code: string | undefined;
&#125;;
type CreateUserResult = CreateUserSuccess | CreateUserFailure;
export const createUser = async (userData: &#123;
	email: string;
	password: string;
&#125;): Promise&lt;CreateUserResult&gt; =&gt; &#123;
// ...
&#125;</pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-r51z76">This uses a <em>TypeScript</em> technique called a <a href="https://www.typescriptlang.org/docs/handbook/2/narrowing.html#discriminated-unions" rel="nofollow">discriminated union</a>. Based on the value of <code>.success</code> in the <code>CreateUserResult</code> returned by <code>createUser()</code>, TypeScript can safely determine whether the object is a success or failure and expose the correct fields to me.</p> <p data-svelte-h="svelte-16jsvgt">The success case is fairly straightforward; grab the user and team from the <code>queryResult</code> and return a <code>CreateUserSuccess</code>:</p> <!-- HTML_TAG_START --><pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0" data-tsplay="https://typescriptlang.org/play/#code/E4UwLgrsB2AEDeAoAkAZwgYwyVqBcsYwEIANLAPQWwYA2AliNGDQPYAmINAhnBKlzAALeqkKtY7URmD0AtvWjcwgoV1DpaLUbAAGAYVDKQAVQHAAypmy5dKKrAAqIsQHd6tWrCXBgrV4RqevwgwLqS-nBgEsJcAEbcqPQYsABmjLTsYqypsCBy3B7kMiDG7AD67MbkvOyw9OwAdCghwAQAjiTAAJ4ASjgQWrCJsADyCmAAPGDdAA4gObCdoX0DWuQA5CrccqgbAHyk9tQWitj1YBti3N4grrTd9dDmKnWt5ACSsADW0P6BIEe3FATzyAA9uBgwA9YABGQilOQobZyAitRoo1AAbQADABdDGIxAAX1gqGUonSOFghlKKjMoSsWBwqAA3JRqMIdLM-AA3BrUuLgFTAJ4qTyiJgCMkQWazVjAMBAA"><code><span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">return</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">	success</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#1E754F;--shiki-dark:#4D9375">true</span><span style="color:#999999;--shiki-dark:#666666">, </span><span style="color:#A0ADA0;--shiki-dark:#758575DD">// client code can use this to discriminate the result is &#96;CreateUserSuccess&#96;</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">	// This will narrow the &#96;user&#96; down to the basic fields of email, created_date, and id.</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">	user</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#B07D48;--shiki-dark:#BD976A">queryResult</span><span style="color:#1E754F;--shiki-dark:#4D9375"> as</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> Omit</span><span style="color:#999999;--shiki-dark:#666666">&#x3C;</span><span style="color:#AB5959;--shiki-dark:#CB7676">typeof</span><span style="color:#B07D48;--shiki-dark:#BD976A"> queryResult</span><span style="color:#999999;--shiki-dark:#666666">, </span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#B56959;--shiki-dark:#C98A7D">teams</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">>,</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">	// Since it's a newly inserted user, I know they are in exactly 1 team</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">	team</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#B07D48;--shiki-dark:#BD976A">user</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">teams</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#2F798A;--shiki-dark:#4C9A91">0</span><span style="color:#999999;--shiki-dark:#666666">].</span><span style="color:#B07D48;--shiki-dark:#BD976A">team</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&#125;</span><span style="color:#1E754F;--shiki-dark:#4D9375"> satisfies</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> CreateUserSuccess</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#A0ADA0;--shiki-dark:#758575DD"> // this provides better intellisense support</span></span></code></pre><!-- HTML_TAG_END --><!-- HTML_TAG_START --><pre class="code-copy-target hidden">return &#123;
	success: true, // client code can use this to discriminate the result is &#96;CreateUserSuccess&#96;
	// This will narrow the &#96;user&#96; down to the basic fields of email, created_date, and id.
	user: queryResult as Omit&lt;typeof queryResult, 'teams'&gt;,
	// Since it's a newly inserted user, I know they are in exactly 1 team
	team: user.teams[0].team
&#125; satisfies CreateUserSuccess; // this provides better intellisense support</pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-1p0112e">The failure case occurs when something goes wrong with the Prisma query. When that happens, it will throw an error. We can catch it by wrapping the query in a try/catch block:</p> <!-- HTML_TAG_START --><pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0" data-tsplay="https://typescriptlang.org/play/#code/MYewdgzgLgBAJgQygmBeGBvAdDgvgbgChRJYBLMYAGwFc4BTNTHLAwqAJwE9NCBIEtBgBHGvW4AlehBpVY6BAHcEZWAAcOZCAFsEWGhHFZgHeknoAKDPz6JkAGhsVqdev1wBKIn1NQaHMGY8GAgkLQAzMmkYAGFTcwBVQw4AZRpgYGkIIlwYYCRgAAsYC3oPXj4ycJLGCmgESnoQaoAFTR09Nq1dGKoosCgAaTAQRTApUWkoAFEODhAOGAAyJZt6YxAGNFR0AHIWgCYABiOD3Y9rPh96PwCKq5kMrIAuGHCEKkNHK75xeY5XuttFkEABzejfK6gBiAjYMGy4dz8Xz+QKXPiPTIQCCvd6fCEwNZzBavXYJMAAaxGYxgfwWMBAGX8pjgWF29kJUM29FeNDADEiYHocCRuCAA"><code><span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">const </span><span style="color:#B07D48;--shiki-dark:#BD976A">data</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#999999;--shiki-dark:#666666"> &#123;...&#125;;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">const </span><span style="color:#B07D48;--shiki-dark:#BD976A">include</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#999999;--shiki-dark:#666666"> &#123;...&#125;;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">try</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">	const </span><span style="color:#B07D48;--shiki-dark:#BD976A">queryResult</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#1E754F;--shiki-dark:#4D9375"> await</span><span style="color:#B07D48;--shiki-dark:#BD976A"> prisma</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">user</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">create</span><span style="color:#999999;--shiki-dark:#666666">(&#123;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">		data</span><span style="color:#999999;--shiki-dark:#666666">,</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">		include</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">	&#125;);</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">	return</span><span style="color:#999999;--shiki-dark:#666666"> &#123;...&#125;</span><span style="color:#1E754F;--shiki-dark:#4D9375"> satisfies</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> CreateUserSuccess</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&#125;</span><span style="color:#1E754F;--shiki-dark:#4D9375"> catch</span><span style="color:#999999;--shiki-dark:#666666"> (</span><span style="color:#B07D48;--shiki-dark:#BD976A">e</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">	if</span><span style="color:#999999;--shiki-dark:#666666"> (</span><span style="color:#B07D48;--shiki-dark:#BD976A">e</span><span style="color:#AB5959;--shiki-dark:#CB7676"> instanceof</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> Prisma</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#2E8F82;--shiki-dark:#5DA994">PrismaClientKnownRequestError</span><span style="color:#AB5959;--shiki-dark:#CB7676"> &#x26;&#x26;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">		e</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">code</span><span style="color:#AB5959;--shiki-dark:#CB7676"> ===</span><span style="color:#B5695999;--shiki-dark:#C98A7D99"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">P2002</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">)&#123;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">		return</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">			success</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#1E754F;--shiki-dark:#4D9375">false</span><span style="color:#999999;--shiki-dark:#666666">,</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">			error</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#B07D48;--shiki-dark:#BD976A">e</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">message</span><span style="color:#999999;--shiki-dark:#666666">,</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">			code</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#B07D48;--shiki-dark:#BD976A">e</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">code</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">		&#125;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">	&#125;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">	return</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">		success</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#1E754F;--shiki-dark:#4D9375">false</span><span style="color:#999999;--shiki-dark:#666666">, </span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">		error</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#B56959;--shiki-dark:#C98A7D">Unknown error occurred.</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">, </span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">		code</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#AB5959;--shiki-dark:#CB7676">undefined</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">	&#125;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&#125;</span></span></code></pre><!-- HTML_TAG_END --><!-- HTML_TAG_START --><pre class="code-copy-target hidden">const data = &#123;...&#125;;
const include = &#123;...&#125;;
try &#123;
	const queryResult = await prisma.user.create(&#123;
		data,
		include
	&#125;);
	return &#123;...&#125; satisfies CreateUserSuccess;
&#125; catch (e) &#123;
	if (e instanceof Prisma.PrismaClientKnownRequestError &&
		e.code === 'P2002')&#123;
		return &#123;
			success: false,
			error: e.message,
			code: e.code
		&#125;
	&#125;
	return &#123;
		success: false, 
		error: 'Unknown error occurred.', 
		code: undefined
	&#125;
&#125;</pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-ch7yj5">I‚Äôve kept this error handling example brief. When building for production, I recommend handling the full list of <a href="https://www.prisma.io/docs/reference/api-reference/error-reference" rel="nofollow">Prisma errors</a>.</p> <h2 id="extending-lucia-types-to-include-teams" data-svelte-h="svelte-13hzvqv"><a aria-hidden="true" tabindex="-1" href="#extending-lucia-types-to-include-teams"><span class="icon icon-link"></span></a><a href="#extending-lucia-types-to-include-teams" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Extending Lucia types to include teams</h2> <p data-svelte-h="svelte-17wzsvl">Now that teams are supported in the database and get created alongside new users, I want to start using them in my SvelteKit endpoints and <a href="https://kit.svelte.dev/docs/load" rel="nofollow">load functions</a>. That‚Äôs how I will validate the user‚Äôs session and make sure they are <em>authorized</em> for whatever they are trying to do. This is important because I don‚Äôt want to let any user view or interact with data for teams they aren‚Äôt part of. Plus, some actions like adding or removing members from the team will require the user to be in the team and have elevated privileges. The <a href="https://lucia-auth.com/getting-started/sveltekit/#set-up-hooks" rel="nofollow">Lucia guide to SvelteKit setup</a> adds the Lucia <code>auth</code> object to <code>locals</code>, so it‚Äôs readily available for this.</p> <p data-svelte-h="svelte-1bes11d">Unfortunately, I‚Äôve got a problem! Lucia doesn‚Äôt know about teams yet, so the <code>Session</code> object it gives me doesn‚Äôt contain team data:</p> <!-- HTML_TAG_START --><pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0" data-tsplay="https://typescriptlang.org/play/#code/JYWwDg9gTgLgBDAnmApnA3nACgQwOYoDKKUAbiQDIQ4AmcAvnAGZQQhwDkAdAPQAkSVAGcOAbjg8ecAgDsSOGCjoAjRHELkANooDSwGAChQkWBjhQlwCwGN4jFm04ABIVsUArITwDW+sQYMUAA8TeGsIGSF4TWoaAC5sfCIScigqWjgAXjgcIUQZazgACkwY6xxNIQAaODAcKBwQIQYASiyAPgwDAEhwyPghFCEhYAisnIB3HH04MoqhLhwAVxgACy5SCuAaBRQilvFJBFXgIR7gJiKZJc1NLMzsweHRmTa11gnzSxsYIoBmAAMACYahweDE8MAZBwDj0+lE4EtBlBxk8RhEuEiSKIAt0jgA5CCfACScCmMngMAgcGsqxQ1m8xzQWKgHGaika1TgyhWcD8zRkEHgUOsmiWNCUfJkTLgaJeUqYEAAhHCIgiOU1xiyuBqhIcpCRWFAVfQgA"><code><span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#1E754F;--shiki-dark:#4D9375"> type</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span><span style="color:#B07D48;--shiki-dark:#BD976A"> PageServerLoad</span><span style="color:#999999;--shiki-dark:#666666"> &#125;</span><span style="color:#1E754F;--shiki-dark:#4D9375"> from</span><span style="color:#B5695999;--shiki-dark:#C98A7D99"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">./$types</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#A0ADA0;--shiki-dark:#758575DD"> // generated by SvelteKit</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span><span style="color:#B07D48;--shiki-dark:#BD976A"> redirect</span><span style="color:#999999;--shiki-dark:#666666"> &#125;</span><span style="color:#1E754F;--shiki-dark:#4D9375"> from</span><span style="color:#B5695999;--shiki-dark:#C98A7D99"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">@sveltejs/kit</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">export</span><span style="color:#AB5959;--shiki-dark:#CB7676"> const </span><span style="color:#59873A;--shiki-dark:#80A665">load</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#2E8F82;--shiki-dark:#5DA994">PageServerLoad</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#AB5959;--shiki-dark:#CB7676"> async </span><span style="color:#999999;--shiki-dark:#666666">(&#123;</span><span style="color:#B07D48;--shiki-dark:#BD976A"> locals</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> params</span><span style="color:#999999;--shiki-dark:#666666"> &#125;)</span><span style="color:#999999;--shiki-dark:#666666"> =></span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">	const </span><span style="color:#B07D48;--shiki-dark:#BD976A">session</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#1E754F;--shiki-dark:#4D9375"> await</span><span style="color:#B07D48;--shiki-dark:#BD976A"> locals</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">auth</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">validate</span><span style="color:#999999;--shiki-dark:#666666">();</span><span style="color:#A0ADA0;--shiki-dark:#758575DD"> // this</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">	if</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#AB5959;--shiki-dark:#CB7676">null === </span><span style="color:#B07D48;--shiki-dark:#BD976A">session</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#1E754F;--shiki-dark:#4D9375"> throw</span><span style="color:#59873A;--shiki-dark:#80A665"> redirect</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#2F798A;--shiki-dark:#4C9A91">302</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B5695999;--shiki-dark:#C98A7D99"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">/login</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">);</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">	const </span><span style="color:#B07D48;--shiki-dark:#BD976A">user</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#B07D48;--shiki-dark:#BD976A"> session</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">user</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">	// Now I want to check the user's teams, but it's not included in the session info!</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">	const </span><span style="color:#B07D48;--shiki-dark:#BD976A">teams</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#B07D48;--shiki-dark:#BD976A"> user</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">teams</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#A0ADA0;--shiki-dark:#758575DD"> // error!</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&#125;</span></span></code></pre><!-- HTML_TAG_END --><!-- HTML_TAG_START --><pre class="code-copy-target hidden">import type &#123; PageServerLoad &#125; from './$types'; // generated by SvelteKit
import &#123; redirect &#125; from '@sveltejs/kit';

export const load: PageServerLoad = async (&#123; locals, params &#125;) =&gt; &#123;
	const session = await locals.auth.validate(); // this
	if(null === session) throw redirect(302, '/login');
	const user = session.user;

	// Now I want to check the user's teams, but it's not included in the session info!
	const teams = user.teams; // error!
&#125;</pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-1qhrc72">Now that I‚Äôve used Lucia to <em>authenticate</em> the user, I want to check their team data to make sure they are <em>authorized</em> to view this page. The most straightforward way to do this would be to use Prisma from here. I could use the value of <code>session.user.id</code> to get the teams the user is in from the database. The problem with that approach is it requires a second round-trip request to the database, which has several downsides:</p> <ol data-svelte-h="svelte-h5xm4r"><li>Higher serverless function execution time, which increases costs</li> <li>More database queries also increases costs</li> <li>Longer backend execution times means it takes longer for the page to load, degrading the user experience</li> <li>The increase in database load would reduce how many concurrent users can be supported</li></ol> <p data-svelte-h="svelte-9kxdi1">Overall not a great solution! Instead, I want Lucia to grab the team with the user and session info in a single query, rather than making 2 (or even 3!) queries out to the database. I also need to tell Lucia what my desired user type is so it can provide type safety. Fortunately, this is all supported out of the box; no hacks necessarily!</p> <h3 id="modifying-the-auth-user-type-to-include-team-information" data-svelte-h="svelte-b5t0yt"><a aria-hidden="true" tabindex="-1" href="#modifying-the-auth-user-type-to-include-team-information"><span class="icon icon-link"></span></a><a href="#modifying-the-auth-user-type-to-include-team-information" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Modifying the auth <code>User</code> type to include team information</h3> <p data-svelte-h="svelte-8h2us4">I found the easiest way to go about updating Lucia‚Äôs auth <code>User</code> type to include teams is to re-run the <a href="https://lucia-auth.com/starter-guides/" rel="nofollow">Lucia starter guide</a> for my framework (SvelteKit). It looks like these changes are really similar for other frameworks too.</p> <p data-svelte-h="svelte-1lu47lr">First, I need to update the <code>app.d.ts</code> file to extend Lucia‚Äôs <code>DatabaseUserAttributes</code> to include the team data I want. I used Prisma to generate the typing for me:</p> <!-- HTML_TAG_START --><pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0" data-tsplay="https://typescriptlang.org/play/#code/PTAEEMAdIOgExgFwM4CgCWBbSB7AToqIgJ6QCmoA3qAAp7rKbgA0oAqsmXqAL6gBmeHJlAByAAKR6jcMADGAG3RkAdolEBuVHDKLweCgHMFOAEbgFVVAEgV4TGWSRwcigBkArnPTgr16yTkoACCHogAFqAAvKBYuAQAFKIAJEqmwJx4AG5cwApePqIAlDChEVr+IKCe3r4A7uBqyKDEOB5EOKBkAB6KHjpE4RSi6HCiEIiI9KZhZKymuuAenLHqzQYAjh7oBnA2AaQUACLgiODmnBxcwZPTs80xAPKY6IgAPFd4rCNjAHygADI-P5EGR7MgAFy0aRMGAAFTBmAAsmRMAs8ABxMiIGjgYgmcBwN6UdAqPo6KGUUH2KFTDxkHg8X4AbQAuhVrDwOYFjqdzuBOABlRzIdA4FQ3KboGagh5ULk2HioJVVOEACQAkoLQFqdUiaI8AEpw4IAOThoASLjk+DgpMMHUG7gKvjgODkyCKqB68UIlB4QA"><code><span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">// app.d.ts</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#1E754F;--shiki-dark:#4D9375"> type</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span><span style="color:#B07D48;--shiki-dark:#BD976A"> Prisma</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> User</span><span style="color:#999999;--shiki-dark:#666666"> &#125;</span><span style="color:#1E754F;--shiki-dark:#4D9375"> from</span><span style="color:#B5695999;--shiki-dark:#C98A7D99"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">@prisma/client</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">declare</span><span style="color:#B07D48;--shiki-dark:#BD976A"> global</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">	namespace</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> Lucia</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">		type</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> Auth</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#AB5959;--shiki-dark:#CB7676"> import</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#B56959;--shiki-dark:#C98A7D">$lib/server/lucia</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#393A34;--shiki-dark:#DBD7CAEE">.</span><span style="color:#2E8F82;--shiki-dark:#5DA994">Auth</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">		// Lucia wants you to exclude the 'id' attribute, because it's required</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">		type</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> DatabaseUserAttributes</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> Omit</span><span style="color:#999999;--shiki-dark:#666666">&#x3C;</span><span style="color:#2E8F82;--shiki-dark:#5DA994">User</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B5695999;--shiki-dark:#C98A7D99"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">id</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">></span><span style="color:#999999;--shiki-dark:#666666"> &#x26;</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">			teams</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#2E8F82;--shiki-dark:#5DA994">Prisma</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#2E8F82;--shiki-dark:#5DA994">TeamMemberGetPayload</span><span style="color:#999999;--shiki-dark:#666666">&#x3C;&#123;</span><span style="color:#B07D48;--shiki-dark:#BD976A">include</span><span style="color:#999999;--shiki-dark:#666666">: &#123;</span><span style="color:#B07D48;--shiki-dark:#BD976A">team</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#AB5959;--shiki-dark:#CB7676">true</span><span style="color:#999999;--shiki-dark:#666666">&#125;&#125;>[];</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">		&#125;;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">		type</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> DatabaseSessionAttributes</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#999999;--shiki-dark:#666666"> &#123;&#125;;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">	&#125;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&#125;</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">// THIS IS IMPORTANT (according to the Lucia docs)</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">export</span><span style="color:#999999;--shiki-dark:#666666"> &#123;&#125;</span></span></code></pre><!-- HTML_TAG_END --><!-- HTML_TAG_START --><pre class="code-copy-target hidden">// app.d.ts
import type &#123; Prisma, User &#125; from '@prisma/client';
declare global &#123;
	namespace Lucia &#123;
		type Auth = import('$lib/server/lucia').Auth;
		// Lucia wants you to exclude the 'id' attribute, because it's required
		type DatabaseUserAttributes = Omit&lt;User, 'id'&gt; & &#123;
			teams: Prisma.TeamMemberGetPayload&lt;&#123;include: &#123;team: true&#125;&#125;&gt;[];
		&#125;;
		type DatabaseSessionAttributes = &#123;&#125;;
	&#125;
&#125;
// THIS IS IMPORTANT (according to the Lucia docs)
export &#123;&#125;</pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-76z4wk">Two things of note here:</p> <ol data-svelte-h="svelte-uur5x1"><li>I used <code>Omit&lt;&gt;</code> to remove the <code>id</code> attribute from the <code>User</code> type Prisma generated from my data model because Lucia already knows that users have an <code>id</code>.</li> <li>The type of <code>Lucia.DatabaseUserAttributes.teams</code> is the result of getting a <code>TeamMember</code> entry (which defines the relation between a user and team) and including the <code>Team</code> with it. I made this an array by appending <code>[]</code> because a user can be in multiple teams.</li></ol> <h3 id="plumbing-the-team-data-into-lucia" data-svelte-h="svelte-naqrj9"><a aria-hidden="true" tabindex="-1" href="#plumbing-the-team-data-into-lucia"><span class="icon icon-link"></span></a><a href="#plumbing-the-team-data-into-lucia" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Plumbing the team data into Lucia</h3> <p data-svelte-h="svelte-13a86nr">By default, <a href="https://lucia-auth.com/database-adapters/prisma/" rel="nofollow">Lucia‚Äôs Prisma adapter</a> works great. Unfortunately, it doesn‚Äôt know how to perform the slightly more complex join query to get the team data I want with my users. Fortunately, there‚Äôs a great (experimental as of this writing) solution to this problem: <code>joinAdapters()</code>.</p> <p data-svelte-h="svelte-dxlpij">The default adapter works for everything I need <em>except</em> getting users. To fix that I use <code>joinAdapters()</code> to partially extend the default Prisma adapter. The change takes place in the <a href="https://lucia-auth.com/guidebook/sign-in-with-username-and-password/sveltekit/#configure-lucia" rel="nofollow">Lucia config</a> that I defined in <code>$lib/server/lucia.ts</code>. As an optimization, <a href="https://github.com/lucia-auth/lucia/blob/f4ce8ffbdf40e64d9c1475c6f0ef98cfcd709d3a/packages/lucia/src/auth/index.ts#L205" rel="nofollow"><code>Lucia</code> will try to use the provided adapter‚Äôs <code>getSessionAndUser()</code></a> to get both in a single query. If it‚Äôs not present, it will fall back to <code>getUser()</code>. To get the best performance in all cases, I override both.</p> <h4 id="writing-custom-getuser-and-getsessionanduser-functions" data-svelte-h="svelte-195zyb1"><a aria-hidden="true" tabindex="-1" href="#writing-custom-getuser-and-getsessionanduser-functions"><span class="icon icon-link"></span></a><a href="#writing-custom-getuser-and-getsessionanduser-functions" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Writing custom <code>getUser()</code> and <code>getSessionAndUser()</code> functions</h4> <p data-svelte-h="svelte-6gftyt">I started with <code>getUser()</code> because it‚Äôs simpler. I imported Lucia‚Äôs <code>Adapter</code> type to defines the function signature for <code>getUser()</code> and my Prisma client instance to perform the query within. Here‚Äôs how that all comes together:</p> <!-- HTML_TAG_START --><pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0" data-tsplay="https://typescriptlang.org/play/#code/PTAEBIBsEsCNgM4FMBOA3VxIFcDG0BDAOgBcEAoaAWwAcB7FE0EgTxqVAG9QAFFaBFQKgAvqABmKOlVAByAAI1+ggsFwwkAOxKyA3JVoMmrdl1ABBACYEaJVKIlSZsnPgJ6D9RmaUChDyWk5KDhEVAwUYF8VD3IQUDoI-ksOEgALDhTxAmxIJgBzJBIAVWQUUCoitLpLBM1mDNBo-wJrW3sSOlBoTXVsFIaObDLZBGYkAioKXDpNBAKi0vsAXlAACgIEFl714dQASUsASlBlgD4ucgBIGbmmPfLVggB3AmgmZuIHonEey2LNNAAI7YJBrTjXK7ISBIXAkABclyuyLskwQiO4PT6KQx40miJIKFBDhEABpIVdoJYCUSkOTkVckEJoJAaaD6cjcCgJnZLAB9ax2NlISFkyHxAAqjQQ7Hwv1woAezC6+RQBFgkOeGW5uKpiIeh1E1xER30V25JGwKHqDzNkrSAlA+WgGDGlWYbA4uAyuAA1j18qACJparAinZyj07JAYMg5iKTaAEAQSAJfkgxlYbBGANqyQolEYAXV0QA"><code><span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">// $lib/server/lucia.ts</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#1E754F;--shiki-dark:#4D9375"> type</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span><span style="color:#B07D48;--shiki-dark:#BD976A"> Prisma</span><span style="color:#999999;--shiki-dark:#666666"> &#125;</span><span style="color:#1E754F;--shiki-dark:#4D9375"> from</span><span style="color:#B5695999;--shiki-dark:#C98A7D99"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">@prisma/client</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#1E754F;--shiki-dark:#4D9375"> type</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span><span style="color:#B07D48;--shiki-dark:#BD976A"> Adapter</span><span style="color:#999999;--shiki-dark:#666666"> &#125;</span><span style="color:#1E754F;--shiki-dark:#4D9375"> from</span><span style="color:#B5695999;--shiki-dark:#C98A7D99"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">lucia</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span><span style="color:#B07D48;--shiki-dark:#BD976A"> prisma</span><span style="color:#999999;--shiki-dark:#666666"> &#125;</span><span style="color:#1E754F;--shiki-dark:#4D9375"> from</span><span style="color:#B5695999;--shiki-dark:#C98A7D99"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">$lib/server/prisma</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">// override the default getUser method on the prisma adapter to include the user's teams</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">const </span><span style="color:#B07D48;--shiki-dark:#BD976A">getUser</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#999999;--shiki-dark:#666666"> (</span><span style="color:#AB5959;--shiki-dark:#CB7676">async </span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">userId</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#999999;--shiki-dark:#666666"> =></span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">	const </span><span style="color:#B07D48;--shiki-dark:#BD976A">user</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#1E754F;--shiki-dark:#4D9375"> await</span><span style="color:#B07D48;--shiki-dark:#BD976A"> prisma</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">user</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">findUnique</span><span style="color:#999999;--shiki-dark:#666666">(&#123;</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">		select</span><span style="color:#999999;--shiki-dark:#666666">: &#123;</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">			teams</span><span style="color:#999999;--shiki-dark:#666666">: &#123; </span><span style="color:#998418;--shiki-dark:#B8A965">include</span><span style="color:#999999;--shiki-dark:#666666">: &#123; </span><span style="color:#998418;--shiki-dark:#B8A965">team</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#1E754F;--shiki-dark:#4D9375">true</span><span style="color:#999999;--shiki-dark:#666666"> &#125; &#125;,</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">			id</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#1E754F;--shiki-dark:#4D9375">true</span><span style="color:#999999;--shiki-dark:#666666">,</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">			email</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#1E754F;--shiki-dark:#4D9375">true</span><span style="color:#999999;--shiki-dark:#666666">,</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">			created_date</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#1E754F;--shiki-dark:#4D9375">true</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">		&#125;,</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">		// The specific user to grab</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">		where</span><span style="color:#999999;--shiki-dark:#666666">: &#123; </span><span style="color:#998418;--shiki-dark:#B8A965">id</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#B07D48;--shiki-dark:#BD976A">userId</span><span style="color:#999999;--shiki-dark:#666666"> &#125;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">	&#125;);</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">	return</span><span style="color:#B07D48;--shiki-dark:#BD976A"> user</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">	// This gives me type checking and better intellisense</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&#125;)</span><span style="color:#1E754F;--shiki-dark:#4D9375"> satisfies</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> Adapter</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#B56959;--shiki-dark:#C98A7D">getUser</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">];</span></span></code></pre><!-- HTML_TAG_END --><!-- HTML_TAG_START --><pre class="code-copy-target hidden">// $lib/server/lucia.ts
import type &#123; Prisma &#125; from '@prisma/client';
import type &#123; Adapter &#125; from 'lucia';
import &#123; prisma &#125; from '$lib/server/prisma';

// override the default getUser method on the prisma adapter to include the user's teams
const getUser = (async (userId) =&gt; &#123;
	const user = await prisma.user.findUnique(&#123;
		select: &#123;
			teams: &#123; include: &#123; team: true &#125; &#125;,
			id: true,
			email: true,
			created_date: true
		&#125;,
		// The specific user to grab
		where: &#123; id: userId &#125;
	&#125;);
	return user;
	// This gives me type checking and better intellisense
&#125;) satisfies Adapter['getUser'];</pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-1sbg726">Note that the value being assigned to <code>getUser</code> is wrapped in parentheses. This is so I can use the <code>satisfies</code> operator to provide a type constraint.</p> <p data-svelte-h="svelte-vnuoh7">Continuing on in the file I made <code>getSessionAndUser()</code>. This one is a little more complicated because the result needs to be a 2 element array: <code>[session, user]</code>. I ran into a couple gotchas here:</p> <ol data-svelte-h="svelte-hzjqf2"><li>If the session doesn‚Äôt exist, <code>getSessionAndUser()</code> should return <code>[null, null]</code></li> <li><a href="https://lucia-auth.com/database-adapters/prisma/#prisma-schema" rel="nofollow">Lucia‚Äôs models the Session‚Äôs <code>active_expires</code> and <code>idle_expires</code> as <code>BigInt</code>s</a>. I had to <a href="https://discord.com/channels/1004048134218981416/1164693156730773567/1164693156730773567" rel="nofollow">convert them to <code>number</code>s</a></li></ol> <!-- HTML_TAG_START --><pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0" data-tsplay="https://typescriptlang.org/play/#code/MYewdgzgLgBA5gUygZQRCBLcBBMATAVQgQCcYBeGACgEMIBPMYa49LMASTwEoKA+GAG8AUAEhQkWK0zgKMGgHcaGWAAcSGCAFsaAOmntdAMwz4CYDAEcArgiojRohQAtSCAFxCYGPJ4PguGABfABoxUVNgABtrPA8va2IST0FvJhi4lJgoBBotCCzIjPjUnLzPKBJbYJqg2rEg7gBuMQwjajBrKKiKckp-MF4SJGsSMBgAbU7ukJhpqIBdFtFhqFHxifCHR11dgbDHURpgKAwANwQAfQQAD1UMYYKYADlrLQAjUioB3WPTi+udweaG4B0cPiiV1u90enleHy+PwhUKBj244VC4R+iVIYiWYgA9ASYNg4MowLMoM5NN4IDAjCAyJ8oDkyFB6KoEDBgK5gABrUxwGAAMjSOW6mgQkC5EGsqlUjKgwkaMAgNFOEBMaBJeBoqlZEwA5IgUGgZGBcIQkoalkA"><code><span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">const </span><span style="color:#B07D48;--shiki-dark:#BD976A">getSessionAndUser</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#999999;--shiki-dark:#666666"> (</span><span style="color:#AB5959;--shiki-dark:#CB7676">async </span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">sessionId</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#999999;--shiki-dark:#666666"> =></span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">	const </span><span style="color:#B07D48;--shiki-dark:#BD976A">session</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#1E754F;--shiki-dark:#4D9375"> await</span><span style="color:#B07D48;--shiki-dark:#BD976A"> prisma</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">session</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">findUnique</span><span style="color:#999999;--shiki-dark:#666666">(&#123;</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">		where</span><span style="color:#999999;--shiki-dark:#666666">: &#123; </span><span style="color:#998418;--shiki-dark:#B8A965">id</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#B07D48;--shiki-dark:#BD976A">sessionId</span><span style="color:#999999;--shiki-dark:#666666"> &#125;,</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">		include</span><span style="color:#999999;--shiki-dark:#666666">: &#123; </span><span style="color:#998418;--shiki-dark:#B8A965">user</span><span style="color:#999999;--shiki-dark:#666666">: &#123; </span><span style="color:#998418;--shiki-dark:#B8A965">include</span><span style="color:#999999;--shiki-dark:#666666">: &#123; </span><span style="color:#998418;--shiki-dark:#B8A965">teams</span><span style="color:#999999;--shiki-dark:#666666">: &#123; </span><span style="color:#998418;--shiki-dark:#B8A965">include</span><span style="color:#999999;--shiki-dark:#666666">: &#123; </span><span style="color:#998418;--shiki-dark:#B8A965">team</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#1E754F;--shiki-dark:#4D9375">true</span><span style="color:#999999;--shiki-dark:#666666"> &#125; &#125; &#125; &#125; &#125;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">	&#125;);</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">	if</span><span style="color:#999999;--shiki-dark:#666666"> (</span><span style="color:#AB5959;--shiki-dark:#CB7676">null === </span><span style="color:#B07D48;--shiki-dark:#BD976A">session</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#1E754F;--shiki-dark:#4D9375"> return</span><span style="color:#999999;--shiki-dark:#666666"> [</span><span style="color:#AB5959;--shiki-dark:#CB7676">null</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#AB5959;--shiki-dark:#CB7676"> null</span><span style="color:#999999;--shiki-dark:#666666">];</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">	return</span><span style="color:#999999;--shiki-dark:#666666"> [</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">		&#123;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">			...</span><span style="color:#B07D48;--shiki-dark:#BD976A">session</span><span style="color:#999999;--shiki-dark:#666666">,</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">			active_expires</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#59873A;--shiki-dark:#80A665">Number</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">session</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">active_expires</span><span style="color:#999999;--shiki-dark:#666666">),</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">			idle_expires</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#59873A;--shiki-dark:#80A665">Number</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">session</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">idle_expires</span><span style="color:#999999;--shiki-dark:#666666">)</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">		&#125;,</span></span>
<span class="line"><span style="color:#B07D48;--shiki-dark:#BD976A">		session</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">user</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">	];</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">	// Again, this is for better type checking &#x26; intellisense support</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&#125;)</span><span style="color:#1E754F;--shiki-dark:#4D9375"> satisfies</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> Adapter</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#B56959;--shiki-dark:#C98A7D">getSessionAndUser</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">];</span></span></code></pre><!-- HTML_TAG_END --><!-- HTML_TAG_START --><pre class="code-copy-target hidden">const getSessionAndUser = (async (sessionId) =&gt; &#123;
	const session = await prisma.session.findUnique(&#123;
		where: &#123; id: sessionId &#125;,
		include: &#123; user: &#123; include: &#123; teams: &#123; include: &#123; team: true &#125; &#125; &#125; &#125; &#125;
	&#125;);
	if (null === session) return [null, null];
	return [
		&#123;
			...session,
			active_expires: Number(session.active_expires),
			idle_expires: Number(session.idle_expires)
		&#125;,
		session.user
	];
	// Again, this is for better type checking & intellisense support
&#125;) satisfies Adapter['getSessionAndUser'];</pre><!-- HTML_TAG_END --> <h4 id="tying-it-all-together-in-the-lucia-config" data-svelte-h="svelte-8r7c0z"><a aria-hidden="true" tabindex="-1" href="#tying-it-all-together-in-the-lucia-config"><span class="icon icon-link"></span></a><a href="#tying-it-all-together-in-the-lucia-config" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Tying it all together in the Lucia config</h4> <p data-svelte-h="svelte-1cqaggm">With the two overrides written, all that remains is to bring it all together in the Lucia config!</p> <p data-svelte-h="svelte-6ocsoj">To do this, I used the (currently experimental) <code>joinAdapters()</code> utility that Lucia provides. It‚Äôs pretty straightforward:</p> <ol data-svelte-h="svelte-1vuonsc"><li>Pass it the first adapter to use</li> <li>Pass an object with the Adapter methods to override</li></ol> <p data-svelte-h="svelte-1h9a37g">Tying it all together, I have the following Lucia config:</p> <!-- HTML_TAG_START --><pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0" data-tsplay="https://typescriptlang.org/play/#code/JYWwDg9gTgLgBAbzgGwK4GNgEMA0cYCeYApnAIIAmWYMxUcAvnAGZQQhwDkamWnA3AChQkWIjgBnAG7FktANbB4TVuy49sAehDAKFZMQDuWKMQHDw0eEgrEpjFmw6cAJNTCbiAOynA2XkG8YcxErcTAoYAkQLDgsCTgABUjorEpqWnoVJy4AAQ0sAFosVBgAC00sKho6QoiomJDLMSR61IdVZxdkYAAjTQk6GShNNsahUJa4AH1p4gAPEkjArxgsZGmAKwhgL3SaqAT4uG3d-cyE7LVuDC1S4GQJc0FNTXwoVC90LFoKFmg4L1TL5CIJ0BAvBJ4ABzYgwACqg3oAF44AAKAB0WIAlJIflFmMBiAlznQANqcWEIpGcAC6QnBkJhcIAysSJMAIWQvBREXQ4KjMTi8TACUSSdVMhSqWyJByuTy+VA6UIXm8ACplUgAGVusUZhOhggWongjKhcVKZQFKD1aIQggAkN4pAAuOC2ewAfi4ABEAKIANU4cHdnESACUAPK+zg4J06PQGYymd3SWQKJRo7Hxx2vE47PaSugJGLyYlwJRwSByvoGfAQOAQYaRWzVkwwBIQZj4LUe4jMEpyOAAA2SDTSxagI6dVQydHdpyL88OaKdjvHqVJUDRY1wiHXjtQSLDx7occP5YIYavF8d98GtYhYcf8q8nHXDBz6-zmqicAAIjnA4AKbXpNmIdB4DKY5ylIZs6FbCsYEbKl8GILAQASQwlGtOC4DPKB1yQKklTwGV2U5PZFSRRgnW-R1SKRMgYBgSJelKYl3TRQi4E0AAqd0lRZdAtRifjNFxZEAD4D3vfMR2E0TiBiEdq1QZBHkrLxe1IEdaEwiQ1MJWQ-gASTiPRiD+XY4jAMAMQoDFO3XUwYFQKAdMIoRHQYQQvyEE0wkIEhyCtG0QuIbtLXKfggA"><code><span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span><span style="color:#B07D48;--shiki-dark:#BD976A"> lucia</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#1E754F;--shiki-dark:#4D9375"> type</span><span style="color:#B07D48;--shiki-dark:#BD976A"> Adapter</span><span style="color:#999999;--shiki-dark:#666666"> &#125;</span><span style="color:#1E754F;--shiki-dark:#4D9375"> from</span><span style="color:#B5695999;--shiki-dark:#C98A7D99"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">lucia</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span><span style="color:#B07D48;--shiki-dark:#BD976A"> sveltekit</span><span style="color:#999999;--shiki-dark:#666666"> &#125;</span><span style="color:#1E754F;--shiki-dark:#4D9375"> from</span><span style="color:#B5695999;--shiki-dark:#C98A7D99"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">lucia/middleware</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span><span style="color:#B07D48;--shiki-dark:#BD976A"> dev</span><span style="color:#999999;--shiki-dark:#666666"> &#125;</span><span style="color:#1E754F;--shiki-dark:#4D9375"> from</span><span style="color:#B5695999;--shiki-dark:#C98A7D99"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">$app/environment</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span><span style="color:#B07D48;--shiki-dark:#BD976A"> prisma</span><span style="color:#1E754F;--shiki-dark:#4D9375"> as</span><span style="color:#B07D48;--shiki-dark:#BD976A"> PrismaAdapter</span><span style="color:#999999;--shiki-dark:#666666"> &#125;</span><span style="color:#1E754F;--shiki-dark:#4D9375"> from</span><span style="color:#B5695999;--shiki-dark:#C98A7D99"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">@lucia-auth/adapter-prisma</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span><span style="color:#B07D48;--shiki-dark:#BD976A"> prisma</span><span style="color:#999999;--shiki-dark:#666666"> &#125;</span><span style="color:#1E754F;--shiki-dark:#4D9375"> from</span><span style="color:#B5695999;--shiki-dark:#C98A7D99"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">$lib/server/prisma</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span><span style="color:#B07D48;--shiki-dark:#BD976A"> __experimental_joinAdapters</span><span style="color:#1E754F;--shiki-dark:#4D9375"> as</span><span style="color:#B07D48;--shiki-dark:#BD976A"> joinAdapters</span><span style="color:#999999;--shiki-dark:#666666"> &#125;</span><span style="color:#1E754F;--shiki-dark:#4D9375"> from</span><span style="color:#B5695999;--shiki-dark:#C98A7D99"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">lucia/utils</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">// truncated for brevity</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">const </span><span style="color:#B07D48;--shiki-dark:#BD976A">getUser</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#999999;--shiki-dark:#666666"> (...)</span><span style="color:#1E754F;--shiki-dark:#4D9375"> satisfies</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> Adapter</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#B56959;--shiki-dark:#C98A7D">getUser</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">];</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">const </span><span style="color:#B07D48;--shiki-dark:#BD976A">getSessionAndUser</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#999999;--shiki-dark:#666666"> (...)</span><span style="color:#1E754F;--shiki-dark:#4D9375"> satisfies</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> Adapter</span><span style="color:#999999;--shiki-dark:#666666">[</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#B56959;--shiki-dark:#C98A7D">getSessionAndUser</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">// The Lucia config</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">export</span><span style="color:#AB5959;--shiki-dark:#CB7676"> const </span><span style="color:#B07D48;--shiki-dark:#BD976A">auth</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#59873A;--shiki-dark:#80A665"> lucia</span><span style="color:#999999;--shiki-dark:#666666">(&#123;</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">	env</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#B07D48;--shiki-dark:#BD976A">dev</span><span style="color:#AB5959;--shiki-dark:#CB7676"> ?</span><span style="color:#B5695999;--shiki-dark:#C98A7D99"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">DEV</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#AB5959;--shiki-dark:#CB7676"> :</span><span style="color:#B5695999;--shiki-dark:#C98A7D99"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">PROD</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">,</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">	middleware</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#59873A;--shiki-dark:#80A665">sveltekit</span><span style="color:#999999;--shiki-dark:#666666">(),</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">	// joinAdapters makes it possible to override parts of the default &#96;PrismaAdapter&#96;</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">	adapter</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#59873A;--shiki-dark:#80A665">joinAdapters</span><span style="color:#999999;--shiki-dark:#666666">(</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">		PrismaAdapter</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">prisma</span><span style="color:#999999;--shiki-dark:#666666">, &#123;</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">			user</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#B56959;--shiki-dark:#C98A7D">user</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">,</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">			key</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#B56959;--shiki-dark:#C98A7D">key</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">,</span></span>
<span class="line"><span style="color:#998418;--shiki-dark:#B8A965">			session</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#B56959;--shiki-dark:#C98A7D">session</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">		&#125;),</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">		// This "adapter" object has the overrides to get teams with the user</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">		&#123; </span><span style="color:#B07D48;--shiki-dark:#BD976A">getUser</span><span style="color:#999999;--shiki-dark:#666666">, </span><span style="color:#B07D48;--shiki-dark:#BD976A">getSessionAndUser</span><span style="color:#999999;--shiki-dark:#666666"> &#125;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">	),</span></span>
<span class="line"><span style="color:#59873A;--shiki-dark:#80A665">	getUserAttributes</span><span style="color:#999999;--shiki-dark:#666666">: (</span><span style="color:#B07D48;--shiki-dark:#BD976A">user</span><span style="color:#A0ADA0;--shiki-dark:#758575DD"> /*: UserSchema*/</span><span style="color:#999999;--shiki-dark:#666666">) => &#123;</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">		// &#96;UserSchema&#96; pulls in the &#96;teams&#96; field I added in app.d.ts</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">		return</span><span style="color:#B07D48;--shiki-dark:#BD976A"> user</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">	&#125;</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&#125;);</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">export</span><span style="color:#AB5959;--shiki-dark:#CB7676"> type</span><span style="color:#2E8F82;--shiki-dark:#5DA994"> Auth</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#AB5959;--shiki-dark:#CB7676"> typeof</span><span style="color:#B07D48;--shiki-dark:#BD976A"> auth</span><span style="color:#999999;--shiki-dark:#666666">;</span></span></code></pre><!-- HTML_TAG_END --><!-- HTML_TAG_START --><pre class="code-copy-target hidden">import &#123; lucia, type Adapter &#125; from 'lucia';
import &#123; sveltekit &#125; from 'lucia/middleware';
import &#123; dev &#125; from '$app/environment';
import &#123; prisma as PrismaAdapter &#125; from '@lucia-auth/adapter-prisma';
import &#123; prisma &#125; from '$lib/server/prisma';
import &#123; __experimental_joinAdapters as joinAdapters &#125; from 'lucia/utils';

// truncated for brevity
const getUser = (...) satisfies Adapter['getUser'];
const getSessionAndUser = (...) satisfies Adapter['getSessionAndUser'];

// The Lucia config
export const auth = lucia(&#123;
	env: dev ? 'DEV' : 'PROD',
	middleware: sveltekit(),
	// joinAdapters makes it possible to override parts of the default &#96;PrismaAdapter&#96;
	adapter: joinAdapters(
		PrismaAdapter(prisma, &#123;
			user: 'user',
			key: 'key',
			session: 'session'
		&#125;),
		// This "adapter" object has the overrides to get teams with the user
		&#123; getUser, getSessionAndUser &#125;
	),
	getUserAttributes: (user /*: UserSchema*/) =&gt; &#123;
		// &#96;UserSchema&#96; pulls in the &#96;teams&#96; field I added in app.d.ts
		return user;
	&#125;
&#125;);
export type Auth = typeof auth;</pre><!-- HTML_TAG_END --> <h3 id="accessing-the-users-team-data-provided-by-lucia" data-svelte-h="svelte-14a17q4"><a aria-hidden="true" tabindex="-1" href="#accessing-the-users-team-data-provided-by-lucia"><span class="icon icon-link"></span></a><a href="#accessing-the-users-team-data-provided-by-lucia" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Accessing the user‚Äôs team data provided by Lucia</h3> <p data-svelte-h="svelte-4vewjo">Now that Lucia knows how to get the team data, I can access it easily via <code>(await locals.auth.validate()).user.teams</code> in my SvelteKit page load functions and server endpoints. Going back to the code example from the start of this section on extending Lucia types to include teams, it now works the way I wanted! Check it out:</p> <!-- HTML_TAG_START --><pre class="shiki shiki-themes vitesse-light vitesse-dark" style="background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee" tabindex="0" data-tsplay="https://typescriptlang.org/play/#code/PTAECcHsFcBcFMDOwDaCCGBbAkgEwLrADUADugObwB0i84AbnVbIgFACWmJk4sosATxLxQAb1AAFCvADKdRuAAykdLlABfUADMomUAHIqwACSDhifQG5QIUJQB2ddAjUAjAaBmMANggDS7LAcXDx84uDwuOwRAMZ8mjqQevoAAog+CABWyADWgVasrPAAHty8oDGQ9oh83iq4AFyS0nIMdMqqoAC8oOiIAvYxoAAU4nUx6N6IADSgZOBYiBoAlN0AfGKsAJCV1Xy0iIjsVd29AO7ogaDjk4hU6HAAFlT0k+y4zvDDy9a2sI-sNhbdhaYb2aDebzdLo9A5HKqrf5QM4QSLReBxYYAZgADAAmWb6YB1cjsez6H7bXY1UDQWjgU5w472Kh0uiWQpbWwAOUgKP+IjZ4H0SwwmCW6AioDJMW80FwkWl9n4jxETJOZK0kAAhFSqjSxUsekLmPBFr8wGceDklvY+brgVoRoaqFoybhhmL1vwzZgqO9oT15otTVg8KsYcb7Aq3Y5cMtRNsuWBoPYHv8eOwAF6Rbbqba2AAqqtp9OlS0Q0BI3FoalgkFArhEqoiuvUQA"><code><span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">// routes/[teamId]/+page.server.ts</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#1E754F;--shiki-dark:#4D9375"> type</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span><span style="color:#B07D48;--shiki-dark:#BD976A"> PageServerLoad</span><span style="color:#999999;--shiki-dark:#666666"> &#125;</span><span style="color:#1E754F;--shiki-dark:#4D9375"> from</span><span style="color:#B5695999;--shiki-dark:#C98A7D99"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">./$types</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#A0ADA0;--shiki-dark:#758575DD"> // generated by SvelteKit</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">import</span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span><span style="color:#B07D48;--shiki-dark:#BD976A"> redirect</span><span style="color:#999999;--shiki-dark:#666666"> &#125;</span><span style="color:#1E754F;--shiki-dark:#4D9375"> from</span><span style="color:#B5695999;--shiki-dark:#C98A7D99"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">@sveltejs/kit</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">export</span><span style="color:#AB5959;--shiki-dark:#CB7676"> const </span><span style="color:#59873A;--shiki-dark:#80A665">load</span><span style="color:#999999;--shiki-dark:#666666">: </span><span style="color:#2E8F82;--shiki-dark:#5DA994">PageServerLoad</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#AB5959;--shiki-dark:#CB7676"> async </span><span style="color:#999999;--shiki-dark:#666666">(&#123;</span><span style="color:#B07D48;--shiki-dark:#BD976A"> locals</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B07D48;--shiki-dark:#BD976A"> params</span><span style="color:#999999;--shiki-dark:#666666"> &#125;)</span><span style="color:#999999;--shiki-dark:#666666"> =></span><span style="color:#999999;--shiki-dark:#666666"> &#123;</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">	const </span><span style="color:#B07D48;--shiki-dark:#BD976A">session</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#1E754F;--shiki-dark:#4D9375"> await</span><span style="color:#B07D48;--shiki-dark:#BD976A"> locals</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">auth</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">validate</span><span style="color:#999999;--shiki-dark:#666666">();</span><span style="color:#A0ADA0;--shiki-dark:#758575DD"> // this</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">	if</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#AB5959;--shiki-dark:#CB7676">null === </span><span style="color:#B07D48;--shiki-dark:#BD976A">session</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#1E754F;--shiki-dark:#4D9375"> throw</span><span style="color:#59873A;--shiki-dark:#80A665"> redirect</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#2F798A;--shiki-dark:#4C9A91">302</span><span style="color:#999999;--shiki-dark:#666666">,</span><span style="color:#B5695999;--shiki-dark:#C98A7D99"> '</span><span style="color:#B56959;--shiki-dark:#C98A7D">/login</span><span style="color:#B5695999;--shiki-dark:#C98A7D99">'</span><span style="color:#999999;--shiki-dark:#666666">);</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">	const </span><span style="color:#B07D48;--shiki-dark:#BD976A">user</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#B07D48;--shiki-dark:#BD976A"> session</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">user</span><span style="color:#999999;--shiki-dark:#666666">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">	// Now the user's teams are included in the session info!</span></span>
<span class="line"><span style="color:#AB5959;--shiki-dark:#CB7676">	const </span><span style="color:#B07D48;--shiki-dark:#BD976A">teams</span><span style="color:#999999;--shiki-dark:#666666"> =</span><span style="color:#B07D48;--shiki-dark:#BD976A"> user</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">teams</span><span style="color:#999999;--shiki-dark:#666666">;</span><span style="color:#A0ADA0;--shiki-dark:#758575DD"> // works now!</span></span>
<span class="line"><span style="color:#1E754F;--shiki-dark:#4D9375">	if</span><span style="color:#999999;--shiki-dark:#666666"> (</span><span style="color:#B07D48;--shiki-dark:#BD976A">teams</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#59873A;--shiki-dark:#80A665">find</span><span style="color:#999999;--shiki-dark:#666666">(</span><span style="color:#B07D48;--shiki-dark:#BD976A">team</span><span style="color:#999999;--shiki-dark:#666666"> =></span><span style="color:#B07D48;--shiki-dark:#BD976A"> team</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">id</span><span style="color:#AB5959;--shiki-dark:#CB7676"> === </span><span style="color:#B07D48;--shiki-dark:#BD976A">params</span><span style="color:#999999;--shiki-dark:#666666">.</span><span style="color:#B07D48;--shiki-dark:#BD976A">teamId</span><span style="color:#999999;--shiki-dark:#666666">)</span><span style="color:#AB5959;--shiki-dark:#CB7676"> === undefined</span><span style="color:#999999;--shiki-dark:#666666">)&#123;</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">		// unauthorized</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">	&#125;</span></span>
<span class="line"><span style="color:#A0ADA0;--shiki-dark:#758575DD">	// The user is supposed to be here!</span></span>
<span class="line"><span style="color:#999999;--shiki-dark:#666666">&#125;</span></span></code></pre><!-- HTML_TAG_END --><!-- HTML_TAG_START --><pre class="code-copy-target hidden">// routes/[teamId]/+page.server.ts
import type &#123; PageServerLoad &#125; from './$types'; // generated by SvelteKit
import &#123; redirect &#125; from '@sveltejs/kit';

export const load: PageServerLoad = async (&#123; locals, params &#125;) =&gt; &#123;
	const session = await locals.auth.validate(); // this
	if(null === session) throw redirect(302, '/login');
	const user = session.user;

	// Now the user's teams are included in the session info!
	const teams = user.teams; // works now!
	if (teams.find(team =&gt; team.id === params.teamId) === undefined)&#123;
		// unauthorized
	&#125;
	// The user is supposed to be here!
&#125;</pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-1xbw4kv">Now when I use Lucia to authenticate user sessions, I also get the data I need to make sure the user is authorized. Awesome!</p> <h2 id="conclusion" data-svelte-h="svelte-19f5w1q"><a aria-hidden="true" tabindex="-1" href="#conclusion"><span class="icon icon-link"></span></a><a href="#conclusion" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Conclusion</h2> <p data-svelte-h="svelte-1pl11sg">I hope this is helpful to you in adding support for teams (or anything else!) to your SaaS!</p> <p data-svelte-h="svelte-tiex6i">This article was a lot of fun to write, and I ended up learning and improving my code a lot in the process. I have really enjoyed building with Lucia, SvelteKit, and Prisma. With any luck, this article has helped you get excited to go build something with them too!</p> <div class="divider"></div> <aside class="prose" data-svelte-h="svelte-1w3uusp"> <p>If you&#39;re feeling extra generous, you can show your support by buying me a
			coffee with the button in the bottom right corner of the page.</p> <div class="divider"></div></aside></article>     <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css" integrity="sha384-KiWOvVjnN8qwAZbuQyWDIbfCLFhLXNETzBQjA/92pIowpC0d2O3nppDGQVgwd2nB" crossorigin="anonymous"></div></div>  
			
			<script>
				{
					__sveltekit_1yes74m = {
						base: new URL("..", location).pathname.slice(0, -1),
						env: {"PUBLIC_SUPABASE_ANON_KEY":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlb3ZmZXRyaXNyZnFpZWF0bXp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE2ODcwNjM0NTYsImV4cCI6MjAwMjYzOTQ1Nn0.s9KXOQ0gDdl7e3lTUxdN5yfPI0rLZ-dSRMfEwoHhK00","PUBLIC_SUPABASE_URL":"https://aeovfetrisrfqieatmzw.supabase.co"}
					};

					const element = document.currentScript.parentElement;

					const data = [{"type":"data","data":{session:null,user:null},"uses":{}},null];

					Promise.all([
						import("../_app/immutable/entry/start.f195b3cc.js"),
						import("../_app/immutable/entry/app.b1f7e12b.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 6],
							data,
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
