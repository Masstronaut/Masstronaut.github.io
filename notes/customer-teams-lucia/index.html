<!DOCTYPE html>
<html lang="en" data-theme="">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="../../favicon.png" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<link href="../../_app/immutable/assets/0.c0915e16.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/NoteGridStatusFilter.d210e4e4.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/13.1d26afe6.css" rel="stylesheet">
		<link href="../../_app/immutable/assets/LoadNote.61812917.css" rel="stylesheet">
		<link rel="modulepreload" href="../../_app/immutable/entry/start.4f4ab6fe.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/scheduler.95003110.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/singletons.273f653a.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/paths.0192b7f2.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/parse.bee59afc.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/control.f5b05b5f.js">
		<link rel="modulepreload" href="../../_app/immutable/entry/app.af9bb739.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/preload-helper.41c905a7.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/index.46e80ea9.js">
		<link rel="modulepreload" href="../../_app/immutable/nodes/0.5c6e7eaa.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/each.fce2738d.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/index.45b59163.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/navigation.4817b946.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/toast.a91ab4a0.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/spread.8a54911c.js">
		<link rel="modulepreload" href="../../_app/immutable/nodes/13.3505937f.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/LoadNote.677f0975.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/index.a2bcfa65.js">
		<link rel="modulepreload" href="../../_app/immutable/chunks/stores.2ed3d0b5.js"><title>Adding users to new teams with Lucia auth and Prisma - Allan Deutsch</title><!-- HEAD_svelte-n5ip0u_START --><meta name="description" content="When building a B2B product, most customers will want to invite their team members. This post explores how I added support for that to Penguinsight, a user feedback SaaS I'm building."><meta property="og:title" content="Adding users to new teams with Lucia auth and Prisma"><meta property="og:type" content="article"><meta property="og:url" content="https://allandeutsch.com/notes/customer-teams-lucia"><meta property="og:description" content="When building a B2B product, most customers will want to invite their team members. This post explores how I added support for that to Penguinsight, a user feedback SaaS I'm building."><meta property="og:locale" content="en_US"><meta property="twitter:card" content="summary"><meta property="twitter:url" content="https://allandeutsch.com"><meta property="twitter:title" content="Adding users to new teams with Lucia auth and Prisma"><meta property="twitter:description" content="When building a B2B product, most customers will want to invite their team members. This post explores how I added support for that to Penguinsight, a user feedback SaaS I'm building."><meta property="twitter:site" content="@AllanDeutsch"><meta property="twitter:creator" content="@AllanDeutsch"><link rel="canonical" href="https://allandeutsch.com/notes/customer-teams-lucia"><script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="AllanDeutsch" data-description="Support me on Buy me a coffee!" data-message="" data-color="#5F7FFF" data-position="Right" data-x_margin="18" data-y_margin="18" data-svelte-h="svelte-bv2cpr"></script><!-- HEAD_svelte-n5ip0u_END -->
		<!-- Global site tag (gtag.js) - Google Analytics -->
		<script
			async
			src="https://www.googletagmanager.com/gtag/js?id=UA-86124920-1"></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag() {
				dataLayer.push(arguments);
			}
			gtag('js', new Date());

			gtag('config', 'UA-86124920-1');
		</script>
		<script src="https://www.penguinsight.com/thumbs.js" type="module"></script>
	</head>
	<body data-sveltekit-preload-data="hover" class="bg-base-100">
		<div style="display: contents">  <div class="toaster  svelte-jyff3d"> </div> <div class="navbar bg-base-100"><div class="navbar-start"><div class="dropdown"><button tabindex="0" class="btn-ghost btn sm:hidden" data-svelte-h="svelte-1h8jdop"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h8m-8 6h16"></path></svg></button> <ul tabindex="0" class="dropdown-content menu rounded-box menu-sm mt-3 w-52 bg-base-100 p-2 shadow"><li><a href="/">Home</a></li><li><a href="/notes">Notes</a></li></ul></div> <a class="btn-ghost btn text-xl normal-case" href="/">Allan Deutsch</a></div> <div class="navbar-center hidden sm:flex"><ul class="menu menu-horizontal px-1 text-base"><li><a href="/">Home</a></li><li><a href="/notes">Notes</a></li></ul></div> <div class="navbar-end"> <div class="h-8" data-svelte-h="svelte-b95tle"><a href="https://twitter.com/AllanDeutsch" class="group"><svg height="24" width="24" class="mr-1.5 inline transition-colors duration-300 group-hover:fill-primary" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612"><path d="M612 116.258a250.714 250.714 0 01-72.088 19.772c25.929-15.527 45.777-40.155 55.184-69.411-24.322 14.379-51.169 24.82-79.775 30.48-22.907-24.437-55.49-39.658-91.63-39.658-69.334 0-125.551 56.217-125.551 125.513 0 9.828 1.109 19.427 3.251 28.606-104.326-5.24-196.835-55.223-258.75-131.174-10.823 18.51-16.98 40.078-16.98 63.101 0 43.559 22.181 81.993 55.835 104.479a125.556 125.556 0 01-56.867-15.756v1.568c0 60.806 43.291 111.554 100.693 123.104-10.517 2.83-21.607 4.398-33.08 4.398-8.107 0-15.947-.803-23.634-2.333 15.985 49.907 62.336 86.199 117.253 87.194-42.947 33.654-97.099 53.655-155.916 53.655-10.134 0-20.116-.612-29.944-1.721 55.567 35.681 121.536 56.485 192.438 56.485 230.948 0 357.188-191.291 357.188-357.188l-.421-16.253c24.666-17.593 46.005-39.697 62.794-64.861z"></path></svg></a> <a href="https://github.com/masstronaut" class="group"><svg height="24" aria-hidden="true" viewBox="0 0 16 16" version="1.1" width="24" data-view-component="true" class="mr-1.5 inline transition-colors duration-300 group-hover:fill-primary"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg></a></div> </div></div> <div class="p-1 sm:p-4"> <article class="note-container prose mb-8 max-w-full svelte-564mcj"><header class="w-full max-w-3xl self-center"><h1 class="mb-8 text-left text-4xl font-bold">Adding users to new teams with Lucia auth and Prisma</h1> <div class="text-md mb-12 mt-4 flex justify-between border-t border-t-neutral border-opacity-20 pt-1 text-base-content"><div><span class="pr-2" data-svelte-h="svelte-114jejz">🌱</span><span class="hidden sm:inline" data-svelte-h="svelte-1psjisz">Planted
				</span>October 16, 2023.
				<br>Last tended October 22, 2023.</div> <div class="flex flex-col items-end"><div class="note__status seedling svelte-564mcj">seedling 🌱</div> <div>1 minute read ⏱</div></div></div></header>  <p data-svelte-h="svelte-1sz3ogs">Recently I’ve been building <a href="https://penguinsight.com" rel="nofollow">Penguinsight</a>, a user feedback platform. I wanted to add support for teams so that a customer can invite their coworkers to also participate. Multiple people from a team/company wanting access to the software is a really common scenario in B2B. For Penguinsight, I anticipate that an analyst or PM will want to view data in the dashboard and share it with their team. Plus they will want an engineer to do the integration work. In this post, I’m going to explain how I added support for teams and wired up that information in the auth library I’m using, <a href="https://lucia-auth.com/" rel="nofollow">Lucia-auth</a> so that when accessing a user’s session I also get the information about teams they are on.</p> <h2 id="updating-the-database-with-tables-for-auth-and-teams" data-svelte-h="svelte-18yhcry"><a aria-hidden="true" tabindex="-1" href="#updating-the-database-with-tables-for-auth-and-teams"><span class="icon icon-link"></span></a><a href="#updating-the-database-with-tables-for-auth-and-teams" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Updating the database with tables for auth and teams</h2> <p data-svelte-h="svelte-1h26wko">First, I needed to add the relevant tables and fields to my database to support auth &amp; teams. I’m using <code>prisma</code>, so the following is what I’ve added to my <code>schema.prisma</code> file to support the <a href="https://lucia-auth.com/database-adapters/prisma/#prisma-schema" rel="nofollow">fields needed for Lucia</a>  and to add support for teams.</p> <!-- HTML_TAG_START --><pre class="shiki" style="background-color: #ffffff; color: #24292f" prisma="true"><div class="language-id">prisma</div><div class='code-container'><code><div class='line'><span style="color: #6E7781">// This describes a user's role in a team.</span></div><div class='line'><span style="color: #CF222E">enum</span><span style="color: #24292F"> </span><span style="color: #953800">Role</span><span style="color: #24292F"> &#123;</span></div><div class='line'><span style="color: #24292F">	admin</span></div><div class='line'><span style="color: #24292F">	user</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #8250DF">@@map</span><span style="color: #24292F">(</span><span style="color: #0A3069">"role"</span><span style="color: #24292F">)</span></div><div class='line'><span style="color: #24292F">&#125;</span></div><div class='line'></div><div class='line'><span style="color: #CF222E">model</span><span style="color: #24292F"> </span><span style="color: #953800">User</span><span style="color: #24292F"> &#123;</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #6E7781">// These 3 fields are the User model defined by Lucia</span></div><div class='line'><span style="color: #24292F">	id </span><span style="color: #0550AE">String</span><span style="color: #24292F"> </span><span style="color: #8250DF">@id</span><span style="color: #24292F"> </span><span style="color: #8250DF">@unique</span></div><div class='line'><span style="color: #24292F">	auth_session </span><span style="color: #0550AE">Session</span><span style="color: #CF222E">[]</span></div><div class='line'><span style="color: #24292F">	key </span><span style="color: #0550AE">Key</span><span style="color: #CF222E">[]</span></div><div class='line'></div><div class='line'><span style="color: #24292F">	</span><span style="color: #6E7781">// These are additional fields I want</span></div><div class='line'><span style="color: #24292F">	email </span><span style="color: #0550AE">String</span><span style="color: #24292F"> </span><span style="color: #8250DF">@unique</span></div><div class='line'><span style="color: #24292F">	created_date </span><span style="color: #0550AE">DateTime</span></div><div class='line'></div><div class='line'><span style="color: #24292F">	</span><span style="color: #6E7781">// This defines a relation to the TeamMember table where a user can be a member of multiple teams </span></div><div class='line'><span style="color: #24292F">	teams </span><span style="color: #0550AE">TeamMember</span><span style="color: #CF222E">[]</span></div><div class='line'><span style="color: #24292F">&#125;</span></div><div class='line'></div><div class='line'><span style="color: #24292F">  </span></div><div class='line'><span style="color: #6E7781">// The  Session model defined by Lucia</span></div><div class='line'><span style="color: #CF222E">model</span><span style="color: #24292F"> </span><span style="color: #953800">Session</span><span style="color: #24292F"> &#123;</span></div><div class='line'><span style="color: #24292F">	id </span><span style="color: #0550AE">String</span><span style="color: #24292F"> </span><span style="color: #8250DF">@id</span><span style="color: #24292F"> </span><span style="color: #8250DF">@unique</span></div><div class='line'><span style="color: #24292F">	user_id </span><span style="color: #0550AE">String</span></div><div class='line'><span style="color: #24292F">	active_expires </span><span style="color: #0550AE">BigInt</span></div><div class='line'><span style="color: #24292F">	idle_expires </span><span style="color: #0550AE">BigInt</span></div><div class='line'><span style="color: #24292F">	user </span><span style="color: #0550AE">User</span><span style="color: #24292F"> </span><span style="color: #8250DF">@relation</span><span style="color: #24292F">(</span><span style="color: #953800">fields</span><span style="color: #24292F">: [</span><span style="color: #0550AE">user_id</span><span style="color: #24292F">], </span><span style="color: #953800">references</span><span style="color: #24292F">: [</span><span style="color: #0550AE">id</span><span style="color: #24292F">], </span><span style="color: #953800">onDelete</span><span style="color: #24292F">: </span><span style="color: #0550AE">Cascade</span><span style="color: #24292F">)</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #8250DF">@@index</span><span style="color: #24292F">([</span><span style="color: #0550AE">user_id</span><span style="color: #24292F">])</span></div><div class='line'><span style="color: #24292F">&#125;</span></div><div class='line'></div><div class='line'><span style="color: #6E7781">// The Key model defined by Lucia</span></div><div class='line'><span style="color: #CF222E">model</span><span style="color: #24292F"> </span><span style="color: #953800">Key</span><span style="color: #24292F"> &#123;</span></div><div class='line'><span style="color: #24292F">	id </span><span style="color: #0550AE">String</span><span style="color: #24292F"> </span><span style="color: #8250DF">@id</span><span style="color: #24292F"> </span><span style="color: #8250DF">@unique</span></div><div class='line'><span style="color: #24292F">	hashed_password </span><span style="color: #0550AE">String</span><span style="color: #CF222E">?</span></div><div class='line'><span style="color: #24292F">	user_id </span><span style="color: #0550AE">String</span></div><div class='line'><span style="color: #24292F">	user </span><span style="color: #0550AE">User</span><span style="color: #24292F"> </span><span style="color: #8250DF">@relation</span><span style="color: #24292F">(</span><span style="color: #953800">fields</span><span style="color: #24292F">: [</span><span style="color: #0550AE">user_id</span><span style="color: #24292F">], </span><span style="color: #953800">references</span><span style="color: #24292F">: [</span><span style="color: #0550AE">id</span><span style="color: #24292F">], </span><span style="color: #953800">onDelete</span><span style="color: #24292F">: </span><span style="color: #0550AE">Cascade</span><span style="color: #24292F">)</span></div><div class='line'><span style="color: #24292F">&#125;</span></div><div class='line'></div><div class='line'><span style="color: #6E7781">// This model represents teams in the database</span></div><div class='line'><span style="color: #CF222E">model</span><span style="color: #24292F"> </span><span style="color: #953800">Team</span><span style="color: #24292F"> &#123;</span></div><div class='line'><span style="color: #24292F">	id </span><span style="color: #0550AE">String</span><span style="color: #24292F"> </span><span style="color: #8250DF">@id</span><span style="color: #24292F"> </span><span style="color: #8250DF">@unique</span></div><div class='line'><span style="color: #24292F">	name </span><span style="color: #0550AE">String</span></div><div class='line'><span style="color: #24292F">	created_date </span><span style="color: #0550AE">DateTime</span></div><div class='line'><span style="color: #24292F">	users </span><span style="color: #0550AE">TeamMember</span><span style="color: #CF222E">[]</span></div><div class='line'><span style="color: #24292F">&#125;</span></div><div class='line'></div><div class='line'><span style="color: #24292F">  </span></div><div class='line'><span style="color: #6E7781">// This model defines team membership - each row represents one user's membership in one team</span></div><div class='line'><span style="color: #CF222E">model</span><span style="color: #24292F"> </span><span style="color: #953800">TeamMember</span><span style="color: #24292F"> &#123;</span></div><div class='line'><span style="color: #24292F">	team_id </span><span style="color: #0550AE">String</span></div><div class='line'><span style="color: #24292F">	user_id </span><span style="color: #0550AE">String</span></div><div class='line'><span style="color: #24292F">	role </span><span style="color: #0550AE">Role</span></div><div class='line'><span style="color: #24292F">	joined </span><span style="color: #0550AE">DateTime</span><span style="color: #24292F"> </span><span style="color: #8250DF">@default</span><span style="color: #24292F">(</span><span style="color: #0550AE">now</span><span style="color: #24292F">())</span></div><div class='line'><span style="color: #24292F">	team </span><span style="color: #0550AE">Team</span><span style="color: #24292F"> </span><span style="color: #8250DF">@relation</span><span style="color: #24292F">(</span><span style="color: #953800">fields</span><span style="color: #24292F">: [</span><span style="color: #0550AE">team_id</span><span style="color: #24292F">], </span><span style="color: #953800">references</span><span style="color: #24292F">: [</span><span style="color: #0550AE">id</span><span style="color: #24292F">], </span><span style="color: #953800">onDelete</span><span style="color: #24292F">: </span><span style="color: #0550AE">Cascade</span><span style="color: #24292F">)</span></div><div class='line'><span style="color: #24292F">	user </span><span style="color: #0550AE">User</span><span style="color: #24292F"> </span><span style="color: #8250DF">@relation</span><span style="color: #24292F">(</span><span style="color: #953800">fields</span><span style="color: #24292F">: [</span><span style="color: #0550AE">user_id</span><span style="color: #24292F">], </span><span style="color: #953800">references</span><span style="color: #24292F">: [</span><span style="color: #0550AE">id</span><span style="color: #24292F">], </span><span style="color: #953800">onDelete</span><span style="color: #24292F">: </span><span style="color: #0550AE">Cascade</span><span style="color: #24292F">)</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #8250DF">@@id</span><span style="color: #24292F">([</span><span style="color: #0550AE">team_id</span><span style="color: #24292F">, </span><span style="color: #0550AE">user_id</span><span style="color: #24292F">])</span></div><div class='line'><span style="color: #24292F">&#125;</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-ntem2n">For simplicity I’m only using a <code>Role</code> enum to manage user permissions within a team. For more complex permission setups like <a href="https://support.discord.com/hc/en-us/articles/214836687-Role-Management-101" rel="nofollow">Discord’s role management system</a>, I’d recommend implementing a more advanced permission system like <a href="https://en.wikipedia.org/wiki/Role-based_access_control" rel="nofollow">Role-based access control</a>. RBAC is out of scope for this article, but if you’d like one from me in the future, let me know on <a href="https://twitter.com/AllanDeutsch" rel="nofollow">Twitter</a>. If it gets enough interest, I might do it.</p> <p data-svelte-h="svelte-171n2w">Now that the model is defined, we can:</p> <ol data-svelte-h="svelte-1ezl9wp"><li><code>npx prisma generate</code> to generate the type definitions we will be using</li> <li><code>npx prisma db push</code> to push these changes to the database</li></ol> <h2 id="implementing-team-support-in-the-database-model" data-svelte-h="svelte-1a68icg"><a aria-hidden="true" tabindex="-1" href="#implementing-team-support-in-the-database-model"><span class="icon icon-link"></span></a><a href="#implementing-team-support-in-the-database-model" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Implementing team support in the database model</h2> <p data-svelte-h="svelte-1ntzkp5">I care a lot about providing a great user experience - both to myself as a developer, and to users of the software I develop. I don’t want new users to start their experience using <a href="https://penguinsight.com/" rel="nofollow">Penguinsight</a> by signing up and then creating a team. I want to minimize the time it takes to get from 0 to the “aha” moment, so when they sign up I’m going to create a team for them.</p> <h3 id="requirements-for-user-and-team-creation" data-svelte-h="svelte-1s4v0r1"><a aria-hidden="true" tabindex="-1" href="#requirements-for-user-and-team-creation"><span class="icon icon-link"></span></a><a href="#requirements-for-user-and-team-creation" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Requirements for user and team creation</h3> <p data-svelte-h="svelte-183vic2">Creating a team and a user in the database simultaneously poses an additional challenge over doing them as separate operations. If creating one of them fails, both should fail. They need to be completed in a single ACID transaction.</p> <p data-svelte-h="svelte-1ueajyd">Since Lucia doesn’t support this, I’m going to have to define my own function for creating a user that meets my requirements. Those requirements are:</p> <ol data-svelte-h="svelte-15tt5b"><li>When a signing up a user, an <em>account and team</em> must be created</li> <li>Both need to succeed or fail completely - partial success is a full failure</li> <li>The results must still work with Lucia.</li> <li>On success, it should return the created <code>User</code> and <code>Team</code></li> <li>On failure, it should return the error information</li> <li>I want to use TypeScript to easily and safely determine whether it succeeded or failed and get the corresponding data</li></ol> <p data-svelte-h="svelte-wdhu5f">For now, I’m only supporting email &amp; password combos, so that’s what the function will take in as a parameter. Since database requests happen over a network, the most efficient way to write them is using async functions. Here’s the function signature for creating a user:</p> <!-- HTML_TAG_START --><pre class="shiki" style="background-color: #ffffff; color: #24292f" ts="true"><div class="language-id">ts</div><div class='code-container'><code><div class='line'><span style="color: #CF222E">export</span><span style="color: #24292F"> </span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #8250DF">createUser</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">async</span><span style="color: #24292F"> (</span><span style="color: #953800">userData</span><span style="color: #CF222E">:</span><span style="color: #24292F"> &#123;</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #953800">email</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #953800">password</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #24292F">&#125;) </span><span style="color: #CF222E">=&gt;</span><span style="color: #24292F"> &#123;</span></div><div class='line'><span style="color: #24292F">  </span><span style="color: #6E7781">// What goes here?</span></div><div class='line'><span style="color: #24292F">&#125;</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-b3oolo">Next I’m building the Prisma query for creating the user, team, and the relationship between them. To do this I used the prisma client and a couple utilities from Lucia for password hashing and creating a key.</p> <!-- HTML_TAG_START --><pre class="shiki" style="background-color: #ffffff; color: #24292f" ts="true"><div class="language-id">ts</div><div class='code-container'><code><div class='line'><span style="color: #CF222E">import</span><span style="color: #24292F"> &#123; prisma &#125; </span><span style="color: #CF222E">from</span><span style="color: #24292F"> </span><span style="color: #0A3069">'$lib/server/prisma'</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #CF222E">import</span><span style="color: #24292F"> &#123; generateLuciaPasswordHash &#125; </span><span style="color: #CF222E">from</span><span style="color: #24292F"> </span><span style="color: #0A3069">'lucia/utils'</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #CF222E">import</span><span style="color: #24292F"> &#123; createKeyId &#125; </span><span style="color: #CF222E">from</span><span style="color: #24292F"> </span><span style="color: #0A3069">'lucia'</span><span style="color: #24292F">;</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-sa7b3x">I create a single Prisma client to use across my backend in <code>&#39;$lib/server/prisma&#39;</code>, which is that first import. I’m using the slick   <a href="https://kit.svelte.dev/docs/server-only-modules#your-modules" rel="nofollow">server-only module feature of SvelteKit</a>. By putting my Prisma module in <code>$lib/server</code>, SvelteKit will not let me import it into client code. Nifty!</p> <h3 id="including-the-right-data" data-svelte-h="svelte-14vkinb"><a aria-hidden="true" tabindex="-1" href="#including-the-right-data"><span class="icon icon-link"></span></a><a href="#including-the-right-data" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Including the right data</h3> <p data-svelte-h="svelte-1s75687">Now let’s look at the Prisma query itself! I am making a query to create a <code>User</code> and inside it I’m nesting the insertion of a <code>Key</code>, <code>TeamMember</code>, <code>Team</code>. <a href="https://www.prisma.io/docs/reference/api-reference/prisma-client-reference#create" rel="nofollow">Prisma performs nested inserts as a transaction</a>, which means the inserts will all succeed or all fail.</p> <p data-svelte-h="svelte-1mv4nlg">I split it out into the constituent parts to make it a bit easier to discuss here. There are 3 parts:</p> <ol data-svelte-h="svelte-2ivfyw"><li>The <code>data</code> object contains the data I want to insert to the database</li> <li>the <code>include</code> argument tells Prisma what to include in the response, in addition to the inserted <code>User</code></li> <li>Perform the query</li></ol> <p data-svelte-h="svelte-du8hpw">This is based on the excellent Lucia documentation about <a href="https://lucia-auth.com/basics/fallback-database-queries/" rel="nofollow">falling back to database queries in Lucia</a>.</p> <!-- HTML_TAG_START --><pre class="shiki" style="background-color: #ffffff; color: #24292f" ts="true"><div class="language-id">ts</div><div class='code-container'><code><div class='line'><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">data</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> &#123;</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #6E7781">// to-do</span></div><div class='line'><span style="color: #24292F">&#125; satisfies Prisma.UserCreateArgs[</span><span style="color: #0A3069">'data'</span><span style="color: #24292F">];</span></div><div class='line'></div><div class='line'><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">include</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> &#123;</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #6E7781">// to-do</span></div><div class='line'><span style="color: #24292F">&#125; satisfies Prisma.UserCreateArgs[</span><span style="color: #0A3069">'include'</span><span style="color: #24292F">];</span></div><div class='line'></div><div class='line'><span style="color: #6E7781">// this performs the actual query</span></div><div class='line'><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">result</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">await</span><span style="color: #24292F"> prisma.user.</span><span style="color: #8250DF">create</span><span style="color: #24292F">(&#123;</span></div><div class='line'><span style="color: #24292F">	include,</span></div><div class='line'><span style="color: #24292F">	data</span></div><div class='line'><span style="color: #6E7781">// If you're curious about the shape of the query result, this is how to get it from prisma</span></div><div class='line'><span style="color: #6E7781">// see here: V</span></div><div class='line'><span style="color: #24292F">&#125;) satisfies Prisma.UserGetPayload</span><span style="color: #CF222E">&lt;</span><span style="color: #24292F">&#123;include: </span><span style="color: #CF222E">typeof</span><span style="color: #24292F"> include&#125;</span><span style="color: #CF222E">&gt;</span><span style="color: #24292F">;</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-1ugkl30">I’ve used <code>satisfies Prisma.&lt;something&gt;</code> in all of these to get better type safety and tooling support. Note that for <code>include</code> and <code>data</code> it’s important to use <code>satisfies</code> rather than a type annotation. This is because a type annotation will <em>widen</em> the value to the type of the annotation. In contrast, <code>satisfies</code> enforces the constraints of the specified type, but won’t widen the value into that type. This behavior is necessary for <code>Prisma.UserGetPayload&lt;&gt;</code> to provide the correct result type. You can learn more about the <code>satisfies</code> operator in the <a href="https://www.typescriptlang.org/docs/handbook/release-notes/typescript-4-9.html#the-satisfies-operator" rel="nofollow">Typescript 4.9 release announcement</a>.</p> <p data-svelte-h="svelte-1m2k7vv">Now that I have the structure of the query and result, lets look at the meat of the request, starting with include:</p> <!-- HTML_TAG_START --><pre class="shiki" style="background-color: #ffffff; color: #24292f" ts="true"><div class="language-id">ts</div><div class='code-container'><code><div class='line'><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">include</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> &#123;</span></div><div class='line'><span style="color: #24292F">	teams: &#123;</span></div><div class='line'><span style="color: #24292F">		include: &#123;</span></div><div class='line'><span style="color: #24292F">			team: </span><span style="color: #0550AE">true</span></div><div class='line'><span style="color: #24292F">		&#125;</span></div><div class='line'><span style="color: #24292F">	&#125;</span></div><div class='line'><span style="color: #24292F">&#125; satisfies Prisma.UserCreateArgs[</span><span style="color: #0A3069">'include'</span><span style="color: #24292F">];</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-xsqc6v">This include object might look a little convoluted. Think back to the data model; to support users being in multiple teams, I have 3 tables:</p> <ol data-svelte-h="svelte-r9uh3h"><li>User - the table with user properties</li> <li>Team - the table with team properties</li> <li>TeamMember - the table that defines relationships between users and teams</li></ol> <p data-svelte-h="svelte-mhfx4l">So the include statement above is telling Prisma what fields to give us in response. In addition to the basic fields of the <code>User</code> model, I’ve told it to include an array of <code>TeamMember</code>s and corresponding <code>team</code>s that the user is in. Because I’m inserting a new user and team here, I know that <code>teams</code> will be an array of exactly 1 team.</p> <h4 id="shape-of-a-user-type-that-includes-teams" data-svelte-h="svelte-17htipy"><a aria-hidden="true" tabindex="-1" href="#shape-of-a-user-type-that-includes-teams"><span class="icon icon-link"></span></a><a href="#shape-of-a-user-type-that-includes-teams" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Shape of a <code>User</code> type that includes teams</h4> <p data-svelte-h="svelte-jdps8c">The result will be of the following shape, which I’ve written out to provide annotations:</p> <!-- HTML_TAG_START --><pre class="shiki" style="background-color: #ffffff; color: #24292f" ts="true"><div class="language-id">ts</div><div class='code-container'><code><div class='line'><span style="color: #CF222E">type</span><span style="color: #24292F"> </span><span style="color: #953800">UserIncludingTeam</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> &#123;</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #6E7781">// The basic fields from the &#96;User&#96; model</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #953800">id</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #953800">email</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #953800">created_date</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Date</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #6E7781">// also include the &#96;TeamMember&#96; relation, called &#96;teams&#96;</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #953800">teams</span><span style="color: #CF222E">:</span><span style="color: #24292F"> &#123;</span></div><div class='line'><span style="color: #24292F">		</span><span style="color: #6E7781">// The basic fields from the &#96;TeamMember&#96; model</span></div><div class='line'><span style="color: #24292F">		</span><span style="color: #953800">team_id</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #24292F">		</span><span style="color: #953800">user_id</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #24292F">		</span><span style="color: #953800">role</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">$Enums</span><span style="color: #24292F">.</span><span style="color: #953800">Role</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #24292F">		</span><span style="color: #953800">joined</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Date</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #24292F">		</span><span style="color: #6E7781">// also include the &#96;Team&#96; relation, called &#96;team&#96;:</span></div><div class='line'><span style="color: #24292F">		</span><span style="color: #953800">team</span><span style="color: #CF222E">:</span><span style="color: #24292F"> &#123;</span></div><div class='line'><span style="color: #24292F">			</span><span style="color: #953800">id</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #24292F">			</span><span style="color: #953800">name</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #24292F">			</span><span style="color: #953800">created_date</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Date</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #24292F">		&#125;</span></div><div class='line'><span style="color: #24292F">	&#125;[]</span></div><div class='line'><span style="color: #24292F">&#125;</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-18inkye">Outside of an article, I prefer to use the <a href="https://www.prisma.io/docs/concepts/components/prisma-client/advanced-type-safety#type-utilities" rel="nofollow">Prisma utilities for advanced type safety</a>. They are generated based on the model definition, so are going to stay up-to-date when the model changes. An equivalent type can be produced by Prisma with a single line: <code>Prisma.UserGetPayload&lt;{include: typeof include}&gt;</code>. Much easier to write!</p> <h3 id="create-the-new-user-and-their-team" data-svelte-h="svelte-t5p31a"><a aria-hidden="true" tabindex="-1" href="#create-the-new-user-and-their-team"><span class="icon icon-link"></span></a><a href="#create-the-new-user-and-their-team" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Create the new user and their team</h3> <p data-svelte-h="svelte-1l1x545">Up next is the <code>data</code> object. This is how I specify what data should be used to create:</p> <ol data-svelte-h="svelte-1ounvow"><li>The user</li> <li>The <code>TeamMember</code> and corresponding <code>Team</code> that the user will be in</li> <li>A <code>Key</code> entry so the user can sign in with username and password</li></ol> <!-- HTML_TAG_START --><pre class="shiki" style="background-color: #ffffff; color: #24292f" ts="true"><div class="language-id">ts</div><div class='code-container'><code><div class='line'><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">data</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> &#123;</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #6E7781">// The basic user data</span></div><div class='line'><span style="color: #24292F">	created_date: </span><span style="color: #CF222E">new</span><span style="color: #24292F"> </span><span style="color: #0550AE">Date</span><span style="color: #24292F">(</span><span style="color: #0550AE">Date</span><span style="color: #24292F">.</span><span style="color: #8250DF">now</span><span style="color: #24292F">()),</span></div><div class='line'><span style="color: #24292F">	email,</span></div><div class='line'><span style="color: #24292F">	id: crypto.</span><span style="color: #8250DF">randomUUID</span><span style="color: #24292F">(), </span><span style="color: #6E7781">// available on most browsers and NodeJS</span></div><div class='line'><span style="color: #24292F">	teams: &#123;</span></div><div class='line'><span style="color: #24292F">		</span><span style="color: #6E7781">// This tells Prisma to create a TeamMember with a relation to the new user</span></div><div class='line'><span style="color: #24292F">		create: &#123;</span></div><div class='line'><span style="color: #24292F">			role: </span><span style="color: #0A3069">'admin'</span><span style="color: #24292F">,</span></div><div class='line'><span style="color: #24292F">			team: &#123;</span></div><div class='line'><span style="color: #24292F">				</span><span style="color: #6E7781">// This creates the new Team</span></div><div class='line'><span style="color: #24292F">				create: &#123;</span></div><div class='line'><span style="color: #24292F">					name: </span><span style="color: #0A3069">'My Team'</span><span style="color: #24292F">,</span></div><div class='line'><span style="color: #24292F">					created_date: </span><span style="color: #CF222E">new</span><span style="color: #24292F"> </span><span style="color: #0550AE">Date</span><span style="color: #24292F">(</span><span style="color: #0550AE">Date</span><span style="color: #24292F">.</span><span style="color: #8250DF">now</span><span style="color: #24292F">()),</span></div><div class='line'><span style="color: #24292F">					id: crypto.</span><span style="color: #8250DF">randomUUID</span><span style="color: #24292F">()</span></div><div class='line'><span style="color: #24292F">				&#125;</span></div><div class='line'><span style="color: #24292F">			&#125;</span></div><div class='line'><span style="color: #24292F">		&#125;</span></div><div class='line'><span style="color: #24292F">	&#125;,</span></div><div class='line'><span style="color: #24292F">	key: &#123;</span></div><div class='line'><span style="color: #24292F">		</span><span style="color: #6E7781">// I need to store a key so in the future the user can sign in </span></div><div class='line'><span style="color: #24292F">		create: &#123;</span></div><div class='line'><span style="color: #24292F">			</span><span style="color: #6E7781">// These functions are provided by Lucia-auth</span></div><div class='line'><span style="color: #24292F">			id: </span><span style="color: #8250DF">createKeyId</span><span style="color: #24292F">(</span><span style="color: #0A3069">'email'</span><span style="color: #24292F">, email.</span><span style="color: #8250DF">toLowerCase</span><span style="color: #24292F">()),</span></div><div class='line'><span style="color: #24292F">			hashed_password: </span><span style="color: #CF222E">await</span><span style="color: #24292F"> </span><span style="color: #8250DF">generateLuciaPasswordHash</span><span style="color: #24292F">(password)</span></div><div class='line'><span style="color: #24292F">		&#125;</span></div><div class='line'><span style="color: #24292F">	&#125;</span></div><div class='line'><span style="color: #6E7781">//V This also provides great intellisense support!</span></div><div class='line'><span style="color: #24292F">&#125; satisfies Prisma.UserCreateArgs[</span><span style="color: #0A3069">'data'</span><span style="color: #24292F">];</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-1826pb3">Finally I bring it all together and create the user and their new team. Whew!</p> <!-- HTML_TAG_START --><pre class="shiki" style="background-color: #ffffff; color: #24292f" ts="true"><div class="language-id">ts</div><div class='code-container'><code><div class='line'><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">queryResult</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">await</span><span style="color: #24292F"> prisma.user.</span><span style="color: #8250DF">create</span><span style="color: #24292F">(&#123;</span></div><div class='line'><span style="color: #24292F">	data,</span></div><div class='line'><span style="color: #24292F">	include</span></div><div class='line'><span style="color: #24292F">&#125;);</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-9ybhdk">Now that the bulk of my <code>createUser()</code> logic is done, I need to return the results!</p> <h3 id="structuring-and-returning-the-result-of-creating-a-user" data-svelte-h="svelte-1250swe"><a aria-hidden="true" tabindex="-1" href="#structuring-and-returning-the-result-of-creating-a-user"><span class="icon icon-link"></span></a><a href="#structuring-and-returning-the-result-of-creating-a-user" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Structuring and returning the result of creating a user</h3> <p data-svelte-h="svelte-u2zlce">To get my <code>User</code> and <code>Team</code> back from the sign-up transaction, I’ll use the types defined by prisma to build my result types. I’ve opted to use separate types to represent success and failure, and combine them into a <a href="https://www.typescriptlang.org/docs/handbook/2/everyday-types.html#union-types" rel="nofollow">union type</a> called <code>CreateUserResult</code>:</p> <!-- HTML_TAG_START --><pre class="shiki" style="background-color: #ffffff; color: #24292f" ts="true"><div class="language-id">ts</div><div class='code-container'><code><div class='line'><span style="color: #CF222E">import</span><span style="color: #24292F"> </span><span style="color: #CF222E">type</span><span style="color: #24292F"> &#123; Team, User &#125; </span><span style="color: #CF222E">from</span><span style="color: #24292F"> </span><span style="color: #0A3069">'@prisma/client'</span><span style="color: #24292F">;</span></div><div class='line'></div><div class='line'><span style="color: #CF222E">type</span><span style="color: #24292F"> </span><span style="color: #953800">CreateUserSuccess</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> &#123;</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #953800">success</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">true</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #953800">user</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">User</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #953800">team</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Team</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #24292F">&#125;;</span></div><div class='line'></div><div class='line'><span style="color: #CF222E">type</span><span style="color: #24292F"> </span><span style="color: #953800">CreateUserFailure</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> &#123;</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #953800">success</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">false</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #953800">error</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #953800">code</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F"> </span><span style="color: #CF222E">|</span><span style="color: #24292F"> </span><span style="color: #0550AE">undefined</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #24292F">&#125;;</span></div><div class='line'><span style="color: #CF222E">type</span><span style="color: #24292F"> </span><span style="color: #953800">CreateUserResult</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #953800">CreateUserSuccess</span><span style="color: #24292F"> </span><span style="color: #CF222E">|</span><span style="color: #24292F"> </span><span style="color: #953800">CreateUserFailure</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #CF222E">export</span><span style="color: #24292F"> </span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #8250DF">createUser</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">async</span><span style="color: #24292F"> (</span><span style="color: #953800">userData</span><span style="color: #CF222E">:</span><span style="color: #24292F"> &#123;</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #953800">email</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #953800">password</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #24292F">&#125;)</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Promise</span><span style="color: #24292F">&lt;</span><span style="color: #953800">CreateUserResult</span><span style="color: #24292F">&gt; </span><span style="color: #CF222E">=&gt;</span><span style="color: #24292F"> &#123;</span></div><div class='line'><span style="color: #6E7781">// ...</span></div><div class='line'><span style="color: #24292F">&#125;</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-r51z76">This uses a <em>TypeScript</em> technique called a <a href="https://www.typescriptlang.org/docs/handbook/2/narrowing.html#discriminated-unions" rel="nofollow">discriminated union</a>. Based on the value of <code>.success</code> in the <code>CreateUserResult</code> returned by <code>createUser()</code>, TypeScript can safely determine whether the object is a success or failure and expose the correct fields to me.</p> <p data-svelte-h="svelte-16jsvgt">The success case is fairly straightforward; grab the user and team from the <code>queryResult</code> and return a <code>CreateUserSuccess</code>:</p> <!-- HTML_TAG_START --><pre class="shiki" style="background-color: #ffffff; color: #24292f" ts="true"><div class="language-id">ts</div><div class='code-container'><code><div class='line'><span style="color: #CF222E">return</span><span style="color: #24292F"> &#123;</span></div><div class='line'><span style="color: #24292F">	success: </span><span style="color: #0550AE">true</span><span style="color: #24292F">, </span><span style="color: #6E7781">// client code can use this to discriminate the result is &#96;CreateUserSuccess&#96;</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #6E7781">// This will narrow the &#96;user&#96; down to the basic fields of email, created_date, and id.</span></div><div class='line'><span style="color: #24292F">	user: queryResult </span><span style="color: #CF222E">as</span><span style="color: #24292F"> </span><span style="color: #953800">Omit</span><span style="color: #24292F">&lt;</span><span style="color: #CF222E">typeof</span><span style="color: #24292F"> queryResult, </span><span style="color: #0A3069">'teams'</span><span style="color: #24292F">&gt;,</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #6E7781">// Since it's a newly inserted user, I know they are in exactly 1 team</span></div><div class='line'><span style="color: #24292F">	team: user.teams[</span><span style="color: #0550AE">0</span><span style="color: #24292F">].team</span></div><div class='line'><span style="color: #24292F">&#125; satisfies CreateUserSuccess; </span><span style="color: #6E7781">// this provides better intellisense support</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-1p0112e">The failure case occurs when something goes wrong with the Prisma query. When that happens, it will throw an error. We can catch it by wrapping the query in a try/catch block:</p> <!-- HTML_TAG_START --><pre class="shiki" style="background-color: #ffffff; color: #24292f" ts="true"><div class="language-id">ts</div><div class='code-container'><code><div class='line'><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">data</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> &#123;</span><span style="color: #CF222E">...</span><span style="color: #24292F">&#125;;</span></div><div class='line'><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">include</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> &#123;</span><span style="color: #CF222E">...</span><span style="color: #24292F">&#125;;</span></div><div class='line'><span style="color: #CF222E">try</span><span style="color: #24292F"> &#123;</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">queryResult</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">await</span><span style="color: #24292F"> prisma.user.</span><span style="color: #8250DF">create</span><span style="color: #24292F">(&#123;</span></div><div class='line'><span style="color: #24292F">		data,</span></div><div class='line'><span style="color: #24292F">		include</span></div><div class='line'><span style="color: #24292F">	&#125;);</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #CF222E">return</span><span style="color: #24292F"> &#123;</span><span style="color: #CF222E">...</span><span style="color: #24292F">&#125; satisfies CreateUserSuccess;</span></div><div class='line'><span style="color: #24292F">&#125; </span><span style="color: #CF222E">catch</span><span style="color: #24292F"> (e) &#123;</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #CF222E">if</span><span style="color: #24292F"> (e </span><span style="color: #CF222E">instanceof</span><span style="color: #24292F"> </span><span style="color: #953800">Prisma</span><span style="color: #24292F">.</span><span style="color: #953800">PrismaClientKnownRequestError</span><span style="color: #24292F"> </span><span style="color: #CF222E">&&</span></div><div class='line'><span style="color: #24292F">		e.code </span><span style="color: #CF222E">===</span><span style="color: #24292F"> </span><span style="color: #0A3069">'P2002'</span><span style="color: #24292F">)&#123;</span></div><div class='line'><span style="color: #24292F">		</span><span style="color: #CF222E">return</span><span style="color: #24292F"> &#123;</span></div><div class='line'><span style="color: #24292F">			success: </span><span style="color: #0550AE">false</span><span style="color: #24292F">,</span></div><div class='line'><span style="color: #24292F">			error: e.message,</span></div><div class='line'><span style="color: #24292F">			code: e.code</span></div><div class='line'><span style="color: #24292F">		&#125;</span></div><div class='line'><span style="color: #24292F">	&#125;</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #CF222E">return</span><span style="color: #24292F"> &#123;</span></div><div class='line'><span style="color: #24292F">		success: </span><span style="color: #0550AE">false</span><span style="color: #24292F">, </span></div><div class='line'><span style="color: #24292F">		error: </span><span style="color: #0A3069">'Unknown error occurred.'</span><span style="color: #24292F">, </span></div><div class='line'><span style="color: #24292F">		code: </span><span style="color: #0550AE">undefined</span></div><div class='line'><span style="color: #24292F">	&#125;</span></div><div class='line'><span style="color: #24292F">&#125;</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-ch7yj5">I’ve kept this error handling example brief. When building for production, I recommend handling the full list of <a href="https://www.prisma.io/docs/reference/api-reference/error-reference" rel="nofollow">Prisma errors</a>.</p> <h2 id="extending-lucia-types-to-include-teams" data-svelte-h="svelte-13hzvqv"><a aria-hidden="true" tabindex="-1" href="#extending-lucia-types-to-include-teams"><span class="icon icon-link"></span></a><a href="#extending-lucia-types-to-include-teams" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Extending Lucia types to include teams</h2> <p data-svelte-h="svelte-17wzsvl">Now that teams are supported in the database and get created alongside new users, I want to start using them in my SvelteKit endpoints and <a href="https://kit.svelte.dev/docs/load" rel="nofollow">load functions</a>. That’s how I will validate the user’s session and make sure they are <em>authorized</em> for whatever they are trying to do. This is important because I don’t want to let any user view or interact with data for teams they aren’t part of. Plus, some actions like adding or removing members from the team will require the user to be in the team and have elevated privileges. The <a href="https://lucia-auth.com/getting-started/sveltekit/#set-up-hooks" rel="nofollow">Lucia guide to SvelteKit setup</a> adds the Lucia <code>auth</code> object to <code>locals</code>, so it’s readily available for this.</p> <p data-svelte-h="svelte-1bes11d">Unfortunately, I’ve got a problem! Lucia doesn’t know about teams yet, so the <code>Session</code> object it gives me doesn’t contain team data:</p> <!-- HTML_TAG_START --><pre class="shiki" style="background-color: #ffffff; color: #24292f" ts="true"><div class="language-id">ts</div><div class='code-container'><code><div class='line'><span style="color: #CF222E">import</span><span style="color: #24292F"> </span><span style="color: #CF222E">type</span><span style="color: #24292F"> &#123; PageServerLoad &#125; </span><span style="color: #CF222E">from</span><span style="color: #24292F"> </span><span style="color: #0A3069">'./$types'</span><span style="color: #24292F">; </span><span style="color: #6E7781">// generated by SvelteKit</span></div><div class='line'><span style="color: #CF222E">import</span><span style="color: #24292F"> &#123; redirect &#125; </span><span style="color: #CF222E">from</span><span style="color: #24292F"> </span><span style="color: #0A3069">'@sveltejs/kit'</span><span style="color: #24292F">;</span></div><div class='line'></div><div class='line'><span style="color: #CF222E">export</span><span style="color: #24292F"> </span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #8250DF">load</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">PageServerLoad</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">async</span><span style="color: #24292F"> (&#123; </span><span style="color: #953800">locals</span><span style="color: #24292F">, </span><span style="color: #953800">params</span><span style="color: #24292F"> &#125;) </span><span style="color: #CF222E">=&gt;</span><span style="color: #24292F"> &#123;</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">session</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">await</span><span style="color: #24292F"> locals.auth.</span><span style="color: #8250DF">validate</span><span style="color: #24292F">(); </span><span style="color: #6E7781">// this</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #CF222E">if</span><span style="color: #24292F">(</span><span style="color: #0550AE">null</span><span style="color: #24292F"> </span><span style="color: #CF222E">===</span><span style="color: #24292F"> session) </span><span style="color: #CF222E">throw</span><span style="color: #24292F"> </span><span style="color: #8250DF">redirect</span><span style="color: #24292F">(</span><span style="color: #0550AE">302</span><span style="color: #24292F">, </span><span style="color: #0A3069">'/login'</span><span style="color: #24292F">);</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">user</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> session.user;</span></div><div class='line'></div><div class='line'><span style="color: #24292F">	</span><span style="color: #6E7781">// Now I want to check the user's teams, but it's not included in the session info!</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">teams</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> user.teams; </span><span style="color: #6E7781">// error!</span></div><div class='line'><span style="color: #24292F">&#125;</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-1qhrc72">Now that I’ve used Lucia to <em>authenticate</em> the user, I want to check their team data to make sure they are <em>authorized</em> to view this page. The most straightforward way to do this would be to use Prisma from here. I could use the value of <code>session.user.id</code> to get the teams the user is in from the database. The problem with that approach is it requires a second round-trip request to the database, which has several downsides:</p> <ol data-svelte-h="svelte-h5xm4r"><li>Higher serverless function execution time, which increases costs</li> <li>More database queries also increases costs</li> <li>Longer backend execution times means it takes longer for the page to load, degrading the user experience</li> <li>The increase in database load would reduce how many concurrent users can be supported</li></ol> <p data-svelte-h="svelte-9kxdi1">Overall not a great solution! Instead, I want Lucia to grab the team with the user and session info in a single query, rather than making 2 (or even 3!) queries out to the database. I also need to tell Lucia what my desired user type is so it can provide type safety. Fortunately, this is all supported out of the box; no hacks necessarily!</p> <h3 id="modifying-the-auth-user-type-to-include-team-information" data-svelte-h="svelte-b5t0yt"><a aria-hidden="true" tabindex="-1" href="#modifying-the-auth-user-type-to-include-team-information"><span class="icon icon-link"></span></a><a href="#modifying-the-auth-user-type-to-include-team-information" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Modifying the auth <code>User</code> type to include team information</h3> <p data-svelte-h="svelte-8h2us4">I found the easiest way to go about updating Lucia’s auth <code>User</code> type to include teams is to re-run the <a href="https://lucia-auth.com/starter-guides/" rel="nofollow">Lucia starter guide</a> for my framework (SvelteKit). It looks like these changes are really similar for other frameworks too.</p> <p data-svelte-h="svelte-1lu47lr">First, I need to update the <code>app.d.ts</code> file to extend Lucia’s <code>DatabaseUserAttributes</code> to include the team data I want. I used Prisma to generate the typing for me:</p> <!-- HTML_TAG_START --><pre class="shiki" style="background-color: #ffffff; color: #24292f" ts="true"><div class="language-id">ts</div><div class='code-container'><code><div class='line'><span style="color: #6E7781">// app.d.ts</span></div><div class='line'><span style="color: #CF222E">import</span><span style="color: #24292F"> </span><span style="color: #CF222E">type</span><span style="color: #24292F"> &#123; Prisma, User &#125; </span><span style="color: #CF222E">from</span><span style="color: #24292F"> </span><span style="color: #0A3069">'@prisma/client'</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #CF222E">declare</span><span style="color: #24292F"> global &#123;</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #CF222E">namespace</span><span style="color: #24292F"> </span><span style="color: #953800">Lucia</span><span style="color: #24292F"> &#123;</span></div><div class='line'><span style="color: #24292F">		</span><span style="color: #CF222E">type</span><span style="color: #24292F"> </span><span style="color: #953800">Auth</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">import</span><span style="color: #24292F">(</span><span style="color: #0A3069">'$lib/server/lucia'</span><span style="color: #24292F">).</span><span style="color: #953800">Auth</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #24292F">		</span><span style="color: #6E7781">// Lucia wants you to exclude the 'id' attribute, because it's required</span></div><div class='line'><span style="color: #24292F">		</span><span style="color: #CF222E">type</span><span style="color: #24292F"> </span><span style="color: #953800">DatabaseUserAttributes</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #953800">Omit</span><span style="color: #24292F">&lt;</span><span style="color: #953800">User</span><span style="color: #24292F">, </span><span style="color: #0A3069">'id'</span><span style="color: #24292F">&gt; </span><span style="color: #CF222E">&</span><span style="color: #24292F"> &#123;</span></div><div class='line'><span style="color: #24292F">			</span><span style="color: #953800">teams</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Prisma</span><span style="color: #24292F">.</span><span style="color: #953800">TeamMemberGetPayload</span><span style="color: #24292F">&lt;&#123;</span><span style="color: #953800">include</span><span style="color: #CF222E">:</span><span style="color: #24292F"> &#123;</span><span style="color: #953800">team</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">true</span><span style="color: #24292F">&#125;&#125;&gt;[];</span></div><div class='line'><span style="color: #24292F">		&#125;;</span></div><div class='line'><span style="color: #24292F">		</span><span style="color: #CF222E">type</span><span style="color: #24292F"> </span><span style="color: #953800">DatabaseSessionAttributes</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> &#123;&#125;;</span></div><div class='line'><span style="color: #24292F">	&#125;</span></div><div class='line'><span style="color: #24292F">&#125;</span></div><div class='line'><span style="color: #6E7781">// THIS IS IMPORTANT (according to the Lucia docs)</span></div><div class='line'><span style="color: #CF222E">export</span><span style="color: #24292F"> &#123;&#125;</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-76z4wk">Two things of note here:</p> <ol data-svelte-h="svelte-uur5x1"><li>I used <code>Omit&lt;&gt;</code> to remove the <code>id</code> attribute from the <code>User</code> type Prisma generated from my data model because Lucia already knows that users have an <code>id</code>.</li> <li>The type of <code>Lucia.DatabaseUserAttributes.teams</code> is the result of getting a <code>TeamMember</code> entry (which defines the relation between a user and team) and including the <code>Team</code> with it. I made this an array by appending <code>[]</code> because a user can be in multiple teams.</li></ol> <h3 id="plumbing-the-team-data-into-lucia" data-svelte-h="svelte-naqrj9"><a aria-hidden="true" tabindex="-1" href="#plumbing-the-team-data-into-lucia"><span class="icon icon-link"></span></a><a href="#plumbing-the-team-data-into-lucia" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Plumbing the team data into Lucia</h3> <p data-svelte-h="svelte-13a86nr">By default, <a href="https://lucia-auth.com/database-adapters/prisma/" rel="nofollow">Lucia’s Prisma adapter</a> works great. Unfortunately, it doesn’t know how to perform the slightly more complex join query to get the team data I want with my users. Fortunately, there’s a great (experimental as of this writing) solution to this problem: <code>joinAdapters()</code>.</p> <p data-svelte-h="svelte-dxlpij">The default adapter works for everything I need <em>except</em> getting users. To fix that I use <code>joinAdapters()</code> to partially extend the default Prisma adapter. The change takes place in the <a href="https://lucia-auth.com/guidebook/sign-in-with-username-and-password/sveltekit/#configure-lucia" rel="nofollow">Lucia config</a> that I defined in <code>$lib/server/lucia.ts</code>. As an optimization, <a href="https://github.com/lucia-auth/lucia/blob/f4ce8ffbdf40e64d9c1475c6f0ef98cfcd709d3a/packages/lucia/src/auth/index.ts#L205" rel="nofollow"><code>Lucia</code> will try to use the provided adapter’s <code>getSessionAndUser()</code></a> to get both in a single query. If it’s not present, it will fall back to <code>getUser()</code>. To get the best performance in all cases, I override both.</p> <h4 id="writing-custom-getuser-and-getsessionanduser-functions" data-svelte-h="svelte-195zyb1"><a aria-hidden="true" tabindex="-1" href="#writing-custom-getuser-and-getsessionanduser-functions"><span class="icon icon-link"></span></a><a href="#writing-custom-getuser-and-getsessionanduser-functions" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Writing custom <code>getUser()</code> and <code>getSessionAndUser()</code> functions</h4> <p data-svelte-h="svelte-6gftyt">I started with <code>getUser()</code> because it’s simpler. I imported Lucia’s <code>Adapter</code> type to defines the function signature for <code>getUser()</code> and my Prisma client instance to perform the query within. Here’s how that all comes together:</p> <!-- HTML_TAG_START --><pre class="shiki" style="background-color: #ffffff; color: #24292f" ts="true"><div class="language-id">ts</div><div class='code-container'><code><div class='line'><span style="color: #6E7781">// $lib/server/lucia.ts</span></div><div class='line'><span style="color: #CF222E">import</span><span style="color: #24292F"> </span><span style="color: #CF222E">type</span><span style="color: #24292F"> &#123; Prisma &#125; </span><span style="color: #CF222E">from</span><span style="color: #24292F"> </span><span style="color: #0A3069">'@prisma/client'</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #CF222E">import</span><span style="color: #24292F"> </span><span style="color: #CF222E">type</span><span style="color: #24292F"> &#123; Adapter &#125; </span><span style="color: #CF222E">from</span><span style="color: #24292F"> </span><span style="color: #0A3069">'lucia'</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #CF222E">import</span><span style="color: #24292F"> &#123; prisma &#125; </span><span style="color: #CF222E">from</span><span style="color: #24292F"> </span><span style="color: #0A3069">'$lib/server/prisma'</span><span style="color: #24292F">;</span></div><div class='line'></div><div class='line'><span style="color: #6E7781">// override the default getUser method on the prisma adapter to include the user's teams</span></div><div class='line'><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">getUser</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> (</span><span style="color: #CF222E">async</span><span style="color: #24292F"> (</span><span style="color: #953800">userId</span><span style="color: #24292F">) </span><span style="color: #CF222E">=&gt;</span><span style="color: #24292F"> &#123;</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">user</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">await</span><span style="color: #24292F"> prisma.user.</span><span style="color: #8250DF">findUnique</span><span style="color: #24292F">(&#123;</span></div><div class='line'><span style="color: #24292F">		select: &#123;</span></div><div class='line'><span style="color: #24292F">			teams: &#123; include: &#123; team: </span><span style="color: #0550AE">true</span><span style="color: #24292F"> &#125; &#125;,</span></div><div class='line'><span style="color: #24292F">			id: </span><span style="color: #0550AE">true</span><span style="color: #24292F">,</span></div><div class='line'><span style="color: #24292F">			email: </span><span style="color: #0550AE">true</span><span style="color: #24292F">,</span></div><div class='line'><span style="color: #24292F">			created_date: </span><span style="color: #0550AE">true</span></div><div class='line'><span style="color: #24292F">		&#125;,</span></div><div class='line'><span style="color: #24292F">		</span><span style="color: #6E7781">// The specific user to grab</span></div><div class='line'><span style="color: #24292F">		where: &#123; id: userId &#125;</span></div><div class='line'><span style="color: #24292F">	&#125;);</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #CF222E">return</span><span style="color: #24292F"> user;</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #6E7781">// This gives me type checking and better intellisense</span></div><div class='line'><span style="color: #24292F">&#125;) satisfies Adapter[</span><span style="color: #0A3069">'getUser'</span><span style="color: #24292F">];</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-1sbg726">Note that the value being assigned to <code>getUser</code> is wrapped in parentheses. This is so I can use the <code>satisfies</code> operator to provide a type constraint.</p> <p data-svelte-h="svelte-vnuoh7">Continuing on in the file I made <code>getSessionAndUser()</code>. This one is a little more complicated because the result needs to be a 2 element array: <code>[session, user]</code>. I ran into a couple gotchas here:</p> <ol data-svelte-h="svelte-hzjqf2"><li>If the session doesn’t exist, <code>getSessionAndUser()</code> should return <code>[null, null]</code></li> <li><a href="https://lucia-auth.com/database-adapters/prisma/#prisma-schema" rel="nofollow">Lucia’s models the Session’s <code>active_expires</code> and <code>idle_expires</code> as <code>BigInt</code>s</a>. I had to <a href="https://discord.com/channels/1004048134218981416/1164693156730773567/1164693156730773567" rel="nofollow">convert them to <code>number</code>s</a></li></ol> <!-- HTML_TAG_START --><pre class="shiki" style="background-color: #ffffff; color: #24292f" ts="true"><div class="language-id">ts</div><div class='code-container'><code><div class='line'><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">getSessionAndUser</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> (</span><span style="color: #CF222E">async</span><span style="color: #24292F"> (</span><span style="color: #953800">sessionId</span><span style="color: #24292F">) </span><span style="color: #CF222E">=&gt;</span><span style="color: #24292F"> &#123;</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">session</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">await</span><span style="color: #24292F"> prisma.session.</span><span style="color: #8250DF">findUnique</span><span style="color: #24292F">(&#123;</span></div><div class='line'><span style="color: #24292F">		where: &#123; id: sessionId &#125;,</span></div><div class='line'><span style="color: #24292F">		include: &#123; user: &#123; include: &#123; teams: &#123; include: &#123; team: </span><span style="color: #0550AE">true</span><span style="color: #24292F"> &#125; &#125; &#125; &#125; &#125;</span></div><div class='line'><span style="color: #24292F">	&#125;);</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #CF222E">if</span><span style="color: #24292F"> (</span><span style="color: #0550AE">null</span><span style="color: #24292F"> </span><span style="color: #CF222E">===</span><span style="color: #24292F"> session) </span><span style="color: #CF222E">return</span><span style="color: #24292F"> [</span><span style="color: #0550AE">null</span><span style="color: #24292F">, </span><span style="color: #0550AE">null</span><span style="color: #24292F">];</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #CF222E">return</span><span style="color: #24292F"> [</span></div><div class='line'><span style="color: #24292F">		&#123;</span></div><div class='line'><span style="color: #24292F">			</span><span style="color: #CF222E">...</span><span style="color: #24292F">session,</span></div><div class='line'><span style="color: #24292F">			active_expires: </span><span style="color: #0550AE">Number</span><span style="color: #24292F">(session.active_expires),</span></div><div class='line'><span style="color: #24292F">			idle_expires: </span><span style="color: #0550AE">Number</span><span style="color: #24292F">(session.idle_expires)</span></div><div class='line'><span style="color: #24292F">		&#125;,</span></div><div class='line'><span style="color: #24292F">		session.user</span></div><div class='line'><span style="color: #24292F">	];</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #6E7781">// Again, this is for better type checking & intellisense support</span></div><div class='line'><span style="color: #24292F">&#125;) satisfies Adapter[</span><span style="color: #0A3069">'getSessionAndUser'</span><span style="color: #24292F">];</span></div></code></div></pre><!-- HTML_TAG_END --> <h4 id="tying-it-all-together-in-the-lucia-config" data-svelte-h="svelte-8r7c0z"><a aria-hidden="true" tabindex="-1" href="#tying-it-all-together-in-the-lucia-config"><span class="icon icon-link"></span></a><a href="#tying-it-all-together-in-the-lucia-config" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Tying it all together in the Lucia config</h4> <p data-svelte-h="svelte-1cqaggm">With the two overrides written, all that remains is to bring it all together in the Lucia config!</p> <p data-svelte-h="svelte-6ocsoj">To do this, I used the (currently experimental) <code>joinAdapters()</code> utility that Lucia provides. It’s pretty straightforward:</p> <ol data-svelte-h="svelte-1vuonsc"><li>Pass it the first adapter to use</li> <li>Pass an object with the Adapter methods to override</li></ol> <p data-svelte-h="svelte-1h9a37g">Tying it all together, I have the following Lucia config:</p> <!-- HTML_TAG_START --><pre class="shiki" style="background-color: #ffffff; color: #24292f" ts="true"><div class="language-id">ts</div><div class='code-container'><code><div class='line'><span style="color: #CF222E">import</span><span style="color: #24292F"> &#123; lucia, </span><span style="color: #CF222E">type</span><span style="color: #24292F"> Adapter &#125; </span><span style="color: #CF222E">from</span><span style="color: #24292F"> </span><span style="color: #0A3069">'lucia'</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #CF222E">import</span><span style="color: #24292F"> &#123; sveltekit &#125; </span><span style="color: #CF222E">from</span><span style="color: #24292F"> </span><span style="color: #0A3069">'lucia/middleware'</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #CF222E">import</span><span style="color: #24292F"> &#123; dev &#125; </span><span style="color: #CF222E">from</span><span style="color: #24292F"> </span><span style="color: #0A3069">'$app/environment'</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #CF222E">import</span><span style="color: #24292F"> &#123; prisma </span><span style="color: #CF222E">as</span><span style="color: #24292F"> PrismaAdapter &#125; </span><span style="color: #CF222E">from</span><span style="color: #24292F"> </span><span style="color: #0A3069">'@lucia-auth/adapter-prisma'</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #CF222E">import</span><span style="color: #24292F"> &#123; prisma &#125; </span><span style="color: #CF222E">from</span><span style="color: #24292F"> </span><span style="color: #0A3069">'$lib/server/prisma'</span><span style="color: #24292F">;</span></div><div class='line'><span style="color: #CF222E">import</span><span style="color: #24292F"> &#123; __experimental_joinAdapters </span><span style="color: #CF222E">as</span><span style="color: #24292F"> joinAdapters &#125; </span><span style="color: #CF222E">from</span><span style="color: #24292F"> </span><span style="color: #0A3069">'lucia/utils'</span><span style="color: #24292F">;</span></div><div class='line'></div><div class='line'><span style="color: #6E7781">// truncated for brevity</span></div><div class='line'><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">getUser</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> (</span><span style="color: #CF222E">...</span><span style="color: #24292F">) satisfies Adapter[</span><span style="color: #0A3069">'getUser'</span><span style="color: #24292F">];</span></div><div class='line'><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">getSessionAndUser</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> (</span><span style="color: #CF222E">...</span><span style="color: #24292F">) satisfies Adapter[</span><span style="color: #0A3069">'getSessionAndUser'</span><span style="color: #24292F">];</span></div><div class='line'></div><div class='line'><span style="color: #6E7781">// The Lucia config</span></div><div class='line'><span style="color: #CF222E">export</span><span style="color: #24292F"> </span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">auth</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #8250DF">lucia</span><span style="color: #24292F">(&#123;</span></div><div class='line'><span style="color: #24292F">	env: dev </span><span style="color: #CF222E">?</span><span style="color: #24292F"> </span><span style="color: #0A3069">'DEV'</span><span style="color: #24292F"> </span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0A3069">'PROD'</span><span style="color: #24292F">,</span></div><div class='line'><span style="color: #24292F">	middleware: </span><span style="color: #8250DF">sveltekit</span><span style="color: #24292F">(),</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #6E7781">// joinAdapters makes it possible to override parts of the default &#96;PrismaAdapter&#96;</span></div><div class='line'><span style="color: #24292F">	adapter: </span><span style="color: #8250DF">joinAdapters</span><span style="color: #24292F">(</span></div><div class='line'><span style="color: #24292F">		</span><span style="color: #8250DF">PrismaAdapter</span><span style="color: #24292F">(prisma, &#123;</span></div><div class='line'><span style="color: #24292F">			user: </span><span style="color: #0A3069">'user'</span><span style="color: #24292F">,</span></div><div class='line'><span style="color: #24292F">			key: </span><span style="color: #0A3069">'key'</span><span style="color: #24292F">,</span></div><div class='line'><span style="color: #24292F">			session: </span><span style="color: #0A3069">'session'</span></div><div class='line'><span style="color: #24292F">		&#125;),</span></div><div class='line'><span style="color: #24292F">		</span><span style="color: #6E7781">// This "adapter" object has the overrides to get teams with the user</span></div><div class='line'><span style="color: #24292F">		&#123; getUser, getSessionAndUser &#125;</span></div><div class='line'><span style="color: #24292F">	),</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #8250DF">getUserAttributes</span><span style="color: #24292F">: (</span><span style="color: #953800">user</span><span style="color: #24292F"> </span><span style="color: #6E7781">/*: UserSchema*/</span><span style="color: #24292F">) </span><span style="color: #CF222E">=&gt;</span><span style="color: #24292F"> &#123;</span></div><div class='line'><span style="color: #24292F">		</span><span style="color: #6E7781">// &#96;UserSchema&#96; pulls in the &#96;teams&#96; field I added in app.d.ts</span></div><div class='line'><span style="color: #24292F">		</span><span style="color: #CF222E">return</span><span style="color: #24292F"> user;</span></div><div class='line'><span style="color: #24292F">	&#125;</span></div><div class='line'><span style="color: #24292F">&#125;);</span></div><div class='line'><span style="color: #CF222E">export</span><span style="color: #24292F"> </span><span style="color: #CF222E">type</span><span style="color: #24292F"> </span><span style="color: #953800">Auth</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">typeof</span><span style="color: #24292F"> auth;</span></div></code></div></pre><!-- HTML_TAG_END --> <h3 id="accessing-the-users-team-data-provided-by-lucia" data-svelte-h="svelte-14a17q4"><a aria-hidden="true" tabindex="-1" href="#accessing-the-users-team-data-provided-by-lucia"><span class="icon icon-link"></span></a><a href="#accessing-the-users-team-data-provided-by-lucia" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Accessing the user’s team data provided by Lucia</h3> <p data-svelte-h="svelte-4vewjo">Now that Lucia knows how to get the team data, I can access it easily via <code>(await locals.auth.validate()).user.teams</code> in my SvelteKit page load functions and server endpoints. Going back to the code example from the start of this section on extending Lucia types to include teams, it now works the way I wanted! Check it out:</p> <!-- HTML_TAG_START --><pre class="shiki" style="background-color: #ffffff; color: #24292f" ts="true"><div class="language-id">ts</div><div class='code-container'><code><div class='line'><span style="color: #6E7781">// routes/[teamId]/+page.server.ts</span></div><div class='line'><span style="color: #CF222E">import</span><span style="color: #24292F"> </span><span style="color: #CF222E">type</span><span style="color: #24292F"> &#123; PageServerLoad &#125; </span><span style="color: #CF222E">from</span><span style="color: #24292F"> </span><span style="color: #0A3069">'./$types'</span><span style="color: #24292F">; </span><span style="color: #6E7781">// generated by SvelteKit</span></div><div class='line'><span style="color: #CF222E">import</span><span style="color: #24292F"> &#123; redirect &#125; </span><span style="color: #CF222E">from</span><span style="color: #24292F"> </span><span style="color: #0A3069">'@sveltejs/kit'</span><span style="color: #24292F">;</span></div><div class='line'></div><div class='line'><span style="color: #CF222E">export</span><span style="color: #24292F"> </span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #8250DF">load</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">PageServerLoad</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">async</span><span style="color: #24292F"> (&#123; </span><span style="color: #953800">locals</span><span style="color: #24292F">, </span><span style="color: #953800">params</span><span style="color: #24292F"> &#125;) </span><span style="color: #CF222E">=&gt;</span><span style="color: #24292F"> &#123;</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">session</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">await</span><span style="color: #24292F"> locals.auth.</span><span style="color: #8250DF">validate</span><span style="color: #24292F">(); </span><span style="color: #6E7781">// this</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #CF222E">if</span><span style="color: #24292F">(</span><span style="color: #0550AE">null</span><span style="color: #24292F"> </span><span style="color: #CF222E">===</span><span style="color: #24292F"> session) </span><span style="color: #CF222E">throw</span><span style="color: #24292F"> </span><span style="color: #8250DF">redirect</span><span style="color: #24292F">(</span><span style="color: #0550AE">302</span><span style="color: #24292F">, </span><span style="color: #0A3069">'/login'</span><span style="color: #24292F">);</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">user</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> session.user;</span></div><div class='line'></div><div class='line'><span style="color: #24292F">	</span><span style="color: #6E7781">// Now the user's teams are included in the session info!</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">teams</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> user.teams; </span><span style="color: #6E7781">// works now!</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #CF222E">if</span><span style="color: #24292F"> (teams.</span><span style="color: #8250DF">find</span><span style="color: #24292F">(</span><span style="color: #953800">team</span><span style="color: #24292F"> </span><span style="color: #CF222E">=&gt;</span><span style="color: #24292F"> team.id </span><span style="color: #CF222E">===</span><span style="color: #24292F"> params.teamId) </span><span style="color: #CF222E">===</span><span style="color: #24292F"> </span><span style="color: #0550AE">undefined</span><span style="color: #24292F">)&#123;</span></div><div class='line'><span style="color: #24292F">		</span><span style="color: #6E7781">// unauthorized</span></div><div class='line'><span style="color: #24292F">	&#125;</span></div><div class='line'><span style="color: #24292F">	</span><span style="color: #6E7781">// The user is supposed to be here!</span></div><div class='line'><span style="color: #24292F">&#125;</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-1xbw4kv">Now when I use Lucia to authenticate user sessions, I also get the data I need to make sure the user is authorized. Awesome!</p> <h2 id="conclusion" data-svelte-h="svelte-19f5w1q"><a aria-hidden="true" tabindex="-1" href="#conclusion"><span class="icon icon-link"></span></a><a href="#conclusion" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Conclusion</h2> <p data-svelte-h="svelte-1pl11sg">I hope this is helpful to you in adding support for teams (or anything else!) to your SaaS!</p> <p data-svelte-h="svelte-tiex6i">This article was a lot of fun to write, and I ended up learning and improving my code a lot in the process. I have really enjoyed building with Lucia, SvelteKit, and Prisma. With any luck, this article has helped you get excited to go build something with them too!</p> <div class="divider"></div> <aside class="prose"><h2 class="prose-h2:text-lg" data-svelte-h="svelte-128y7pj">Feedback</h2> <p data-svelte-h="svelte-171xzz7">Thanks for reading this, I hope it has helped you in some way. I&#39;d love it
			if you would share your feedback with my by using one of the buttons
			below. It only takes a second, and whether you love it or hate it, the
			feedback helps me write better content in the future!</p> <pi-thumb user="(anonymous)" path="notes/customer-teams-lucia" team="d6101342-650f-443e-893a-0bcb31bd8da9"></pi-thumb> <p data-svelte-h="svelte-s9yh0w">If you&#39;re feeling extra generous, you can show your support by buying me a
			coffee with the button in the bottom right corner of the page.</p> <div class="divider"></div></aside></article>     <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css" integrity="sha384-KiWOvVjnN8qwAZbuQyWDIbfCLFhLXNETzBQjA/92pIowpC0d2O3nppDGQVgwd2nB" crossorigin="anonymous"></div>  
			
			<script>
				{
					__sveltekit_1w3anx2 = {
						base: new URL("../..", location).pathname.slice(0, -1),
						env: {"PUBLIC_SUPABASE_ANON_KEY":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFlb3ZmZXRyaXNyZnFpZWF0bXp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE2ODcwNjM0NTYsImV4cCI6MjAwMjYzOTQ1Nn0.s9KXOQ0gDdl7e3lTUxdN5yfPI0rLZ-dSRMfEwoHhK00","PUBLIC_SUPABASE_URL":"https://aeovfetrisrfqieatmzw.supabase.co"}
					};

					const element = document.currentScript.parentElement;

					const data = [{"type":"data","data":{session:null,user:null},"uses":{}},null];

					Promise.all([
						import("../../_app/immutable/entry/start.4f4ab6fe.js"),
						import("../../_app/immutable/entry/app.af9bb739.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 13],
							data,
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
